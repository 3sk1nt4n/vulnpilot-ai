stages:
  - lint
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POSTGRES_DB: vulnpilot_test
  POSTGRES_USER: vulnpilot
  POSTGRES_PASSWORD: vulnpilot

cache:
  paths:
    - .cache/pip
    - .venv/

# -----------------------------------------------------------
# LINT
# -----------------------------------------------------------

lint:python:
  stage: lint
  image: python:3.12-slim
  script:
    - pip install ruff --quiet
    - ruff check backend/vulnpilot/ --select E,F,W --ignore E501
  allow_failure: true

lint:syntax:
  stage: lint
  image: python:3.12-slim
  script:
    - find backend/ -name "*.py" -exec python -c "
      import ast, sys;
      try:
        ast.parse(open(sys.argv[1]).read());
      except SyntaxError as e:
        print(f'FAIL {sys.argv[1]}: {e}'); sys.exit(1)
      " {} \;
  allow_failure: false

# -----------------------------------------------------------
# TEST
# -----------------------------------------------------------

test:unit:
  stage: test
  image: python:3.12-slim
  services:
    - postgres:16-alpine
    - redis:7-alpine
  variables:
    DATABASE_URL: "postgresql://vulnpilot:vulnpilot@postgres:5432/vulnpilot_test"
    REDIS_URL: "redis://redis:6379/0"
    AUTH_ENABLED: "false"
    LLM_PROVIDER: "ollama"
    CLOUD_DEMO_MODE: "true"
  before_script:
    - cd backend
    - pip install -r requirements.txt --quiet --break-system-packages
    - pip install pytest pytest-asyncio --quiet --break-system-packages
  script:
    - cd ..
    - python -m pytest tests/test_vprs.py -v
    - python -m pytest tests/test_cloud.py -v

# -----------------------------------------------------------
# BUILD
# -----------------------------------------------------------

build:docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - docker build -t vulnpilot-backend:$CI_COMMIT_SHORT_SHA backend/
    - docker tag vulnpilot-backend:$CI_COMMIT_SHORT_SHA vulnpilot-backend:latest
  only:
    - main
    - tags

# -----------------------------------------------------------
# DEPLOY (manual)
# -----------------------------------------------------------

deploy:staging:
  stage: deploy
  script:
    - echo "Deploy to staging environment"
    - echo "docker compose -f docker-compose.yml -f docker-compose.staging.yml up -d"
  environment:
    name: staging
    url: https://staging.vulnpilot.solventcyber.com
  when: manual
  only:
    - main

deploy:production:
  stage: deploy
  script:
    - echo "Deploy to production environment"
    - echo "docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d"
  environment:
    name: production
    url: https://vulnpilot.solventcyber.com
  when: manual
  only:
    - tags
