<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VulnPilot AI - Agentic Vulnerability Management</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;0,9..40,900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#ffffff; --bg-card:#ffffff; --bg-panel:#f8f9fc; --border:#e2e8f0;
  --text:#0f172a; --text2:#334155; --muted:#64748b;
  --orange:#ea580c; --amber:#f59e0b; --cyan:#0f766e; --blue:#3b82f6;
  --crit:#ef4444; --high:#ea580c; --med:#eab308; --low:#16a34a; --info:#64748b;
  --pw:300px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',system-ui,sans-serif;font-size:15px;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:3px}

.app{display:flex;min-height:100vh}
.lp{width:var(--pw);background:#f0fdfa;border-right:1px solid #d1d5db;position:fixed;top:0;left:0;height:100vh;overflow-y:auto;z-index:50}
.rp{width:var(--pw);background:#f0fdfa;border-left:1px solid #d1d5db;position:fixed;top:0;right:0;height:100vh;overflow-y:auto;z-index:50;display:flex;flex-direction:column}
.mc{margin-left:var(--pw);margin-right:var(--pw);flex:1;display:flex;flex-direction:column;min-height:100vh}

.ph{padding:20px 18px 14px;border-bottom:1px solid #d1d5db}
.pt{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:#ea580c}
.ps{padding:18px 18px;border-bottom:1px solid #d1d5db}
.pst{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:#64748b;margin-bottom:12px}
.ii{display:flex;align-items:center;gap:10px;padding:8px 0;font-size:15px;color:#334155}
.ii:hover{color:#0f172a}
.dot{width:9px;height:9px;border-radius:50%;flex-shrink:0;transition:all .3s}
.dot.on{background:#16a34a;box-shadow:0 0 6px rgba(22,163,74,0.4)}
.dot.off{background:#cbd5e1}
.prov-dot{width:8px;height:8px;border-radius:50%;display:inline-block;transition:all .3s}
.prov-dot.on{background:#16a34a;box-shadow:0 0 6px rgba(22,163,74,0.4)}
.prov-dot.off{background:#cbd5e1}
.dot.wait{background:#eab308;box-shadow:0 0 6px rgba(234,179,8,0.3)}
.in{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#334155;font-weight:500}
.ib{font-size:10px;padding:3px 8px;border-radius:4px;font-weight:700;text-transform:uppercase}
.ib.open{background:#f0fdf4;color:#16a34a}
.ib.lab{background:#fffbeb;color:#b45309}
.ib.oss{background:#eff6ff;color:#1e40af}
.ib.key{background:#f5f3ff;color:#7c3aed}

/* TOP BAR */
.tb{background:var(--bg);border-bottom:1px solid var(--border);padding:22px 28px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:16px;cursor:pointer;text-decoration:none}
.brand:hover .bi{transform:scale(1.05)}
.bi{width:64px;height:64px;display:flex;align-items:center;justify-content:center;transition:transform .2s}
.brand h1{font-family:'DM Sans',sans-serif;font-size:26px;font-weight:800;color:var(--text);letter-spacing:-0.3px;line-height:1.2}
.brand p{font-size:13px;color:var(--muted);letter-spacing:1px;margin-top:4px;text-transform:uppercase}
.tr{display:flex;align-items:center;gap:12px}
.sp{display:flex;align-items:center;gap:6px;background:var(--bg-panel);border:1px solid var(--border);border-radius:16px;padding:6px 14px;font-size:12px}
.sd{width:8px;height:8px;border-radius:50%;background:#16a34a;box-shadow:0 0 6px rgba(22,163,74,0.4)}
.mb{background:#fff7ed;color:var(--orange);font-size:10px;font-weight:700;padding:3px 10px;border-radius:10px;border:1px solid #fed7aa}
.btn-s{background:var(--bg);border:1px solid var(--border);color:var(--muted);font-size:12px;padding:7px 16px;border-radius:7px;cursor:pointer}
.btn-s:hover{border-color:var(--orange);color:var(--orange)}

/* STATS */
.sr{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:12px;margin-bottom:20px;background:linear-gradient(135deg,#fed7aa,#fdba74);border:1px solid #f97316;border-radius:14px;box-shadow:0 2px 8px rgba(234,88,12,0.1)}
.sc{background:#ffffff;border:1px solid #d1d5db;border-radius:10px;padding:10px 12px;transition:all .2s;overflow:hidden}
.sc:hover{border-color:#f97316;transform:translateY(-1px)}
.sl{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#64748b;margin-bottom:2px}
.sv{font-family:'JetBrains Mono',monospace;font-size:32px;font-weight:800;line-height:1.1}
.ss{font-size:12px;color:#64748b;margin-top:4px;font-weight:500}
.sv.cr{color:var(--crit)}.sv.or{color:var(--orange)}.sv.cy{color:var(--cyan)}.sv.gr{color:#16a34a}.sv.bl{color:var(--blue)}

/* AI BAR */
.ai-section{margin:0 24px 16px;position:relative}
.ai-bar{background:linear-gradient(135deg,#fed7aa,#fdba74);border:1px solid #f97316;border-radius:14px;padding:16px 20px;position:relative;overflow:hidden;transition:border-radius .2s}
.ai-bar.resp-open{border-radius:14px 14px 0 0;border-bottom:none}
.ai-bar::before{content:none}
.ai-bar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--orange),var(--amber),transparent);opacity:0.4;transition:opacity .2s}
.ai-bar.resp-open::after{opacity:0}
.ai-t{font-size:13px;font-weight:700;color:#9a3412;display:flex;align-items:center;gap:6px}
.ai-t::before{content:'‚ö°';font-size:12px}
.ai-sub{font-size:11px;color:#78350f;margin-bottom:10px;opacity:0.7}
.ai-row{display:flex;gap:10px}
.ai-in{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:13px 18px;color:var(--text);font-size:15px;font-family:'DM Sans',sans-serif;outline:none}
.ai-in:focus{border-color:var(--orange)}
.ai-in::placeholder{color:var(--muted)}
.ai-btn{background:linear-gradient(135deg,#f97316,#ea580c);border:none;color:white;font-size:15px;font-weight:700;padding:13px 28px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:6px;white-space:nowrap}
.ai-btn:hover{box-shadow:0 4px 16px rgba(234,88,12,0.25);transform:translateY(-1px)}
.ai-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;box-shadow:none}
.ai-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
.ai-chip{background:rgba(255,255,255,0.7);border:1px solid rgba(234,88,12,0.35);border-radius:12px;padding:4px 10px;font-size:11px;color:#9a3412;cursor:pointer;white-space:nowrap;font-weight:600;backdrop-filter:blur(4px)}
.ai-chip:hover{background:#ffffff;transform:translateY(-1px);border-color:#ea580c}
.ai-resp{background:linear-gradient(180deg,#fef3e2,#fde8cc);border:1px solid #f97316;border-top:none;border-radius:0 0 14px 14px;padding:24px 28px;margin-top:-1px;display:none;font-size:14px;line-height:1.8;color:#78350f;position:relative}
.ai-resp.active{display:block}
.ai-resp .metric{color:#ea580c;font-family:'JetBrains Mono',monospace;font-size:12px;background:rgba(234,88,12,0.1);padding:1px 5px;border-radius:3px}
.ai-resp .crit{color:#dc2626;font-weight:600}
.ai-resp .warn{color:#c2410c;font-weight:600}
.ai-typing{display:inline-block;width:10px;height:10px;border:2px solid var(--orange);border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin-right:6px;vertical-align:middle}
/* Provider Selector */
.ai-providers{display:flex;gap:6px;flex-shrink:0}
.ai-prov{border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;background:var(--bg);display:flex;align-items:center;gap:3px;white-space:nowrap}
.ai-prov:hover{transform:translateY(-1px)}
.ai-prov.active{font-weight:700}
.ai-prov.p-ollama.active{border-color:var(--cyan);background:rgba(20,184,166,0.12);color:#5eead4}
.ai-prov.p-claude.active{border-color:#d97757;background:#fff7ed;color:#d97757}
.ai-prov.p-gpt.active{border-color:#10a37f;background:#f0fdf4;color:#10a37f}
.ai-prov.p-ollama:not(.active){color:var(--muted)}.ai-prov.p-claude:not(.active){color:var(--muted)}.ai-prov.p-gpt:not(.active){color:var(--muted)}
.ai-prov .prov-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.ai-prov .prov-dot.on{background:#16a34a;box-shadow:0 0 4px rgba(22,163,74,0.4)}.ai-prov .prov-dot.off{background:#cbd5e1}
/* AI source badge */
.ai-source{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px solid rgba(234,88,12,0.2);font-size:11px;color:#92400e}
.ai-source .src-badge{display:flex;align-items:center;gap:6px}
.ai-source .src-actions{display:flex;gap:6px}
.ai-source .src-btn{padding:3px 10px;border:1px solid rgba(234,88,12,0.25);border-radius:6px;cursor:pointer;font-size:10px;transition:all .2s;color:#9a3412}
.ai-source .src-btn:hover{border-color:#ea580c;color:#ea580c}
.ai-cursor{display:inline-block;width:2px;height:14px;background:var(--orange);animation:blink 1s infinite;vertical-align:middle;margin-left:1px}
@keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes aiSpin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.85)}}

/* TABS */
.nt{display:flex;gap:4px;padding:0 24px;border-bottom:1px solid #d1d5db;background:#f0fdfa}
.ntab{padding:14px 26px;font-size:15px;font-weight:700;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;transition:all .3s;letter-spacing:0.5px}
.ntab:hover{color:#0f172a}
.ntab.act{color:#f97316;border-bottom-color:#f97316}
.tc{display:none;padding:20px 28px;flex:1;overflow-y:auto;background:#f0fdfa;color:#1e293b}
.tc.act{display:block}

/* TABLE */
.dh{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.dt{display:flex;gap:4px}
.tbtn{background:#ffffff;border:1px solid #d1d5db;color:#64748b;font-size:12px;padding:6px 14px;border-radius:6px;cursor:pointer}
.tbtn.act{background:#fff7ed;border-color:#f97316;color:#ea580c}
.rc{font-family:'JetBrains Mono',monospace;font-size:13px;color:#0f766e;background:#f0fdfa;padding:3px 10px;border-radius:10px}
.ds{font-size:11px;color:#64748b;font-style:italic}
table{width:100%;border-collapse:collapse}
th{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#64748b;text-align:left;padding:10px 12px;border-bottom:2px solid #d1d5db;font-weight:600}
td{padding:11px 12px;border-bottom:1px solid #e5e7eb;font-size:14px;color:#334155}
tr:hover td{background:#fff7ed}
.cve{color:#0f766e;font-family:'JetBrains Mono',monospace;font-size:13px;cursor:pointer}
.cve:hover{text-decoration:underline}
.score{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600}
.severity-badge{font-size:11px;font-weight:700;padding:4px 10px;border-radius:4px}
.severity-badge.CRITICAL{background:#fef2f2;color:#dc2626}
.severity-badge.HIGH{background:#fff7ed;color:#ea580c}
.severity-badge.MEDIUM{background:#fffbeb;color:#b45309}
.severity-badge.LOW{background:#f0fdf4;color:#16a34a}
.severity-badge.INFO{background:#f1f5f9;color:#64748b}
.kev-tag{background:#fef2f2;color:#dc2626;font-size:10px;padding:2px 6px;border-radius:3px;font-weight:700}
.noise-tag{color:#94a3b8;font-size:10px;font-style:italic}

/* CHARTS */
.cg{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.cc{background:#ffffff;border:1px solid #d1d5db;border-radius:14px;padding:18px;box-shadow:0 1px 3px rgba(15,23,42,0.04)}
.cc h3{font-size:13px;color:#64748b;margin-bottom:10px;text-transform:uppercase}
.cc.full{grid-column:1/-1}

/* RIGHT PANEL WIDGETS */
.wi{display:flex;align-items:center;gap:7px;padding:4px 0}
.wn{font-size:12px;color:#64748b;flex:0 0 80px}
.wbc{flex:1;height:7px;background:#e5e7eb;border-radius:3px;overflow:hidden}
.wb{height:100%;background:linear-gradient(90deg,#3b82f6,#0f766e);border-radius:3px}
.wv{font-family:'JetBrains Mono',monospace;font-size:13px;color:#0f766e;flex:0 0 35px;text-align:right}
.li{display:flex;gap:10px;padding:7px 0;align-items:flex-start}
.lic{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.lic.l1{background:#f0fdf4}.lic.l2{background:#f5f3ff}.lic.l3{background:#eff6ff}
.ln{font-size:14px;font-weight:600;color:#0f172a}.ld{font-size:12px;color:#64748b;line-height:1.3}
.lb{font-size:10px;background:#f0fdf4;color:#16a34a;padding:3px 8px;border-radius:6px;font-weight:600}
.si{font-size:12px;color:#64748b;padding:4px 0;font-family:'JetBrains Mono',monospace;line-height:1.6}
.si span{color:#334155}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:999;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:#ffffff;border:1px solid #d1d5db;border-radius:14px;width:640px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(15,23,42,0.15)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #e5e7eb}
.modal-head h2{font-family:'JetBrains Mono',monospace;font-size:18px;color:#0f766e}
.modal-close{background:none;border:none;color:#64748b;font-size:22px;cursor:pointer;padding:4px 8px;border-radius:6px}
.modal-close:hover{color:#0f172a}
.modal-body{padding:20px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.detail-item{background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;padding:12px 14px}
.detail-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:#64748b;margin-bottom:3px}
.detail-val{font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:600;color:#0f172a}
.comp-row{display:flex;align-items:center;gap:8px;padding:4px 0}
.comp-name{font-size:11px;color:#64748b;width:85px}
.comp-bar-bg{flex:1;height:7px;background:#e5e7eb;border-radius:3px;overflow:hidden}
.comp-bar-fill{height:100%;border-radius:3px}
.comp-val{font-family:'JetBrains Mono',monospace;font-size:11px;color:#0f766e;width:35px;text-align:right}

.ft{text-align:center;padding:18px;font-size:12px;color:#64748b;background:#f0fdfa}
.ft a{color:#0f766e;text-decoration:none}
.lp::-webkit-scrollbar,.rp::-webkit-scrollbar{width:5px}
.lp::-webkit-scrollbar-thumb,.rp::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:2px}
@media(max-width:1100px){.lp,.rp{display:none}.mc{margin:0}}
</style>
</head>
<body>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VULNPILOT VERSION 32 - NO OLLAMA CALLS
// If you see this in console, you have the RIGHT file
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
console.log('%c[VulnPilot v1.0] LOADED - Multi-provider AI with Lock 2 debate','color:lime;font-size:16px;font-weight:bold');
// Early declarations - these are referenced by HTML onclick before main script loads
var _aiData = null;
function switchTab(name, el) {
  document.querySelectorAll('.ntab').forEach(function(t){ t.classList.remove('act'); });
  document.querySelectorAll('.tc').forEach(function(t){ t.classList.remove('act'); });
  if(el) el.classList.add('act');
  var tab = document.getElementById('tab-'+name);
  if(tab) tab.classList.add('act');
}
function renderFilteredTable(){}
</script>
<div class="app">

<!-- LEFT PANEL - Scanners + Threat Intel -->
<div class="lp">
  <div class="ph"><div class="pt" style="cursor:pointer" onclick="switchTab('integrations',document.querySelectorAll('.ntab')[2])">Integrations (27)</div></div>
  <div class="ps">
    <div class="pst">Vulnerability Scanners</div>
    <div class="ii"><div class="dot on" id="d-openvas"></div><span class="in">OpenVAS / Greenbone</span><span class="ib oss">OSS</span></div>
    <div class="ii"><div class="dot on" id="d-wazuh"></div><span class="in">Wazuh SIEM</span><span class="ib oss">OSS</span></div>
    <div class="ii"><div class="dot on" id="d-nessus"></div><span class="in">Nessus File Import</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot off"></div><span class="in">Tenable.io</span><span class="ib lab">LAB</span></div>
    <div class="ii"><div class="dot off"></div><span class="in">Qualys VMDR</span><span class="ib lab">LAB</span></div>
    <div class="ii"><div class="dot off"></div><span class="in">Rapid7 InsightVM</span><span class="ib lab">LAB</span></div>
  </div>
  <div class="ps">
    <div class="pst">Threat Intelligence</div>
    <div class="ii"><div class="dot on" id="d-epss"></div><span class="in">FIRST EPSS</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot on" id="d-kev"></div><span class="in">CISA KEV</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot on" id="d-nvd"></div><span class="in">NVD / NIST 2.0</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot on" id="d-abuse"></div><span class="in">abuse.ch ThreatFox</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot off" id="d-otx"></div><span class="in">AlienVault OTX</span><span class="ib key">KEY</span></div>
    <div class="ii"><div class="dot off" id="d-gn"></div><span class="in">GreyNoise Community</span><span class="ib key">KEY</span></div>
    <div class="ii"><div class="dot off" id="d-shodan"></div><span class="in">Shodan CVEDB</span><span class="ib key">KEY</span></div>
  </div>
  <div class="ps">
    <div class="pst">Notifications</div>
    <div class="ii"><div class="dot on"></div><span class="in">Slack Webhooks</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot on"></div><span class="in">Microsoft Teams</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot on"></div><span class="in">Email (SMTP)</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot off"></div><span class="in">PagerDuty</span><span class="ib lab">LAB</span></div>
    <div class="ii"><div class="dot on"></div><span class="in">Generic Webhook</span><span class="ib open">OPEN</span></div>
  </div>
  <div class="ps">
    <div class="pst" style="cursor:pointer" onclick="switchTab('config',document.querySelectorAll('.ntab')[4])">VPRS Weights <span style="float:right;color:#f97316;font-size:11px">CONFIGURE ></span></div>
    <div style="cursor:pointer" onclick="switchTab('config',document.querySelectorAll('.ntab')[4])">
      <div class="ii"><span class="in">Threat Intel</span><span style="font-size:15px;font-weight:600;color:#0f766e;font-family:'JetBrains Mono',monospace">25%</span></div>
      <div class="ii"><span class="in">CISA KEV</span><span style="font-size:15px;font-weight:600;color:#0f766e;font-family:'JetBrains Mono',monospace">20%</span></div>
      <div class="ii"><span class="in">Dark Web</span><span style="font-size:15px;font-weight:600;color:#0f766e;font-family:'JetBrains Mono',monospace">15%</span></div>
      <div class="ii"><span class="in">Asset Crit.</span><span style="font-size:15px;font-weight:600;color:#0f766e;font-family:'JetBrains Mono',monospace">20%</span></div>
      <div class="ii"><span class="in">Reachability</span><span style="font-size:15px;font-weight:600;color:#0f766e;font-family:'JetBrains Mono',monospace">12%</span></div>
      <div class="ii"><span class="in">Controls</span><span style="font-size:15px;font-weight:600;color:#0f766e;font-family:'JetBrains Mono',monospace">8%</span></div>
    </div>
    <div style="margin-top:6px;height:6px;background:#e5e7eb;border-radius:2px;overflow:hidden;display:flex">
      <div style="width:25%;background:var(--blue)"></div><div style="width:20%;background:var(--crit)"></div><div style="width:15%;background:#8b5cf6"></div><div style="width:20%;background:var(--cyan)"></div><div style="width:12%;background:var(--orange)"></div><div style="width:8%;background:var(--low)"></div>
    </div>
  </div>
</div>


<!-- RIGHT PANEL -->
<div class="rp">
  <div class="ph"><div class="pt" style="cursor:pointer" onclick="switchTab('integrations',document.querySelectorAll('.ntab')[2])">Scoring and Safety</div></div>
  <div class="ps">
    <div class="pst">Ticketing / CMDB</div>
    <div class="ii"><div class="dot on" id="d-console"></div><span class="in">Console (Dev)</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot off"></div><span class="in">ServiceNow</span><span class="ib open">OPEN DEV</span></div>
    <div class="ii"><div class="dot off"></div><span class="in">Jira Cloud</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot on" id="d-csv"></div><span class="in">CSV (Built-in)</span><span class="ib open">OPEN</span></div>
    <div class="ii"><div class="dot off"></div><span class="in">ServiceNow CMDB</span><span class="ib open">OPEN DEV</span></div>
  </div>
  <div class="ps">
    <div class="pst">AI / LLM</div>
    <div class="ii" style="cursor:pointer" onclick="setAIProvider('ollama',document.querySelector('.ai-prov.p-ollama'))"><div class="dot on" id="d-ollama"></div><span class="in">Ollama (Local)</span><span class="ib oss">OSS</span></div>
    <div style="font-size:10px;color:var(--low);margin:-2px 0 4px 22px;font-family:'JetBrains Mono',monospace">qwen2.5:7b</div>
    <div class="ii" style="cursor:pointer" onclick="setAIProvider('anthropic',document.querySelector('.ai-prov.p-claude'))"><div class="dot off" id="d-claude"></div><span class="in">Claude</span><span class="ib key" id="claudeSideTag">SETUP ‚Üí</span></div>
    <div class="ii" style="cursor:pointer" onclick="setAIProvider('openai',document.querySelector('.ai-prov.p-gpt'))"><div class="dot off" id="d-gpt"></div><span class="in">GPT-4o</span><span class="ib key" id="gptSideTag">SETUP ‚Üí</span></div>
  </div>
  <div class="ps">
    <div class="pst" style="cursor:pointer" onclick="switchTab('config',document.querySelectorAll('.ntab')[4])">Triple-Lock Safety <span class="lb" style="float:right">3 LOCKS</span></div>
    <div class="li" style="cursor:pointer" onclick="switchTab('config',document.querySelectorAll('.ntab')[4])"><div class="lic l1">üîí</div><div><div class="ln">Lock 1 - Hard Rules</div><div class="ld">KEV = CRITICAL. AI cannot override.</div></div></div>
    <div class="li" style="cursor:pointer" onclick="switchTab('config',document.querySelectorAll('.ntab')[4])"><div class="lic l2">‚öîÔ∏è</div><div><div class="ln">Lock 2 - Adversarial AI</div><div class="ld">Two AI models debate every CVE.</div></div></div>
    <div class="li" style="cursor:pointer" onclick="switchTab('config',document.querySelectorAll('.ntab')[4])"><div class="lic l3">üîÑ</div><div><div class="ln">Lock 3 - Drift Detector</div><div class="ld">T1: 1h, T2: 3h, T3: 6h recheck.</div></div></div>
  </div>
  <div class="ps" style="cursor:pointer" onclick="window.location='/setup#drift'">
    <div class="pst">Drift Detector <span class="lb" style="float:right;background:#f0fdf4;color:var(--low)">ACTIVE</span></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px">
      <div style="text-align:center;padding:8px;background:#fef2f2;border-radius:6px;border:1px solid #fecaca"><div style="font-size:16px;font-weight:700;color:var(--crit)" id="driftT1Val">1h</div><div style="font-size:10px;color:#64748b">TIER 1</div></div>
      <div style="text-align:center;padding:8px;background:#fff7ed;border-radius:6px;border:1px solid #fed7aa"><div style="font-size:16px;font-weight:700;color:var(--orange)" id="driftT2Val">3h</div><div style="font-size:10px;color:#64748b">TIER 2</div></div>
      <div style="text-align:center;padding:8px;background:#eff6ff;border-radius:6px;border:1px solid #bfdbfe"><div style="font-size:16px;font-weight:700;color:var(--blue)" id="driftT3Val">6h</div><div style="font-size:10px;color:#64748b">TIER 3</div></div>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <button onclick="runDriftCheck()" id="driftCheckBtn" style="flex:1;background:#fff;border:1px solid #d1d5db;color:#0f766e;font-size:11px;font-weight:700;padding:6px 0;border-radius:6px;cursor:pointer;transition:all .2s" onmouseover="this.style.borderColor='#0f766e'" onmouseout="this.style.borderColor='#d1d5db'">üîÑ Check Now</button>
      <button onclick="runDriftDemo()" id="driftDemoBtn" style="flex:1;background:#fff;border:1px solid #d1d5db;color:#ea580c;font-size:11px;font-weight:700;padding:6px 0;border-radius:6px;cursor:pointer;transition:all .2s" onmouseover="this.style.borderColor='#ea580c'" onmouseout="this.style.borderColor='#d1d5db'">‚ö° Demo Drift</button>
    </div>
    <div id="driftLog" style="display:none;max-height:200px;overflow-y:auto;font-size:11px;line-height:1.5"></div>
    <div id="driftEmpty" style="font-size:11px;color:var(--muted);line-height:1.5">
      <span style="color:var(--low)">‚óè</span> Default 6h ¬∑ <span style="cursor:pointer;color:var(--cyan);font-size:10px" onclick="window.location='/setup#drift'">Configure ‚Üí</span>
    </div>
  </div>
  <!-- Threat Intel Live Stats - Large, green glow -->
  <div class="ps">
    <div class="pst">Threat Intel <span class="lb" style="float:right;background:#f0fdf4;color:var(--low)">LIVE</span></div>
    <div id="threatIntelStats" style="display:flex;flex-direction:column;gap:4px">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0"><span style="font-size:12px;color:#94a3b8;font-weight:500">nvd_cves</span><span id="tiNvd" style="font-size:16px;font-weight:800;color:#16a34a;font-family:'JetBrains Mono',monospace;">-</span></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0"><span style="font-size:12px;color:#94a3b8;font-weight:500">cisa_kev</span><span id="tiKev" style="font-size:16px;font-weight:800;color:#16a34a;font-family:'JetBrains Mono',monospace;">-</span></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0"><span style="font-size:12px;color:#94a3b8;font-weight:500">epss</span><span id="tiEpss" style="font-size:16px;font-weight:800;color:#16a34a;font-family:'JetBrains Mono',monospace;">-</span></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0"><span style="font-size:12px;color:#94a3b8;font-weight:500">otx_iocs</span><span id="tiOtx" style="font-size:16px;font-weight:800;color:#16a34a;font-family:'JetBrains Mono',monospace;">-</span></div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0"><span style="font-size:12px;color:#94a3b8;font-weight:500">abusech</span><span id="tiAbuse" style="font-size:16px;font-weight:800;color:#16a34a;font-family:'JetBrains Mono',monospace;">-</span></div>
    </div>
  </div>
  <!-- Spacer to push builder credit to bottom -->
  <div style="flex:1;min-height:20px"></div>
  <!-- Builder Credit - Sticky at very bottom -->
  <div style="padding:14px 18px;border-top:1px solid #fed7aa;background:#fff7ed">
    <div style="font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">AI Cyber Architect</div>
    <div style="display:flex;align-items:center;gap:8px">
      <a href="https://www.credly.com/users/eskintan/badges" target="_blank" style="font-size:15px;font-weight:800;color:var(--orange);letter-spacing:0.5px;text-decoration:none;transition:all .2s" onmouseover="this.style.textShadow='none'" onmouseout="this.style.textShadow='none'">üèÖ 3sk1nt4n</a>
    </div>
    <div style="font-size:11px;color:var(--cyan);margin-top:4px;font-family:'JetBrains Mono',monospace;letter-spacing:0.5px">VulnPilot AI v1.0 - Agentic Vulnerability Management</div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="mc">
  <div class="tb">
    <a class="brand" href="/">
      <div class="bi"><svg width="64" height="64" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241 l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3 c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716 c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939 c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346 l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842 c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842 C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157 c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2 S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1 s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2 s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg></div>
      <div><h1>Vuln<span style="color:var(--orange)">Pilot</span> AI - Agentic Vulnerability Management</h1><p>Zero Noise ¬∑ Zero Delay ¬∑ Zero Missed Patches</p></div>
    </a>
    <div class="tr">
      <button class="btn-s" id="topOllamaBtn" style="background:#d1fae5;border-color:#16a34a;color:#16a34a;font-weight:800;box-shadow:0 0 8px rgba(22,163,74,0.3)" onclick="switchToOllamaFromTop()">ü¶ô Ollama</button>
      <button class="btn-s" id="topClaudeBtn" style="background:#fff7ed;border-color:#fed7aa;color:#d97757" onclick="switchToClaudeFromTop()">üü† Claude</button>
      <button class="btn-s" id="topGptBtn" style="background:#f0fdf4;border-color:#bbf7d0;color:#10a37f" onclick="switchToGptFromTop()">üü¢ GPT-4o</button>
    </div>
  </div>

  <div class="sr">
    <div class="sc" style="cursor:pointer" onclick="switchTab('dashboard',document.querySelectorAll('.ntab')[0]);if(_aiData){document.getElementById('aiQuery').value='Which tickets were auto-created?';askAI();}"><div class="sl">Tickets Created</div><div class="sv or" id="statTicketsPct">45%</div><div class="ss" id="statTickets">21 auto-assigned with SLA</div></div>
    <div class="sc" style="cursor:pointer" onclick="switchTab('dashboard',document.querySelectorAll('.ntab')[0]);if(_aiData){document.getElementById('aiQuery').value='Show me all CVSS vs VPRS flips';askAI();}"><div class="sl">CVSS‚ÜíVPRS Flips</div><div class="sv cy" id="statFlipPct">55%</div><div class="ss" id="statFlipCount">26 of 47 re-prioritized</div></div>
    <div class="sc" style="cursor:pointer" onclick="switchTab('dashboard',document.querySelectorAll('.ntab')[0]);if(_aiData){renderFilteredTable(_aiData.results,'critical');document.getElementById('aiQuery').value='Which CVEs should I patch first this week?';askAI();}"><div class="sl">Critical</div><div class="sv cr" id="statCriticalPct">26%</div><div class="ss" id="statCritical">12 requires immediate action</div></div>
    <div class="sc" style="cursor:pointer" onclick="switchTab('dashboard',document.querySelectorAll('.ntab')[0]);if(_aiData){renderFilteredTable(_aiData.results,'noise');document.getElementById('aiQuery').value='What got eliminated as noise?';askAI();}"><div class="sl">Noise Eliminated</div><div class="sv gr" id="statNoiseRate">85%</div><div class="ss" id="statNoise">26 eliminated</div></div>
  </div>

  <!-- TABS -->
  <div class="nt">
    <div class="ntab act" onclick="switchTab('dashboard',this)">Dashboard</div>
    <div class="ntab" onclick="switchTab('charts',this)">Analytics</div>
    <div class="ntab" onclick="switchTab('integrations',this)">Integrations</div>
    <div class="ntab" onclick="switchTab('reports',this)">Reports</div>
    <div class="ntab" onclick="switchTab('config',this)">Config</div>
    <div class="ntab" onclick="window.location='/setup'" style="margin-left:auto">‚öôÔ∏è Setup</div>
  </div>

  <div class="tc act" id="tab-dashboard">
    <div class="dh">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <span style="font-size:14px;font-weight:700">Vulnerability Results</span>
        <div class="dt">
          <button class="tbtn act" id="btnLive" onclick="loadRealData()">LIVE DATA (REAL APIS)</button>
          <button class="tbtn" id="btnDemo" onclick="loadLiveData()">DEMO DATA</button>
        </div>
        <div class="dt" style="margin-left:8px">
          <button class="tbtn fbtn act" id="fbtn-critical" onclick="if(_aiData)renderFilteredTable(_aiData.results,'critical')" style="background:#fef2f2;border-color:#fecaca;color:var(--crit)">Critical Only</button>
          <button class="tbtn fbtn" id="fbtn-high" onclick="if(_aiData)renderFilteredTable(_aiData.results,'critical+high')">Critical + High</button>
          <button class="tbtn fbtn" id="fbtn-all" onclick="if(_aiData)renderFilteredTable(_aiData.results,'all')">Show All</button>
          <button class="tbtn fbtn" id="fbtn-noise" onclick="if(_aiData)renderFilteredTable(_aiData.results,'noise')">Noise</button>
        </div>
        <span class="rc" id="resultCount">47 CVEs scored</span>
      </div>
      <span class="ds" id="dataSource">DEMO - 47 realistic CVEs scored through VPRS engine</span>
    </div>
    <table><thead><tr><th>CVE</th><th>CVSS</th><th>VPRS</th><th>SEVERITY</th><th>KEV</th><th>HARD RULE</th><th>STATUS</th></tr></thead><tbody id="vulnTableBody"></tbody></table>

    <!-- AI BAR RIGHT UNDER TABLE -->
    <div class="ai-section" style="margin-top:20px">
      <div class="ai-bar">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;flex-wrap:wrap;gap:8px">
          <div>
            <div class="ai-t">VULNPILOT AI - <span style="color:var(--amber)">AGENTIC VULNERABILITY MANAGEMENT</span></div>
            <div class="ai-sub">Zero Noise ¬∑ Zero Delay ¬∑ Zero Missed Patches</div>
          </div>
          <div class="ai-providers" id="aiProviders">
            <div class="ai-prov p-ollama active" onclick="setAIProvider('ollama',this)" title="Open local AI"><span class="prov-dot on" id="provDotOllama"></span> ü¶ô Ollama <span style="font-size:10px;opacity:0.8;font-weight:700">OPEN</span></div>
            <div class="ai-prov p-claude" onclick="setAIProvider('anthropic',this)" title="Anthropic Claude - $5 credits at console.anthropic.com"><span class="prov-dot off" id="provDotClaude"></span> üü† Claude <span id="claudeStatusTag" style="font-size:10px;opacity:0.8;font-weight:700">SETUP ‚Üí</span></div>
            <div class="ai-prov p-gpt" onclick="setAIProvider('openai',this)" title="OpenAI GPT-4o - $5 credits at platform.openai.com"><span class="prov-dot off" id="provDotGpt"></span> üü¢ GPT <span id="gptStatusTag" style="font-size:10px;opacity:0.8;font-weight:700">SETUP ‚Üí</span></div>
          </div>
        </div>
        <div class="ai-row">
          <input class="ai-in" id="aiQuery" placeholder="e.g. Which CVEs should I patch first this week?" onkeydown="if(event.key==='Enter')askAI()">
          <button class="ai-btn" id="aiAskBtn" onclick="askAI()">‚ö° Ask AI</button>
        </div>
        <div class="ai-chips" id="aiSuggestions">
          <div class="ai-chip" onclick="document.getElementById('aiQuery').value='What should I patch first?';askAI()">üî• Patch first</div>
          <div class="ai-chip" onclick="document.getElementById('aiQuery').value='60-second security briefing';askAI()">üìã Briefing</div>
          <div class="ai-chip" onclick="document.getElementById('aiQuery').value='Show CISA KEV matches';askAI()">üõ° KEV</div>
          <div class="ai-chip" onclick="document.getElementById('aiQuery').value='What has dark web activity?';askAI()">üïµÔ∏è Dark web</div>
          <div class="ai-chip" onclick="document.getElementById('aiQuery').value='Show CVSS vs VPRS flips';askAI()">üîÑ Flips</div>
          <div class="ai-chip" onclick="document.getElementById('aiQuery').value='Which tickets were auto-created?';askAI()">üé´ Tickets</div>
          <div class="ai-chip" onclick="document.getElementById('aiQuery').value='What noise was eliminated?';askAI()">üîá Noise</div>
          <div class="ai-chip" onclick="document.getElementById('aiQuery').value='Top 5 risks right now';askAI()">üéØ Top risks</div>
        </div>
      </div>
      <div class="ai-resp" id="aiResponse"><div id="aiRespLabel" style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid rgba(234,88,12,0.15)"><svg width="20" height="20" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle;flex-shrink:0;animation:aiSpin 3s linear infinite"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg><span style="font-size:14px;font-weight:800;color:#9a3412;letter-spacing:0.3px">VulnPilot Agentic-AI Answer:</span><span id="aiRespProvider" style="font-size:11px;color:#92400e;opacity:0.7;margin-left:auto"></span></div><div id="aiResponseBody"></div></div>
    </div>
  </div>

  <div class="tc" id="tab-config">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">

      <!-- VPRS WEIGHT EDITOR -->
      <div class="sc" style="padding:24px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
          <div>
            <div style="font-size:16px;font-weight:700;color:var(--orange)">VPRS Scoring Weights</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px">Customer-tunable risk weights. Must sum to 100%.</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="resetVprsDefaults()" style="background:rgba(20,184,166,0.12);color:#5eead4;border:1px solid #99f6e4;font-size:10px;font-weight:600;padding:5px 12px;border-radius:6px;cursor:pointer;transition:all .2s" onmouseover="this.style.background='#ccfbf1'" onmouseout="this.style.background='#f0fdfa'">‚Ü∫ RESET DEFAULT</button>
            <button id="vprsLockBtn" onclick="toggleVprsLock()" style="background:#fff7ed;color:var(--orange);border:1px solid #fed7aa;font-size:10px;font-weight:600;padding:5px 12px;border-radius:6px;cursor:pointer;transition:all .2s" onmouseover="this.style.background='#fed7aa'" onmouseout="this.style.background='#fff7ed'">üîì UNLOCKED</button>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:14px" id="vprsEditor">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:12px;height:12px;border-radius:3px;background:var(--blue);flex-shrink:0"></div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Threat Intelligence</div><div style="font-size:10px;color:#64748b">EPSS exploit probability + CVSS base score</div></div>
            <input type="range" min="0" max="50" value="25" style="width:80px;accent-color:var(--blue)" oninput="this.nextElementSibling.textContent=this.value+'%';updateYaml()"><span style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--cyan);width:35px;text-align:right">25%</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:12px;height:12px;border-radius:3px;background:var(--crit);flex-shrink:0"></div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">CISA KEV Status</div><div style="font-size:10px;color:#64748b">Known Exploited Vulnerabilities catalog match</div></div>
            <input type="range" min="0" max="50" value="20" style="width:80px;accent-color:var(--crit)" oninput="this.nextElementSibling.textContent=this.value+'%';updateYaml()"><span style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--cyan);width:35px;text-align:right">20%</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:12px;height:12px;border-radius:3px;background:#8b5cf6;flex-shrink:0"></div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Dark Web Intel</div><div style="font-size:10px;color:#64748b">abuse.ch ThreatFox IoC mentions</div></div>
            <input type="range" min="0" max="50" value="15" style="width:80px;accent-color:#8b5cf6" oninput="this.nextElementSibling.textContent=this.value+'%';updateYaml()"><span style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--cyan);width:35px;text-align:right">15%</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:12px;height:12px;border-radius:3px;background:var(--cyan);flex-shrink:0"></div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Asset Criticality</div><div style="font-size:10px;color:#64748b">Tier 1 (critical) / Tier 2 (important) / Tier 3 (standard)</div></div>
            <input type="range" min="0" max="50" value="20" style="width:80px;accent-color:var(--cyan)" oninput="this.nextElementSibling.textContent=this.value+'%';updateYaml()"><span style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--cyan);width:35px;text-align:right">20%</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:12px;height:12px;border-radius:3px;background:var(--orange);flex-shrink:0"></div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Reachability / Exposure</div><div style="font-size:10px;color:#64748b">Internet-facing, network segmentation, WAF</div></div>
            <input type="range" min="0" max="50" value="12" style="width:80px;accent-color:var(--orange)" oninput="this.nextElementSibling.textContent=this.value+'%';updateYaml()"><span style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--cyan);width:35px;text-align:right">12%</span>
          </div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="width:12px;height:12px;border-radius:3px;background:var(--low);flex-shrink:0"></div>
            <div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Compensating Controls</div><div style="font-size:10px;color:#64748b">EDR, IPS, patching cadence, MFA</div></div>
            <input type="range" min="0" max="50" value="8" style="width:80px;accent-color:var(--low)" oninput="this.nextElementSibling.textContent=this.value+'%';updateYaml()"><span style="font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--cyan);width:35px;text-align:right">8%</span>
          </div>
        </div>
        <div style="margin-top:16px;padding:12px 14px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);line-height:1.7">
          <div style="color:var(--orange);margin-bottom:4px"># config/scoring.yml - updates live as you drag</div>
          <div id="yamlContent">weights:<br>&nbsp;&nbsp;threat_intel: 0.25<br>&nbsp;&nbsp;kev: 0.20<br>&nbsp;&nbsp;dark_web: 0.15<br>&nbsp;&nbsp;asset_criticality: 0.20<br>&nbsp;&nbsp;reachability: 0.12<br>&nbsp;&nbsp;compensating_controls: 0.08</div>
      </div>
      </div>

      <!-- TRIPLE LOCK SAFETY -->
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="sc" style="padding:20px;border-left:3px solid var(--low)">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <div class="lic l1" style="width:32px;height:32px;font-size:15px">üîí</div>
            <div><div style="font-size:15px;font-weight:700;color:#0f172a">Lock 1 - Hard Rules</div><div style="font-size:11px;color:var(--low);font-weight:600">CANNOT BE OVERRIDDEN BY AI</div></div>
          </div>
          <div style="font-size:12px;color:#334155;line-height:1.6;margin-bottom:10px">Non-negotiable scoring overrides that AI agents cannot change. These protect against AI hallucination and ensure compliance.</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#fef2f2;border-radius:6px;font-size:11px"><span style="color:var(--crit);font-weight:700">RULE</span><span style="color:#64748b">CISA KEV CVEs are ALWAYS scored CRITICAL</span></div>
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#fef2f2;border-radius:6px;font-size:11px"><span style="color:var(--crit);font-weight:700">RULE</span><span style="color:#64748b">Ransomware-associated CVEs auto-escalate</span></div>
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#fef2f2;border-radius:6px;font-size:11px"><span style="color:var(--crit);font-weight:700">RULE</span><span style="color:#64748b">Internet-facing + EPSS > 0.7 = forced critical</span></div>
          </div>
        </div>

        <div class="sc" style="padding:20px;border-left:3px solid #8b5cf6">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <div class="lic l2" style="width:32px;height:32px;font-size:15px">‚öîÔ∏è</div>
            <div><div style="font-size:15px;font-weight:700;color:#0f172a">Lock 2 - Adversarial AI</div><div style="font-size:11px;color:#8b5cf6;font-weight:600">CROSS-MODEL VALIDATION</div></div>
          </div>
          <div style="font-size:12px;color:#334155;line-height:1.6;margin-bottom:10px">Two AI agents independently score each CVE, then debate. Prevents hallucination and ensures scoring accuracy.</div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#f5f3ff;border-radius:6px;font-size:11px"><span style="color:#8b5cf6;font-weight:700">AGENT 3A</span><span style="color:#64748b">Justifier - builds the case for score</span></div>
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#f5f3ff;border-radius:6px;font-size:11px"><span style="color:#8b5cf6;font-weight:700">AGENT 3B</span><span style="color:#64748b">Challenger - attacks the reasoning</span></div>
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#f5f3ff;border-radius:6px;font-size:11px"><span style="color:#8b5cf6;font-weight:700">THRESHOLD</span><span style="color:#64748b">If disagree by >15 pts, flag for human review</span></div>
          </div>
          <!-- Debate Top 5 - Live Proof Button -->
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
            <button id="debateTop5Btn" onclick="debateTopCves(5)" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);border:none;color:#fff;font-size:12px;font-weight:700;padding:8px 18px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px">‚öîÔ∏è Debate Top 5 Critical CVEs</button>
            <button onclick="debateTopCves(10)" style="background:#f5f3ff;border:1px solid #ddd6fe;color:#8b5cf6;font-size:11px;font-weight:600;padding:7px 14px;border-radius:8px;cursor:pointer">‚öîÔ∏è Top 10</button>
            <button onclick="debateTopCves(1)" style="background:#f5f3ff;border:1px solid #ddd6fe;color:var(--muted);font-size:11px;font-weight:600;padding:7px 14px;border-radius:8px;cursor:pointer">‚ö° Quick Demo (1)</button>
          </div>
          <div style="font-size:10px;color:var(--muted);margin-bottom:8px">Runs real AI debate on highest-risk CVEs. Watch Agent 3A justify ‚Üí Agent 3B challenge ‚Üí verdict, live.</div>
          <!-- Live Debate Activity Log -->
          <div id="debateLog" style="display:none;max-height:320px;overflow-y:auto;background:#f5f3ff;border:1px solid #ddd6fe;border-radius:8px;padding:10px;font-family:'JetBrains Mono',monospace;font-size:10px;line-height:1.7"></div>
          <div id="debateSummary" style="display:none;margin-top:8px;padding:10px;background:#f5f3ff;border:1px solid #ddd6fe;border-radius:8px;font-size:12px"></div>
        </div>

        <div class="sc" style="padding:20px;border-left:3px solid var(--blue)">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <div class="lic l3" style="width:32px;height:32px;font-size:15px">üîÑ</div>
            <div><div style="font-size:15px;font-weight:700;color:#0f172a">Lock 3 - Drift Detector</div><div style="font-size:11px;color:var(--blue);font-weight:600">CONTINUOUS RE-SCORING</div></div>
          </div>
          <div style="font-size:12px;color:#334155;line-height:1.6;margin-bottom:10px">Automatically re-checks scores as the threat landscape changes. Detects new KEV additions, EPSS shifts, and dark web spikes.</div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#eff6ff;border-radius:6px;font-size:11px"><span style="color:var(--blue);font-weight:700">TIER 1</span><span style="color:#64748b">Critical assets re-scored every 1 hour</span></div>
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#eff6ff;border-radius:6px;font-size:11px"><span style="color:var(--blue);font-weight:700">TIER 2</span><span style="color:#64748b">Important assets re-scored every 3 hours</span></div>
            <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#eff6ff;border-radius:6px;font-size:11px"><span style="color:var(--blue);font-weight:700">TIER 3</span><span style="color:#64748b">Standard assets re-scored every 6 hours</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tc" id="tab-charts">
    <div class="cg" id="chartsSection">
      <div class="cc" style="cursor:pointer"><h3>Severity Distribution <span style="font-size:10px;color:var(--orange);font-weight:400">CLICK BAR TO FILTER</span></h3><canvas id="severityChart"></canvas></div>
      <div class="cc" style="cursor:pointer"><h3>CVSS vs VPRS Scatter <span style="font-size:10px;color:var(--orange);font-weight:400">CLICK DOT FOR CVE DETAIL</span></h3><canvas id="scatterChart"></canvas></div>
      <div class="cc full" style="cursor:pointer"><h3>Top 10 - VPRS Components <span style="font-size:10px;color:var(--orange);font-weight:400">CLICK BAR FOR CVE DETAIL</span></h3><canvas id="componentChart"></canvas></div>
    </div>
  </div>

  <div class="tc" id="tab-integrations">
    <div style="margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2 style="font-size:18px;font-weight:700;color:#0f172a">Vuln<span style="color:var(--orange)">Pilot</span> AI - Agentic Vulnerability Management</h2>
        <p style="font-size:12px;color:var(--muted);margin-top:2px">31 integrations. All free to test. Zero lock-in. <a href="/setup" style="color:var(--cyan);text-decoration:none;font-weight:600">Open Setup Page</a></p>
      </div>
      <div style="display:flex;gap:8px">
        <span style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--low)"><span class="dot on"></span> Connected</span>
        <span style="display:flex;align-items:center;gap:4px;font-size:11px;color:#64748b"><span class="dot off"></span> Not configured</span>
        <span style="display:flex;align-items:center;gap:4px;font-size:11px;color:var(--med)"><span class="dot wait"></span> Needs key</span>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="sc" style="padding:18px">
        <div style="font-size:14px;font-weight:700;color:var(--orange);margin-bottom:12px">Threat Intelligence (7 APIs)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">FIRST EPSS</div><div style="font-size:11px;color:#64748b">Exploit Prediction Scoring - api.first.org</div></div><span class="ib open" onclick="event.stopPropagation()" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">CISA KEV</div><div style="font-size:11px;color:#64748b">Known Exploited Vulnerabilities catalog</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">NVD / NIST 2.0</div><div style="font-size:11px;color:#64748b">National Vulnerability Database API</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">abuse.ch ThreatFox</div><div style="font-size:11px;color:#64748b">IoC feed - malware, C2, dark web</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot wait"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">AlienVault OTX</div><div style="font-size:11px;color:#64748b">Open Threat Exchange pulses</div></div><span class="ib key" style="font-size:10px;padding:3px 8px">API KEY</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot wait"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">GreyNoise Community</div><div style="font-size:11px;color:#64748b">Internet scanner/noise classification</div></div><span class="ib key" style="font-size:10px;padding:3px 8px">API KEY</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot wait"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Shodan CVEDB</div><div style="font-size:11px;color:#64748b">CVE exploit and exposure data</div></div><span class="ib key" style="font-size:10px;padding:3px 8px">API KEY</span></div>
        </div>
      </div>
      <div class="sc" style="padding:18px">
        <div style="font-size:14px;font-weight:700;color:var(--orange);margin-bottom:12px">Vulnerability Scanners (6)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">OpenVAS / Greenbone</div><div style="font-size:11px;color:#64748b">Open-source vulnerability scanner</div></div><span class="ib oss" style="font-size:10px;padding:3px 8px">OSS</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Wazuh SIEM</div><div style="font-size:11px;color:#64748b">Open-source SIEM + vulnerability detection</div></div><span class="ib oss" style="font-size:10px;padding:3px 8px">OSS</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Nessus File Import</div><div style="font-size:11px;color:#64748b">Import .nessus XML scan files</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Tenable.io</div><div style="font-size:11px;color:#64748b">Cloud vulnerability management</div></div><span class="ib lab" style="font-size:10px;padding:3px 8px">LAB</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Qualys VMDR</div><div style="font-size:11px;color:#64748b">Cloud vulnerability + patch management</div></div><span class="ib lab" style="font-size:10px;padding:3px 8px">LAB</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Rapid7 InsightVM</div><div style="font-size:11px;color:#64748b">Risk-based vulnerability management</div></div><span class="ib lab" style="font-size:10px;padding:3px 8px">LAB</span></div>
        </div>
      </div>
      <div class="sc" style="padding:18px">
        <div style="font-size:14px;font-weight:700;color:var(--orange);margin-bottom:12px">Ticketing and Workflow (3)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Console (Dev Mode)</div><div style="font-size:11px;color:#64748b">Local console output for development</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">ServiceNow</div><div style="font-size:11px;color:#64748b">IT service management tickets with SLA</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN DEV</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Jira Cloud</div><div style="font-size:11px;color:#64748b">Atlassian project tracking</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
        </div>
      </div>
      <div class="sc" style="padding:18px">
        <div style="font-size:14px;font-weight:700;color:var(--orange);margin-bottom:12px">AI / LLM Providers (3)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Ollama (Local)</div><div style="font-size:11px;color:#64748b">Open local LLM - Qwen, Mistral, Llama</div></div><span class="ib oss" style="font-size:10px;padding:3px 8px">OSS</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot wait"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Anthropic Claude</div><div style="font-size:11px;color:#64748b">Claude Sonnet/Opus for deep analysis</div></div><span class="ib key" style="font-size:10px;padding:3px 8px">API KEY</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot wait"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">OpenAI GPT-4o</div><div style="font-size:11px;color:#64748b">GPT-4o for adversarial AI debate</div></div><span class="ib key" style="font-size:10px;padding:3px 8px">API KEY</span></div>
        </div>
      </div>
      <div class="sc" style="padding:18px">
        <div style="font-size:14px;font-weight:700;color:var(--orange);margin-bottom:12px">Notifications (5)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Slack Webhooks</div><div style="font-size:11px;color:#64748b">Channel alerts for critical CVEs</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Microsoft Teams</div><div style="font-size:11px;color:#64748b">Teams channel notifications</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Email (SMTP)</div><div style="font-size:11px;color:#64748b">Email alerts to security team</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">PagerDuty</div><div style="font-size:11px;color:#64748b">On-call incident escalation</div></div><span class="ib lab" style="font-size:10px;padding:3px 8px">LAB</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Generic Webhook</div><div style="font-size:11px;color:#64748b">Custom HTTP POST to any endpoint</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
        </div>
      </div>
      <div class="sc" style="padding:18px">
        <div style="font-size:14px;font-weight:700;color:var(--orange);margin-bottom:12px">CMDB / Assets (2) + Premium (3)</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot on"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">CSV File Import</div><div style="font-size:11px;color:#64748b">Built-in asset inventory from CSV</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fc;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:all .2s"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">ServiceNow CMDB</div><div style="font-size:11px;color:#64748b">Configuration management database</div></div><span class="ib open" style="font-size:10px;padding:3px 8px">OPEN DEV</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#fef2f2;cursor:pointer;transition:all .2s;border:1px solid #fecaca;border-radius:8px"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Recorded Future</div><div style="font-size:11px;color:#64748b">Premium threat intelligence</div></div><span style="font-size:10px;padding:3px 8px;background:#fef2f2;color:#dc2626;border-radius:3px;font-weight:700">PREMIUM</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#fef2f2;cursor:pointer;transition:all .2s;border:1px solid #fecaca;border-radius:8px"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Flashpoint</div><div style="font-size:11px;color:#64748b">Dark web intelligence platform</div></div><span style="font-size:10px;padding:3px 8px;background:#fef2f2;color:#dc2626;border-radius:3px;font-weight:700">PREMIUM</span></div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#fef2f2;cursor:pointer;transition:all .2s;border:1px solid #fecaca;border-radius:8px"><div class="dot off"></div><div style="flex:1"><div style="font-size:13px;font-weight:600;color:#0f172a">Intel 471</div><div style="font-size:11px;color:#64748b">Adversary and malware intelligence</div></div><span style="font-size:10px;padding:3px 8px;background:#fef2f2;color:#dc2626;border-radius:3px;font-weight:700">PREMIUM</span></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tc" id="tab-reports">
    <div style="margin-bottom:16px">
      <h2 style="font-size:18px;font-weight:700;color:#0f172a">Report <span style="color:var(--orange)">Generator</span></h2>
      <p style="font-size:12px;color:#94a3b8;margin-top:2px">Generate reports from your scored vulnerability data. All reports use live VPRS-scored data.</p>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px">
      <div class="sc" style="cursor:pointer;padding:20px;transition:all .3s;border:1px solid transparent" onmouseover="this.style.borderColor='#fed7aa'" onmouseout="this.style.borderColor='transparent'" onclick="generateReport('executive')">
        <div style="font-size:24px;margin-bottom:8px">üìä</div>
        <div class="sl" style="color:var(--orange)">Weekly Executive</div>
        <div style="font-size:12px;color:#334155;margin-top:6px;line-height:1.5">Risk posture summary, top 5 critical CVEs, and remediation recommendations for leadership.</div>
        <div style="margin-top:10px;font-size:10px;color:#64748b">Format: Markdown (.md)</div>
      </div>
      <div class="sc" style="cursor:pointer;padding:20px;transition:all .3s;border:1px solid transparent" onmouseover="this.style.borderColor='#fed7aa'" onmouseout="this.style.borderColor='transparent'" onclick="generateReport('technical')">
        <div style="font-size:24px;margin-bottom:8px">üîß</div>
        <div class="sl" style="color:var(--cyan)">Technical Detail</div>
        <div style="font-size:12px;color:#334155;margin-top:6px;line-height:1.5">Complete JSON export with all CVEs, scores, components, asset data, and enrichment sources.</div>
        <div style="margin-top:10px;font-size:10px;color:#64748b">Format: JSON (.json)</div>
      </div>
      <div class="sc" style="cursor:pointer;padding:20px;transition:all .3s;border:1px solid transparent" onmouseover="this.style.borderColor='#fed7aa'" onmouseout="this.style.borderColor='transparent'" onclick="generateReport('compliance')">
        <div style="font-size:24px;margin-bottom:8px"><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg></div>
        <div class="sl" style="color:var(--low)">Compliance Audit</div>
        <div style="font-size:12px;color:#334155;margin-top:6px;line-height:1.5">NIST CSF, PCI DSS 4.0, SOC2, and CISA KEV compliance mapping with evidence references.</div>
        <div style="margin-top:10px;font-size:10px;color:#64748b">Format: Markdown (.md)</div>
      </div>
      <div class="sc" style="cursor:pointer;padding:20px;transition:all .3s;border:1px solid transparent" onmouseover="this.style.borderColor='#fed7aa'" onmouseout="this.style.borderColor='transparent'" onclick="generateReport('excel')">
        <div style="font-size:24px;margin-bottom:8px">üìó</div>
        <div class="sl" style="color:var(--low)">Excel Export</div>
        <div style="font-size:12px;color:#334155;margin-top:6px;line-height:1.5">Tab-separated data with CVE, CVSS, VPRS, severity, KEV, dark web, host info. Open in Excel.</div>
        <div style="margin-top:10px;font-size:10px;color:#64748b">Format: TSV (.tsv)</div>
      </div>
      <div class="sc" style="cursor:pointer;padding:20px;transition:all .3s;border:1px solid transparent" onmouseover="this.style.borderColor='#fed7aa'" onmouseout="this.style.borderColor='transparent'" onclick="generateReport('board')">
        <div style="font-size:24px;margin-bottom:8px">üìã</div>
        <div class="sl" style="color:#8b5cf6">Board Briefing</div>
        <div style="font-size:12px;color:#334155;margin-top:6px;line-height:1.5">High-level risk briefing for board presentation. Headlines, action items, and risk trends.</div>
        <div style="margin-top:10px;font-size:10px;color:#64748b">Format: Markdown (.md)</div>
      </div>
      <div class="sc" style="cursor:pointer;padding:20px;transition:all .3s;border:1px solid transparent" onmouseover="this.style.borderColor='#fed7aa'" onmouseout="this.style.borderColor='transparent'" onclick="generateReport('csv')">
        <div style="font-size:24px;margin-bottom:8px">üìÅ</div>
        <div class="sl" style="color:var(--amber)">CSV Raw Data</div>
        <div style="font-size:12px;color:#334155;margin-top:6px;line-height:1.5">Raw CSV export for custom analysis in spreadsheets, SIEM import, or data pipeline ingestion.</div>
        <div style="margin-top:10px;font-size:10px;color:#64748b">Format: CSV (.csv)</div>
      </div>
    </div>
  </div>

  <div class="ft">VulnPilot AI - Agentic Vulnerability Management <strong style="color:var(--orange)">v1.0</strong> ¬∑ <a href="/docs" target="_blank">API Docs</a> ¬∑ <a href="/setup">Setup</a> ¬∑ <span style="color:var(--cyan);cursor:pointer;text-decoration:underline;text-decoration-color:#99f6e4" onclick="showHowItWorks()">How It Works</span> ¬∑ Solvent CyberSecurity ¬∑ <span style="color:var(--cyan);cursor:pointer;text-decoration:underline;text-decoration-color:#99f6e4" onclick="showAgentStatus()">5 AI Agents</span></div>
</div>
</div>

<!-- HOW IT WORKS MODAL -->
<div class="modal-overlay" id="hiwModal" onclick="if(event.target===this)document.getElementById('hiwModal').style.display='none'" style="display:none">
  <div class="modal" style="max-width:600px">
    <div class="modal-head"><h2 style="font-size:16px">How It <span style="color:var(--cyan)">Works</span></h2><button class="modal-close" onclick="document.getElementById('hiwModal').style.display='none'">&times;</button></div>
    <div class="modal-body" style="text-align:center">
      <div style="font-size:12px;color:var(--muted);margin-bottom:20px">100% local. 100% free. Your data never leaves your machine.</div>
      <div style="display:flex;flex-direction:column;align-items:center;gap:0">
        <div style="padding:10px 20px;background:#f0fdfa;border:1px solid #99f6e4;border-radius:8px;font-family:'JetBrains Mono';font-size:12px;color:var(--cyan);font-weight:600;width:100%;box-sizing:border-box">üì• Your Scanner Output (OpenVAS, Nessus, Qualys, CSV)</div>
        <div style="font-size:16px;color:var(--muted);padding:4px 0">‚Üì</div>
        <div style="padding:10px 20px;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;font-family:'JetBrains Mono';font-size:12px;color:var(--orange);font-weight:600;width:100%;box-sizing:border-box">üîç Agent 1 - Enrich from 7 Threat Intel Feeds</div>
        <div style="font-size:9px;color:var(--muted);padding:2px 0">EPSS + CISA KEV + NVD + abuse.ch + OTX + GreyNoise + Shodan</div>
        <div style="font-size:16px;color:var(--muted);padding:4px 0">‚Üì</div>
        <div style="padding:10px 20px;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;font-family:'JetBrains Mono';font-size:12px;color:var(--orange);font-weight:600;width:100%;box-sizing:border-box">üìä Agent 2 - VPRS Scoring (replaces CVSS)</div>
        <div style="font-size:9px;color:var(--muted);padding:2px 0">6 weighted factors: threat intel + KEV + dark web + asset + reachability + controls</div>
        <div style="font-size:16px;color:var(--muted);padding:4px 0">‚Üì</div>
        <div style="padding:10px 20px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;font-family:'JetBrains Mono';font-size:12px;color:var(--crit);font-weight:600;width:100%;box-sizing:border-box">‚öîÔ∏è Agent 3 - Adversarial AI Debate (Lock 2)</div>
        <div style="font-size:9px;color:var(--muted);padding:2px 0">Justifier builds the case - Challenger attacks it - Verdict when both agree</div>
        <div style="font-size:16px;color:var(--muted);padding:4px 0">‚Üì</div>
        <div style="padding:10px 20px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;font-family:'JetBrains Mono';font-size:12px;color:var(--low);font-weight:600;width:100%;box-sizing:border-box">üé´ Agent 4 - Auto-Create Tickets + SLA Assignment</div>
        <div style="font-size:9px;color:var(--muted);padding:2px 0">ServiceNow + Jira + Slack + Teams + Email + PagerDuty</div>
        <div style="font-size:16px;color:var(--muted);padding:4px 0">‚Üì</div>
        <div style="padding:10px 20px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;font-family:'JetBrains Mono';font-size:12px;color:var(--low);font-weight:600;width:100%;box-sizing:border-box">üîî Agent 5 - Drift Watch + Continuous Monitoring</div>
        <div style="font-size:16px;color:var(--muted);padding:4px 0">‚Üì</div>
        <div style="padding:12px 20px;background:linear-gradient(135deg,#fff7ed,#f0fdfa);border:1px solid #fed7aa;border-radius:10px;width:100%;box-sizing:border-box">
          <div style="font-family:'JetBrains Mono';font-size:13px;font-weight:800;color:#0f172a">‚úÖ Prioritized, Debated, Ticketed Queue</div>
          <div style="font-size:10px;color:var(--muted);margin-top:3px">Zero manual triage. You just review and approve.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CVE MODAL -->
<div class="modal-overlay" id="cveModal" onclick="if(event.target===this)closeCveModal()">
  <div class="modal">
    <div class="modal-head"><h2 id="modalCveId">CVE</h2><button class="modal-close" onclick="closeCveModal()">&times;</button></div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>

// CVE Detail Modal
function showHowItWorks(){document.getElementById('hiwModal').style.display='flex';}

async function aiJustifyCve(idx) {
  var v = _aiData.results[idx];
  if (!v) return;
  var body = document.getElementById('modalBody');
  var existing = document.getElementById('aiJustifyResult');
  if (existing) existing.remove();

  var div = document.createElement('div');
  div.id = 'aiJustifyResult';
  div.style.cssText = 'margin-top:12px;padding:14px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px';
  div.innerHTML = '<div style="font-size:12px;font-weight:700;color:var(--low);margin-bottom:8px">ü§ñ Agent 3A (Justifier) - Analyzing...</div><div style="font-size:11px;color:#64748b"><span class="ai-typing"></span> Querying Ollama qwen2.5:7b...</div>';
  body.appendChild(div);

  try {
    var r = await fetch(API + '/ai/justify', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({cve_id:v.cve_id, cvss:v.cvss_score, vprs:v.vprs_score, severity:v.severity, in_kev:v.in_kev, dark_web_mentions:v.dark_web_mentions, asset_tier:v.asset_tier||'standard', is_internet_facing:v.is_internet_facing})
    });
    var d = await r.json();
    if (d.ok) {
      div.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:12px;font-weight:700;color:var(--low)">ü§ñ Agent 3A (Justifier)</div><span style="font-size:9px;padding:3px 8px;background:#f0fdf4;color:var(--low);border-radius:4px">qwen2.5:7b ¬∑ confidence '+(d.confidence*100).toFixed(0)+'%</span></div><div style="font-size:12px;color:#334155;line-height:1.6">'+d.justification.replace(/\n/g,'<br>')+'</div>';
    } else {
      div.innerHTML = '<div style="font-size:12px;color:var(--crit)">ü§ñ Agent 3A: '+( d.error||'AI provider not available - check provider status in the AI bar above')+'</div>';
    }
  } catch(e) {
    div.innerHTML = '<div style="font-size:12px;color:var(--crit)">ü§ñ Agent 3A: Ollama not reachable. Make sure Ollama is running with qwen2.5:7b model.</div>';
  }
}

async function aiDebateCve(idx) {
  var v = _aiData.results[idx];
  if (!v) return;
  var body = document.getElementById('modalBody');
  var existing = document.getElementById('aiDebateResult');
  if (existing) existing.remove();

  var div = document.createElement('div');
  div.id = 'aiDebateResult';
  div.style.cssText = 'margin-top:12px;padding:14px;background:#f5f3ff;border:1px solid #ddd6fe;border-radius:10px';
  div.innerHTML = '<div style="font-size:12px;font-weight:700;color:#8b5cf6;margin-bottom:8px">‚öîÔ∏è Adversarial Debate - Lock 2 in Progress...</div><div style="font-size:11px;color:#64748b"><span class="ai-typing"></span> Agent 3A (Justifier) analyzing... then Agent 3B (Challenger) will attack the reasoning...</div>';
  body.appendChild(div);

  try {
    // Step 1: Get justification from primary provider
    var r1 = await fetch(API + '/ai/justify', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({cve_id:v.cve_id, cvss:v.cvss_score, vprs:v.vprs_score, severity:v.severity, in_kev:v.in_kev, dark_web_mentions:v.dark_web_mentions, asset_tier:v.asset_tier||'standard', is_internet_facing:v.is_internet_facing, provider: _activeProvider})
    });
    var d1 = await r1.json();
    if (!d1.ok) { div.innerHTML = '<div style="color:var(--crit)">Agent 3A failed: '+(d1.error||'AI provider not available')+'</div>'; return; }

    // Step 2: Challenge with challenger provider (ideally different)
    div.innerHTML = '<div style="font-size:12px;font-weight:700;color:#8b5cf6;margin-bottom:8px">‚öîÔ∏è Adversarial Debate - Lock 2</div><div style="font-size:11px;color:#64748b"><span class="ai-typing"></span> Agent 3A done ('+(d1.provider||_activeProvider)+'). Agent 3B challenging...</div>';

    var r2 = await fetch(API + '/ai/challenge', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({cve_id:v.cve_id, vprs:v.vprs_score, justification:d1.justification})
    });
    var d2 = await r2.json();

    // Determine if cross-model (different providers)
    var prov3a = d1.provider || _activeProvider;
    var prov3b = d2.provider || _activeProvider;
    var isCrossModel = prov3a !== prov3b;
    var provIcons = {ollama:'ü¶ô', anthropic:'üü†', openai:'üü¢'};
    var provNames = {ollama:'Ollama', anthropic:'Claude', openai:'GPT-4o'};

    var html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
    html += '<div style="font-size:13px;font-weight:700;color:#8b5cf6">‚öîÔ∏è Adversarial Debate - Lock 2 Complete</div>';
    if (isCrossModel) {
      html += '<span style="font-size:10px;padding:3px 10px;background:#f5f3ff;color:#8b5cf6;border-radius:6px;font-weight:700">üî• CROSS-MODEL: '+(provNames[prov3a]||prov3a)+' vs '+(provNames[prov3b]||prov3b)+'</span>';
    } else {
      html += '<span style="font-size:10px;padding:3px 10px;background:#f5f3ff;color:var(--muted);border-radius:6px">SELF-DEBATE: '+(provNames[prov3a]||prov3a)+'</span>';
    }
    html += '</div>';

    // Agent 3A result with provider badge
    html += '<div style="padding:10px;background:#f0fdf4;border-left:3px solid var(--low);border-radius:6px;margin-bottom:10px">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
    html += '<div style="font-size:11px;font-weight:700;color:var(--low)">ü§ñ Agent 3A - Justifier</div>';
    html += '<span style="font-size:9px;padding:2px 8px;background:#f0fdf4;color:var(--low);border-radius:4px">'+(provIcons[prov3a]||'ü§ñ')+' '+(d1.model||provNames[prov3a]||prov3a)+' ¬∑ confidence '+(d1.confidence*100).toFixed(0)+'%</span>';
    html += '</div>';
    html += '<div style="font-size:12px;color:#334155;line-height:1.5">'+d1.justification.replace(/\n/g,'<br>')+'</div></div>';

    // Agent 3B result with provider badge
    if (d2.ok) {
      var verdictColor = d2.verdict === 'AGREE' ? 'var(--low)' : 'var(--crit)';
      html += '<div style="padding:10px;background:#f5f3ff;border-left:3px solid #8b5cf6;border-radius:6px;margin-bottom:10px">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
      html += '<div style="font-size:11px;font-weight:700;color:#8b5cf6"><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> Agent 3B - Challenger</div>';
      html += '<div style="display:flex;gap:6px;align-items:center">';
      html += '<span style="font-size:9px;padding:2px 8px;background:#f5f3ff;color:#8b5cf6;border-radius:4px">'+(provIcons[prov3b]||'ü§ñ')+' '+(d2.model||provNames[prov3b]||prov3b)+'</span>';
      html += '<span style="font-size:10px;padding:2px 8px;background:'+(d2.verdict==='AGREE'?'#f0fdf4':'#fef2f2')+';color:'+verdictColor+';border-radius:4px;font-weight:700">'+d2.verdict+'</span>';
      html += '</div></div>';
      html += '<div style="font-size:12px;color:#334155;line-height:1.5">'+d2.challenge.replace(/\n/g,'<br>')+'</div></div>';

      // Verdict box
      html += '<div style="padding:10px 14px;background:#f0fdfa;border:1px solid #99f6e4;border-radius:8px;font-size:11px;color:var(--cyan)">';
      if (d2.verdict === 'AGREE') {
        html += '<strong>‚úÖ Consensus:</strong> Both agents agree - VPRS '+v.vprs_score.toFixed(1)+' confirmed.';
        if (isCrossModel) html += '<br><span style="color:#64748b">Two different AI architectures ('+(provNames[prov3a]||prov3a)+' + '+(provNames[prov3b]||prov3b)+') independently reached the same conclusion. High confidence.</span>';
      } else {
        html += '<strong>‚ö†Ô∏è Disagreement:</strong> Agents disagree by '+Math.abs(d2.score_delta)+' pts - flagged for human review.';
        html += '<br><strong>Resolution rule:</strong> Higher score wins (biased toward caution). Current VPRS: '+v.vprs_score.toFixed(1);
        if (isCrossModel) html += '<br><span style="color:#64748b">Cross-model disagreement ('+(provNames[prov3a]||prov3a)+' vs '+(provNames[prov3b]||prov3b)+') indicates genuine uncertainty. Review recommended.</span>';
      }
      html += '</div>';
    } else {
      html += '<div style="color:var(--crit)">Agent 3B failed: '+(d2.error||'unknown')+'</div>';
    }

    div.innerHTML = html;
  } catch(e) {
    div.innerHTML = '<div style="color:var(--crit)">Debate failed: AI provider not reachable. Check provider health in the AI bar.</div>';
  }
}

function showCveDetail(idx) {
  if(!_aiData||!_aiData.results) return;
  var v = _aiData.results[idx];
  if(!v) return;
  document.getElementById('modalCveId').textContent = v.cve_id;
  var sev = (v.severity||'INFO').toUpperCase();
  var comps = v.components||{};
  var compColors = {epss:'#3b82f6',kev:'#ef4444',dark_web:'#8b5cf6',asset:'#06b6d4',reachability:'#f97316',controls:'#22c55e'};
  var compNames = {epss:'EPSS',kev:'KEV',dark_web:'Dark Web',asset:'Asset Crit.',reachability:'Reachability',controls:'Controls'};
  var html = '<div class="detail-grid">';
  html += '<div class="detail-item"><div class="detail-label">VPRS Score</div><div class="detail-val" style="color:'+severityColor(sev)+';font-size:22px">'+v.vprs_score.toFixed(1)+'</div></div>';
  html += '<a href="https://nvd.nist.gov/vuln/detail/'+v.cve_id+'" target="_blank" class="detail-item" style="text-decoration:none;cursor:pointer;transition:all .2s;border-color:#d1d5db" onmouseover="this.style.borderColor=\'#f97316\'" onmouseout="this.style.borderColor=\'#d1d5db\'"><div class="detail-label">CVSS Score ¬∑ <span style="color:#ea580c">NVD ‚Üó</span></div><div class="detail-val" style="color:#64748b">'+v.cvss_score.toFixed(1)+'</div>'+(v.title?'<div style="font-size:11px;color:#64748b;margin-top:6px;line-height:1.4;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical">'+v.title+'</div>':'')+'</a>';
  html += '</div>';

  // ‚ïê‚ïê‚ïê FLIP / ALIGNED INTELLIGENCE BADGE ‚ïê‚ïê‚ïê
  var scoreDiff = Math.abs(v.vprs_score - v.cvss_score * 10);
  var isFlip = v.cvss_vs_vprs_flip || scoreDiff > 30;
  var vprsUp = v.vprs_score > (v.cvss_score * 10);

  // Build plain-English reasons
  var reasons = [];
  if (v.in_kev) reasons.push('CISA KEV confirmed exploited');
  if (v.epss_score > 0.5) reasons.push('EPSS ' + (v.epss_score*100).toFixed(0) + '% exploit probability');
  else if (v.epss_score < 0.05) reasons.push('EPSS only ' + (v.epss_score*100).toFixed(2) + '% ‚Äî low exploit likelihood');
  if (v.dark_web_mentions > 5) reasons.push(v.dark_web_mentions + ' dark web IoCs detected');
  else if (v.dark_web_mentions === 0) reasons.push('Zero dark web activity');
  if (v.is_internet_facing) reasons.push('Internet-facing asset');
  else reasons.push('Internal/not internet-facing');
  if (v.hard_rule) {
    var ruleExplain = {
      'kev_always_critical': 'Hard rule: KEV = always CRITICAL',
      'ransomware_critical': 'Hard rule: Ransomware association = CRITICAL',
      'exploit_for_sale_critical': 'Hard rule: Exploit for sale = CRITICAL',
      'high_epss_internet_facing': 'Hard rule: High EPSS + internet-facing',
      'no_signals_floor': 'Hard rule: No threat signals ‚Üí score floored'
    };
    if (ruleExplain[v.hard_rule]) reasons.push(ruleExplain[v.hard_rule]);
  }

  if (isFlip) {
    var flipDir = vprsUp ? 'VPRS ‚Üë above CVSS' : 'VPRS ‚Üì below CVSS';
    var flipWhy = vprsUp
      ? 'Real-world threat intel elevated this beyond its CVSS rating.'
      : 'Despite a high CVSS, real-world signals show low active risk.';
    html += '<div style="background:linear-gradient(135deg,#fef2f2,#fff7ed);border:1px solid #fecaca;border-radius:10px;padding:14px 16px;margin-bottom:14px">'
      + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'
      + '<span style="background:#ef4444;color:#fff;font-size:11px;font-weight:800;padding:3px 10px;border-radius:6px;letter-spacing:1px">‚ö° FLIP</span>'
      + '<span style="font-size:14px;font-weight:700;color:#dc2626">' + flipDir + '</span>'
      + '<span style="font-size:12px;color:#64748b;margin-left:auto">CVSS ' + v.cvss_score.toFixed(1) + ' ‚Üí VPRS ' + v.vprs_score.toFixed(1) + '</span>'
      + '</div>'
      + '<div style="font-size:13px;color:#334155;line-height:1.6;margin-bottom:8px">' + flipWhy + '</div>'
      + '<div style="font-size:12px;color:#64748b;line-height:1.6">' + reasons.map(function(r){return '‚Ä¢ ' + r}).join('<br>') + '</div>'
      + '</div>';
  } else {
    html += '<div style="background:linear-gradient(135deg,#f0fdf4,#eff6ff);border:1px solid #bbf7d0;border-radius:10px;padding:14px 16px;margin-bottom:14px">'
      + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'
      + '<span style="background:#16a34a;color:#fff;font-size:11px;font-weight:800;padding:3px 10px;border-radius:6px;letter-spacing:1px">‚úì ALIGNED</span>'
      + '<span style="font-size:14px;font-weight:700;color:#16a34a">VPRS confirms CVSS assessment</span>'
      + '</div>'
      + '<div style="font-size:13px;color:#334155;line-height:1.6;margin-bottom:8px">Threat intelligence corroborates the CVSS severity rating. VPRS and CVSS agree on risk level.</div>'
      + '<div style="font-size:12px;color:#64748b;line-height:1.6">' + reasons.map(function(r){return '‚Ä¢ ' + r}).join('<br>') + '</div>'
      + '</div>';
  }

  html += '<div class="detail-grid">';
  html += '<div class="detail-item"><div class="detail-label">Severity</div><div class="detail-val"><span class="severity-badge '+sev+'" style="font-size:12px;padding:3px 10px">'+sev+'</span></div></div>';
  html += '<div class="detail-item"><div class="detail-label">EPSS</div><div class="detail-val" style="color:var(--cyan)">'+(v.epss_score?(v.epss_score*100).toFixed(2)+'%':'N/A')+'</div></div>';
  html += '<div class="detail-item"><div class="detail-label">CISA KEV</div><div class="detail-val">'+(v.in_kev?'<span style="color:var(--crit)">‚ö†Ô∏è YES - Exploited</span>':'<span style="color:var(--low)">No</span>')+'</div></div>';
  html += '<div class="detail-item"><div class="detail-label">Dark Web</div><div class="detail-val" style="color:'+(v.dark_web_mentions>0?'var(--high)':'var(--muted)')+'">'+(v.dark_web_mentions||0)+' IoCs</div></div>';
  html += '<div class="detail-item"><div class="detail-label">Host</div><div class="detail-val" style="font-size:11px;color:#64748b">'+(v.hostname||'?')+' ¬∑ '+(v.ip_address||'-')+'</div></div>';
  html += '<div class="detail-item"><div class="detail-label">Asset Tier</div><div class="detail-val" style="font-size:11px;color:var(--amber)">'+(v.asset_tier||'?').replace('_',' ').toUpperCase()+'</div></div>';
  html += '<div class="detail-item"><div class="detail-label">Internet Facing</div><div class="detail-val">'+(v.is_internet_facing?'<span style="color:var(--crit)">üåê YES</span>':'<span style="color:var(--low)">No</span>')+'</div></div>';
  html += '<div class="detail-item"><div class="detail-label">Hard Rule</div><div class="detail-val" style="font-size:11px;color:var(--orange)">'+(v.hard_rule||'none')+'</div></div>';
  html += '</div>';

  // ‚ïê‚ïê‚ïê VULNPILOT VERDICT - Plain English Summary ‚ïê‚ïê‚ïê
  var verdictIcon, verdictColor, verdictBg, verdictBorder, verdictTitle, verdictText, verdictAction;

  if (v.is_noise) {
    verdictIcon = 'üîá'; verdictColor = '#64748b'; verdictBg = '#f1f5f9'; verdictBorder = '#cbd5e1';
    verdictTitle = 'NOISE ‚Äî Safe to Deprioritize';
    verdictText = 'VulnPilot eliminated this CVE as noise. No real-world threat signals, low exploit probability, and no active exploitation detected. Your team does not need to act on this.';
    verdictAction = 'Action: No patch needed. Revisit only if threat landscape changes.';
  } else if (isFlip && !vprsUp) {
    // FLIP DOWN ‚Äî CVSS high but VPRS low
    verdictIcon = 'üìâ'; verdictColor = '#0f766e'; verdictBg = '#f0fdfa'; verdictBorder = '#99f6e4';
    verdictTitle = 'DEPRIORITIZED ‚Äî CVSS Overstates Real Risk';
    verdictText = v.cve_id + ' has CVSS ' + v.cvss_score.toFixed(1) + ' (' + (v.cvss_score >= 9 ? 'Critical' : v.cvss_score >= 7 ? 'High' : 'Medium') + ' on paper) but VulnPilot scored it ' + v.vprs_score.toFixed(1) + ' (' + sev + ') because nobody is actually exploiting it. ';
    if (v.epss_score < 0.05) verdictText += 'EPSS gives it only ' + (v.epss_score*100).toFixed(2) + '% exploit probability. ';
    if (!v.in_kev) verdictText += 'Not in CISA KEV. ';
    if (v.dark_web_mentions === 0) verdictText += 'Zero dark web mentions. ';
    if (!v.is_internet_facing) verdictText += 'Not internet-facing. ';
    verdictText += 'This is exactly the kind of CVE that wastes patching cycles when teams rely only on CVSS.';
    var days = sev === 'LOW' ? '90' : sev === 'MEDIUM' ? '30' : '14';
    verdictAction = 'Action: Patch within ' + days + ' days. Not urgent ‚Äî focus on higher-VPRS items first.';
  } else if (isFlip && vprsUp) {
    // FLIP UP ‚Äî CVSS low but VPRS high
    verdictIcon = 'üö®'; verdictColor = '#dc2626'; verdictBg = '#fef2f2'; verdictBorder = '#fecaca';
    verdictTitle = 'ESCALATED ‚Äî Real Risk Exceeds CVSS Rating';
    verdictText = v.cve_id + ' looks like a ' + (v.cvss_score < 5 ? 'Low' : 'Medium') + ' (CVSS ' + v.cvss_score.toFixed(1) + ') but VulnPilot escalated it to ' + sev + ' (VPRS ' + v.vprs_score.toFixed(1) + '). ';
    if (v.in_kev) verdictText += 'CISA confirms active exploitation in the wild. ';
    if (v.epss_score > 0.5) verdictText += 'EPSS predicts ' + (v.epss_score*100).toFixed(0) + '% exploit probability. ';
    if (v.dark_web_mentions > 0) verdictText += v.dark_web_mentions + ' dark web IoCs found ‚Äî attackers are actively trading this exploit. ';
    if (v.is_internet_facing) verdictText += 'This asset is internet-facing. ';
    verdictText += 'Teams relying only on CVSS would miss this entirely.';
    verdictAction = 'Action: Patch immediately within 24 hours. This is actively being exploited.';
  } else if (sev === 'CRITICAL') {
    // ALIGNED CRITICAL
    verdictIcon = 'üî¥'; verdictColor = '#dc2626'; verdictBg = '#fef2f2'; verdictBorder = '#fecaca';
    verdictTitle = 'CRITICAL ‚Äî Immediate Action Required';
    verdictText = 'Both CVSS and VPRS agree: ' + v.cve_id + ' is Critical. ';
    if (v.in_kev) verdictText += 'Confirmed actively exploited (CISA KEV). ';
    if (v.epss_score > 0.5) verdictText += 'High exploit probability (' + (v.epss_score*100).toFixed(0) + '%). ';
    if (v.dark_web_mentions > 0) verdictText += v.dark_web_mentions + ' dark web IoCs. ';
    verdictText += 'All threat signals confirm this is a genuine, urgent risk.';
    verdictAction = 'Action: Patch within 24 hours (P1 SLA). Ticket auto-created.';
  } else if (sev === 'HIGH') {
    verdictIcon = 'üü†'; verdictColor = '#ea580c'; verdictBg = '#fff7ed'; verdictBorder = '#fed7aa';
    verdictTitle = 'HIGH ‚Äî Prioritize This Week';
    verdictText = v.cve_id + ' is confirmed High risk with real-world threat signals backing the score. ';
    if (v.dark_web_mentions > 0) verdictText += v.dark_web_mentions + ' dark web mentions detected. ';
    if (v.is_internet_facing) verdictText += 'Internet-facing exposure increases urgency. ';
    verdictAction = 'Action: Patch within 72 hours (P2 SLA).';
  } else if (sev === 'MEDIUM') {
    verdictIcon = 'üü°'; verdictColor = '#b45309'; verdictBg = '#fffbeb'; verdictBorder = '#fde68a';
    verdictTitle = 'MEDIUM ‚Äî Scheduled Patching';
    verdictText = v.cve_id + ' poses moderate risk. Some threat signals present but no active exploitation confirmed.';
    verdictAction = 'Action: Patch within 14 days (P3 SLA).';
  } else {
    verdictIcon = 'üü¢'; verdictColor = '#16a34a'; verdictBg = '#f0fdf4'; verdictBorder = '#bbf7d0';
    verdictTitle = 'LOW ‚Äî Monitor Only';
    verdictText = v.cve_id + ' has minimal real-world risk. No active exploitation, low EPSS, no dark web activity.';
    verdictAction = 'Action: Patch within 90 days or next maintenance window.';
  }

  html += '<div style="background:' + verdictBg + ';border:1px solid ' + verdictBorder + ';border-left:4px solid ' + verdictColor + ';border-radius:10px;padding:16px 18px;margin-bottom:16px">'
    + '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">'
    + '<span style="font-size:18px">' + verdictIcon + '</span>'
    + '<span style="font-size:14px;font-weight:800;color:' + verdictColor + ';letter-spacing:0.5px">VULNPILOT VERDICT: ' + verdictTitle + '</span>'
    + '</div>'
    + '<div style="font-size:13px;color:#334155;line-height:1.7;margin-bottom:10px">' + verdictText + '</div>'
    + '<div style="font-size:12px;font-weight:700;color:' + verdictColor + ';padding:8px 12px;background:rgba(255,255,255,0.6);border-radius:6px;display:inline-block">' + verdictAction + '</div>'
    + '</div>';

  if(v.title) html += '';  // Description now shown inside CVSS card
  html += '<div style="margin-bottom:16px"><div class="detail-label" style="margin-bottom:8px">VPRS Components</div>';
  for(var key in compNames){var val=comps[key]||0;html+='<div class="comp-row"><span class="comp-name">'+compNames[key]+'</span><div class="comp-bar-bg"><div class="comp-bar-fill" style="width:'+val+'%;background:'+compColors[key]+'"></div></div><span class="comp-val">'+val.toFixed(1)+'</span></div>';}
  html += '</div>';

  html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
  html += '<span style="background:#f0fdf4;color:var(--low);font-size:11px;padding:6px 14px;border-radius:6px;cursor:pointer;font-weight:600" onclick="aiJustifyCve('+idx+')">ü§ñ AI Justify</span>';
  html += '<span style="background:#f5f3ff;color:#8b5cf6;font-size:11px;padding:6px 14px;border-radius:6px;cursor:pointer;font-weight:600" onclick="aiDebateCve('+idx+')">‚öîÔ∏è Adversarial Debate</span>';
  html += '<a href="https://nvd.nist.gov/vuln/detail/'+v.cve_id+'" target="_blank" style="background:#eff6ff;color:var(--blue);font-size:11px;padding:6px 14px;border-radius:6px;text-decoration:none;font-weight:600">üîó NVD</a>';
  if(v.in_kev) html += '<a href="https://www.cisa.gov/known-exploited-vulnerabilities-catalog" target="_blank" style="background:#fef2f2;color:#dc2626;font-size:11px;padding:6px 14px;border-radius:6px;text-decoration:none;font-weight:600"><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> CISA KEV</a>';
  html += '<span style="background:#fff7ed;color:var(--orange);font-size:11px;padding:6px 14px;border-radius:6px;cursor:pointer;font-weight:600" onclick="closeCveModal()">‚úï Close</span>';
  html += '</div>';
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('cveModal').classList.add('show');
  askAboutCve(v.cve_id);
}
function closeCveModal(){document.getElementById('cveModal').classList.remove('show');}
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeCveModal();});

// ‚ïê‚ïê‚ïê DEBATE TOP CVEs - Live Proof for Customer Demo ‚ïê‚ïê‚ïê
async function debateTopCves(count) {
  if (!_aiData || !_aiData.results || _aiData.results.length === 0) {
    alert('Load vulnerability data first (Live Data or Demo Data)');
    return;
  }

  var btn = document.getElementById('debateTop5Btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Running Debate...';

  var log = document.getElementById('debateLog');
  var summary = document.getElementById('debateSummary');
  log.style.display = 'block';
  log.innerHTML = '';
  summary.style.display = 'none';

  // Sort by VPRS (highest risk first) and take top N
  var sorted = _aiData.results.slice().filter(function(v){ return v.vprs_score > 0; }).sort(function(a,b){ return (b.vprs_score||0) - (a.vprs_score||0); });
  if (sorted.length === 0) {
    log.innerHTML = '<span style="color:var(--orange)">‚ö†Ô∏è No scored CVEs found. Run scoring first (Load Demo Data or Live Data), then try again.</span>';
    btn.disabled = false; btn.textContent = '‚öîÔ∏è Debate Top 5 Critical CVEs';
    return;
  }
  var targets = sorted.slice(0, Math.min(count, sorted.length));
  var provIcons = {ollama:'ü¶ô', anthropic:'üü†', openai:'üü¢'};
  var provIcon = provIcons[_activeProvider] || 'ü§ñ';

  function logLine(html) {
    log.innerHTML += '<div>' + html + '</div>';
    log.scrollTop = log.scrollHeight;
  }

  logLine('<span style="color:#8b5cf6;font-weight:700">‚öîÔ∏è LOCK 2 ADVERSARIAL DEBATE - ' + targets.length + ' CVEs</span>');
  logLine('<span style="color:#64748b">' + new Date().toLocaleTimeString() + ' | Provider: ' + provIcon + ' ' + _activeProvider + '</span>');
  logLine('<span style="color:#64748b">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>');

  var results = [];
  var agrees = 0, challenges = 0, errors = 0;

  for (var i = 0; i < targets.length; i++) {
    var v = targets[i];
    var sev = (v.severity||'INFO').toUpperCase();
    var sevColor = sev === 'CRITICAL' ? 'var(--crit)' : sev === 'HIGH' ? 'var(--high)' : 'var(--med)';

    logLine('<br><span style="color:var(--cyan);font-weight:700">[' + (i+1) + '/' + targets.length + '] ' + v.cve_id + '</span> <span style="color:' + sevColor + '">' + sev + '</span> VPRS:<span style="color:var(--orange)">' + v.vprs_score.toFixed(1) + '</span>');

    // Step 1: Justifier (Agent 3A)
    logLine('<span style="color:var(--low)">  ‚Üí Agent 3A (Justifier) analyzing...</span>');
    try {
      var r1 = await fetch(API + '/ai/justify', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          cve_id: v.cve_id, cvss: v.cvss_score, vprs: v.vprs_score,
          severity: v.severity, in_kev: v.in_kev,
          dark_web_mentions: v.dark_web_mentions,
          asset_tier: v.asset_tier || 'standard',
          is_internet_facing: v.is_internet_facing,
          provider: _activeProvider
        })
      });
      var d1 = await r1.json();

      if (!d1.ok) {
        logLine('<span style="color:var(--crit)">  ‚úó Agent 3A failed: ' + (d1.error||'unknown') + '</span>');
        errors++;
        continue;
      }

      var justifPreview = (d1.justification || '').substring(0, 120).replace(/</g,'&lt;');
      logLine('<span style="color:var(--low)">  ‚úì 3A (' + (d1.provider||_activeProvider) + '): </span><span style="color:#64748b">' + justifPreview + '...</span>');

      // Step 2: Challenger (Agent 3B)
      logLine('<span style="color:#8b5cf6">  ‚Üí Agent 3B (Challenger) attacking...</span>');

      var r2 = await fetch(API + '/ai/challenge', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          cve_id: v.cve_id, vprs: v.vprs_score,
          justification: d1.justification
        })
      });
      var d2 = await r2.json();

      if (!d2.ok) {
        logLine('<span style="color:var(--crit)">  ‚úó Agent 3B failed: ' + (d2.error||'unknown') + '</span>');
        errors++;
        continue;
      }

      var challengePreview = (d2.challenge || '').substring(0, 120).replace(/</g,'&lt;');
      var isCrossModel = (d1.provider||_activeProvider) !== (d2.provider||_activeProvider);

      if (d2.verdict === 'AGREE') {
        agrees++;
        logLine('<span style="color:#8b5cf6">  ‚úì 3B (' + (d2.provider||'default') + '): </span><span style="color:#64748b">' + challengePreview + '...</span>');
        logLine('<span style="color:var(--low);font-weight:700">  ‚úÖ VERDICT: AGREE - VPRS ' + v.vprs_score.toFixed(1) + ' confirmed</span>' +
          (isCrossModel ? ' <span style="color:#8b5cf6;font-size:9px">üî• CROSS-MODEL</span>' : ''));
      } else {
        challenges++;
        logLine('<span style="color:#8b5cf6">  ‚úì 3B (' + (d2.provider||'default') + '): </span><span style="color:#64748b">' + challengePreview + '...</span>');
        logLine('<span style="color:var(--crit);font-weight:700">  ‚ö†Ô∏è VERDICT: CHALLENGE - disagree by ' + Math.abs(d2.score_delta).toFixed(1) + ' pts ‚Üí flagged for review</span>' +
          (isCrossModel ? ' <span style="color:#8b5cf6;font-size:9px">üî• CROSS-MODEL</span>' : ''));
      }

      results.push({
        cve: v.cve_id,
        severity: sev,
        vprs: v.vprs_score,
        verdict: d2.verdict,
        delta: d2.score_delta,
        justifier_provider: d1.provider || _activeProvider,
        challenger_provider: d2.provider || _activeProvider,
        cross_model: isCrossModel
      });

    } catch(e) {
      logLine('<span style="color:var(--crit)">  ‚úó Error: ' + e.message + '</span>');
      errors++;
    }
  }

  // Summary
  logLine('<br><span style="color:#64748b">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</span>');
  logLine('<span style="color:#8b5cf6;font-weight:700">‚öîÔ∏è DEBATE COMPLETE</span> ' + new Date().toLocaleTimeString());

  summary.style.display = 'block';
  var crossCount = results.filter(function(r){return r.cross_model}).length;
  summary.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:12px;justify-content:space-around;margin-bottom:8px">'
    + '<div style="text-align:center"><div style="font-size:20px;font-weight:900;color:#8b5cf6">' + results.length + '</div><div style="font-size:10px;color:#64748b">CVEs Debated</div></div>'
    + '<div style="text-align:center"><div style="font-size:20px;font-weight:900;color:var(--low)">' + agrees + '</div><div style="font-size:10px;color:#64748b">Agreed ‚úÖ</div></div>'
    + '<div style="text-align:center"><div style="font-size:20px;font-weight:900;color:var(--crit)">' + challenges + '</div><div style="font-size:10px;color:#64748b">Challenged ‚ö†Ô∏è</div></div>'
    + (crossCount > 0 ? '<div style="text-align:center"><div style="font-size:20px;font-weight:900;color:#8b5cf6">' + crossCount + '</div><div style="font-size:10px;color:#64748b">üî• Cross-Model</div></div>' : '')
    + (errors > 0 ? '<div style="text-align:center"><div style="font-size:20px;font-weight:900;color:var(--crit)">' + errors + '</div><div style="font-size:10px;color:#64748b">Errors</div></div>' : '')
    + '</div>';

  if (challenges > 0) {
    summary.innerHTML += '<div style="font-size:11px;color:var(--orange);margin-top:4px">‚ö†Ô∏è ' + challenges + ' CVE(s) had Agent disagreement - these need human review. Higher score wins (safety bias).</div>';
  }
  if (agrees === results.length && results.length > 0) {
    summary.innerHTML += '<div style="font-size:11px;color:var(--low);margin-top:4px">‚úÖ All ' + agrees + ' CVEs passed adversarial validation - both AI agents independently confirmed every score.</div>';
  }

  btn.disabled = false;
  btn.textContent = '‚öîÔ∏è Debate Top 5 Critical CVEs';
}

// AI Protection Advice triggered by CVE click
function askAboutCve(cveId) {
  var v = (_aiData&&_aiData.results||[]).find(function(r){return r.cve_id===cveId;});
  if(!v) return;
  var sev = (v.severity||'INFO').toUpperCase();
  document.getElementById('aiQuery').value = 'How to protect against '+cveId+'?';
  var resp = document.getElementById('aiResponse');
  var body = document.getElementById('aiResponseBody');
  resp.classList.add('active');
  var a = '<strong><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> Protection Guide: <span class="metric">'+cveId+'</span></strong><br><br>';
  a += '<strong>Risk:</strong> VPRS <span style="color:'+severityColor(sev)+';font-weight:700">'+v.vprs_score.toFixed(1)+'</span> | CVSS '+v.cvss_score.toFixed(1)+' | '+sev;
  if(v.in_kev) a += ' | <span class="crit">‚ö†Ô∏è CISA KEV - actively exploited</span>';
  if(v.dark_web_mentions>0) a += ' | <span class="warn">üïµÔ∏è '+v.dark_web_mentions+' dark web IoCs</span>';
  a += '<br><br><strong>üîß Remediation:</strong><br>';
  if(v.in_kev) a += '‚Ä¢ <span class="crit">URGENT:</span> CISA KEV - patch within <strong>24 hours</strong> per BOD 22-01<br>';
  a += '‚Ä¢ Apply vendor patches on <strong>'+(v.hostname||'affected hosts')+'</strong> immediately<br>';
  if(v.is_internet_facing) a += '‚Ä¢ <span class="warn">Internet-facing</span> - block external access until patched<br>';
  a += '‚Ä¢ Verify patch across all '+(v.asset_tier||'').replace('_',' ')+' assets<br>';
  a += '<br><strong><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> Compensating Controls:</strong><br>';
  a += '‚Ä¢ Deploy WAF/IPS signatures for '+cveId+'<br>';
  a += '‚Ä¢ Enable enhanced logging on affected hosts<br>';
  if(v.is_internet_facing) a += '‚Ä¢ Network segmentation for internet-facing systems<br>';
  a += '‚Ä¢ Restrict privileges on vulnerable systems<br>';
  if(v.dark_web_mentions>0) a += '‚Ä¢ Monitor threat feeds - <strong>'+v.dark_web_mentions+' active IoCs</strong><br>';
  a += '<br><strong>üîç Detection:</strong><br>';
  a += '‚Ä¢ SIEM rule: alert on exploit signatures for '+cveId+'<br>';
  a += '‚Ä¢ Scan policy: flag unpatched instances<br>';
  if(v.epss_score>0.1) a += '‚Ä¢ <span class="warn">High EPSS ('+(v.epss_score*100).toFixed(1)+'%)</span> - daily scan frequency<br>';
  a += '<br><strong>üìã Status:</strong> '+(v.ticket_created?'üé´ Ticket auto-created with SLA':'Below ticket threshold');
  if(v.hard_rule) a += ' | Rule: <span class="metric">'+v.hard_rule+'</span>';
  body.innerHTML = a;
  document.querySelector('.ai-dock').scrollIntoView({behavior:'smooth',block:'nearest'});
}

// Integration checker
async function checkIntegrations(){
  var tests=[['epss','epss'],['kev','kev'],['nvd','nvd'],['abuse','abusech'],['ollama','ollama'],['console','console'],['csv','cmdb_csv'],['nessus','nessus_file']];
  for(var i=0;i<tests.length;i++){try{var r=await fetch(API+'/integrations/test/'+tests[i][1],{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});var d=await r.json();var dot=document.getElementById('d-'+tests[i][0]);if(dot)dot.className=d.ok?'dot on':'dot off';}catch(e){}}
}
setTimeout(checkIntegrations,2000);

// Tab switching
function switchTab(name, el) {
  document.querySelectorAll('.ntab').forEach(t => t.classList.remove('act'));
  document.querySelectorAll('.tc').forEach(t => t.classList.remove('act'));
  if(el) el.classList.add('act');
  var tab = document.getElementById('tab-'+name);
  if(tab) tab.classList.add('act');
  if(name==='charts'&&_aiData){buildSeverityChart(_aiData.stats||{});buildScatterChart(_aiData.results||[]);buildComponentChart((_aiData.results||[]).filter(v=>!v.is_noise).slice(0,10));}
}

const API = '/api/v1';

function severityColor(s) {
  const c = { CRITICAL:'var(--critical)', HIGH:'var(--high)', MEDIUM:'var(--medium)', LOW:'var(--low)', INFO:'var(--info)' };
  return c[s] || 'var(--text-muted)';
}

// ‚ïê‚ïê‚ïê HEALTH ‚ïê‚ïê‚ïê
async function checkHealth() {
  try {
    const r = await fetch(`${API}/health`);
    const d = await r.json();
    document.getElementById('statusDot').style.background = '#22c55e';
    document.getElementById('statusText').textContent = 'Online ¬∑ Local ¬∑ ü¶ô Ollama';
    document.getElementById('statusText').style.color = 'var(--low)';
    document.getElementById('systemInfo').innerHTML =
      `Mode: ${d.mode || 'local'}<br>LLM: ${d.llm_provider || 'ollama'}<br>Scanner: ${d.scanner_providers || '-'}<br>Tickets: ${d.ticket_provider || 'console'}`;
  } catch(e) {
    document.getElementById('statusDot').style.background = '#22c55e';
    document.getElementById('statusText').textContent = 'Local ¬∑ ü¶ô Ollama';
    document.getElementById('statusText').style.color = 'var(--low)';
  }
}

// ‚ïê‚ïê‚ïê WEIGHTS ‚ïê‚ïê‚ïê
async function loadWeights() {
  try {
    const r = await fetch(`${API}/config/weights`);
    const w = await r.json();
    const names = {
      threat_intelligence: 'Threat Intel (EPSS)', kev_membership: 'CISA KEV',
      dark_web_exposure: 'Dark Web Exposure', asset_criticality: 'Asset Criticality',
      reachability: 'Reachability / Exposure', controls: 'Compensating Controls'
    };
    const list = document.getElementById('weightsList');
    if (list) {
      list.innerHTML = '';
      for (const [key, val] of Object.entries(w)) {
        if (!names[key]) continue;
        const pct = Math.round(val * 100);
        list.innerHTML += `<li class="weight-item"><span class="weight-name">${names[key]}</span><div class="weight-bar-container"><div class="weight-bar" style="width:${pct * 4}%"></div></div><span class="weight-value">${pct}%</span></li>`;
      }
    }
  } catch(e) {
    var wl = document.getElementById('weightsList');
    if (wl) wl.innerHTML = '<li style="color:var(--text-muted);padding:12px">Weights unavailable</li>';
  }
}

// ‚ïê‚ïê‚ïê SCORE SINGLE CVE ‚ïê‚ïê‚ïê
async function scoreSingle() {
  const btn = document.getElementById('btnScore');
  btn.disabled = true; btn.textContent = 'Scoring...';
  const body = {
    cve_id: document.getElementById('inputCve').value || 'CVE-2024-21887',
    cvss_base_score: parseFloat(document.getElementById('inputCvss').value) || 9.1,
    asset_tier: document.getElementById('inputTier').value,
    is_internet_facing: document.getElementById('inputFacing').value === 'true',
  };
  try {
    const r = await fetch(`${API}/score`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const d = await r.json();
    const el = document.getElementById('scoreResult');
    el.classList.add('visible');
    const score = d.vprs_score || 0;
    const sev = (d.severity || 'info').toUpperCase();
    document.getElementById('resultScore').textContent = score.toFixed(1);
    document.getElementById('resultScore').style.color = severityColor(sev);
    document.getElementById('resultSeverityBadge').innerHTML = `<span class="severity-badge ${sev}" style="margin-top:8px">${sev}</span>`;
    const bd = document.getElementById('resultBreakdown');
    bd.innerHTML = '';
    const labels = { epss:'EPSS', kev:'CISA KEV', dark_web:'Dark Web', asset_criticality:'Asset Criticality', reachability:'Reachability', controls:'Controls' };
    for (const [k, lbl] of Object.entries(labels)) {
      const v = (d.components || {})[k] || 0;
      bd.innerHTML += `<div class="breakdown-row"><span class="breakdown-label">${lbl}</span><span class="breakdown-value">${v.toFixed(2)}</span></div>`;
    }
    if (d.hard_rule_triggered) {
      bd.innerHTML += `<div class="breakdown-row"><span class="breakdown-label" style="color:var(--critical)">Hard Rule</span><span class="breakdown-value" style="color:var(--critical)">${d.hard_rule_name || 'triggered'}</span></div>`;
    }
  } catch(e) { alert('Scoring failed. Is the API running?'); }
  btn.disabled = false; btn.textContent = 'Score Vulnerability';
}

// ‚ïê‚ïê‚ïê LOAD LIVE DEMO DATA ‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê LOAD REAL DATA from live public APIs ‚ïê‚ïê‚ïê
async function loadRealData() {
  const btn = document.getElementById('btnLive');
  const src = document.getElementById('dataSource');
  btn.disabled = true; btn.textContent = 'üåê Fetching real CVEs...';
  src.textContent = 'Calling NVD + EPSS + CISA KEV + abuse.ch...';

  let data;
  try {
    const r = await fetch(`${API}/live/seed`, { method: 'POST' });
    data = await r.json();
  } catch(e) {
    btn.disabled = false; btn.textContent = 'üåê Live Data (Real APIs)';
    src.textContent = '‚ùå API offline - start with: docker compose up -d';
    return;
  }

  if (data.error) {
    btn.disabled = false; btn.textContent = 'üåê Live Data (Real APIs)';
    src.textContent = `‚ùå ${data.error}`;
    return;
  }

  btn.disabled = false; btn.textContent = 'üåê Live Data (Real APIs)';
  const ds = data.stats?.data_sources || {};
  src.textContent = `LIVE - ${ds.nvd_cves_fetched || 0} CVEs from NVD ¬∑ ${ds.epss_scores_found || 0} EPSS ¬∑ ${ds.kev_catalog_size || 0} KEV ¬∑ ${ds.abusech_iocs_found || 0} abuse.ch IoCs`;
  renderResults(data);
}

// ‚ïê‚ïê‚ïê SHARED RENDER FUNCTION ‚ïê‚ïê‚ïê
function renderResults(data) {
  const results = data.results || [];
  const stats = data.stats || {};

  var totalCount = stats.total || 1;

  // Flips: percentage big, count underneath
  var flipCount = results.filter(function(v){ return v.cvss_vs_vprs_flip; }).length;
  var flipPct = totalCount > 0 ? Math.round((flipCount / totalCount) * 100) : 0;
  document.getElementById('statFlipPct').textContent = `${flipPct}%`;
  document.getElementById('statFlipCount').textContent = `${flipCount} of ${stats.total || 0} re-prioritized`;

  // Noise: percentage big, count underneath
  var noiseRate = stats.noise_rate_display || stats.noise_rate || 0;
  var noiseCount = stats.noise_eliminated || 0;
  document.getElementById('statNoiseRate').textContent = `${noiseRate}%`;
  document.getElementById('statNoise').textContent = `${noiseCount} eliminated`;

  // Critical: percentage big, count underneath
  var critCount = stats.critical || 0;
  var totalCount = stats.total || 1;
  var critPct = Math.round((critCount / totalCount) * 100);
  document.getElementById('statCriticalPct').textContent = `${critPct}%`;
  document.getElementById('statCritical').textContent = `${critCount} requires immediate action`;

  // Tickets: percentage big, count underneath
  var ticketCount = stats.tickets_created || 0;
  var ticketPct = totalCount > 0 ? Math.round((ticketCount / totalCount) * 100) : 0;
  document.getElementById('statTicketsPct').textContent = `${ticketPct}%`;
  document.getElementById('statTickets').textContent = `${ticketCount} auto-assigned with SLA`;

  document.getElementById('resultCount').textContent = `${results.length} CVEs scored`;

  // Default: show only criticals
  try { renderFilteredTable(results, 'critical'); } catch(e) { console.error('Filter error:', e); renderFilteredTable(results, 'all'); }

  try { buildSeverityChart(stats); } catch(e) { console.error('Chart error:', e); }
  try { buildScatterChart(results); } catch(e) { console.error('Scatter error:', e); }
  try { buildComponentChart(results.filter(v => !v.is_noise).slice(0, 10)); } catch(e) { console.error('Component error:', e); }
  try { document.getElementById('chartsSection').style.display = 'block'; } catch(e) {}
}

var _tablePageSize = 9;
var _currentFiltered = [];
var _currentShown = 0;
var _currentFilter = 'critical';

function renderFilteredTable(results, filter) {
  console.log('[VulnPilot] renderFilteredTable called, filter:', filter, 'results:', results?.length);
  const tbody = document.getElementById('vulnTableBody');
  tbody.innerHTML = '';
  _currentFilter = filter;
  var filtered = results;
  if (filter === 'critical') filtered = results.filter(v => (v.severity||'').toUpperCase() === 'CRITICAL');
  else if (filter === 'high') filtered = results.filter(v => (v.severity||'').toUpperCase() === 'HIGH');
  else if (filter === 'critical+high') filtered = results.filter(v => ['CRITICAL','HIGH'].includes((v.severity||'').toUpperCase()));
  else if (filter === 'medium') filtered = results.filter(v => (v.severity||'').toUpperCase() === 'MEDIUM');
  else if (filter === 'low') filtered = results.filter(v => (v.severity||'').toUpperCase() === 'LOW');
  else if (filter === 'info') filtered = results.filter(v => (v.severity||'').toUpperCase() === 'INFO');
  else if (filter === 'noise') filtered = results.filter(v => v.is_noise);
  console.log('[VulnPilot] Filtered to', filtered.length, 'results');
  if (filtered.length === 0 && results.length > 0) {
    console.log('[VulnPilot] WARNING: filter returned 0 results! Severities:', [...new Set(results.map(v=>v.severity))]);
    filtered = results;
    filter = 'all';
  }

  _currentFiltered = filtered;
  _currentShown = 0;
  renderTablePage(results);

  // Update filter buttons
  document.querySelectorAll('.fbtn').forEach(b => b.classList.remove('act'));
  var activeBtn = document.getElementById('fbtn-'+filter);
  if(activeBtn) activeBtn.classList.add('act');
  document.getElementById('resultCount').textContent = Math.min(_tablePageSize, filtered.length) + ' of ' + filtered.length + ' CVEs';
}

function renderTablePage(allResults) {
  var tbody = document.getElementById('vulnTableBody');
  var end = Math.min(_currentShown + _tablePageSize, _currentFiltered.length);
  for (var i = _currentShown; i < end; i++) {
    var v = _currentFiltered[i];
    var origIdx = allResults.indexOf(v);
    var sev = (v.severity || 'INFO').toUpperCase();
    var flip = v.cvss_vs_vprs_flip;
    tbody.innerHTML += '<tr style="cursor:pointer" onclick="showCveDetail('+origIdx+')">'
      + '<td class="cve">'+v.cve_id+(flip ? ' <span style="color:var(--med);font-size:10px">FLIP</span>' : '')+'</td>'
      + '<td style="color:#64748b">'+v.cvss_score.toFixed(1)+'</td>'
      + '<td class="score" style="color:'+severityColor(sev)+';font-weight:700">'+v.vprs_score.toFixed(1)+'</td>'
      + '<td><span class="severity-badge '+sev+'">'+sev+'</span></td>'
      + '<td>'+(v.in_kev ? '<span class="kev-tag">KEV</span>' : (v.dark_web_mentions > 0 ? '<span style="color:var(--high);font-size:11px">DW:'+v.dark_web_mentions+'</span>' : ''))+'</td>'
      + '<td style="font-size:12px;color:#64748b">'+(v.hard_rule || '')+'</td>'
      + '<td>'+(v.is_noise ? '<span class="noise-tag">noise eliminated</span>' : (v.ticket_created ? 'üé´ ticket' : ''))+'</td>'
      + '</tr>';
  }
  _currentShown = end;

  // Remove old load-more row
  var old = document.getElementById('loadMoreRow');
  if (old) old.remove();

  // Add Load More button if there are more rows
  if (_currentShown < _currentFiltered.length) {
    var remaining = _currentFiltered.length - _currentShown;
    var tr = document.createElement('tr');
    tr.id = 'loadMoreRow';
    tr.innerHTML = '<td colspan="7" style="text-align:center;padding:6px 0">'
      + '<span onclick="loadMoreRows()" style="color:#ea580c;font-size:13px;font-weight:600;cursor:pointer;letter-spacing:0.5px" onmouseover="this.style.textDecoration=\'underline\'" onmouseout="this.style.textDecoration=\'none\'">+ ' + remaining + ' more ‚ñæ</span>'
      + '</td>';
    tbody.appendChild(tr);
  }

  // Update count
  document.getElementById('resultCount').textContent = _currentShown + ' of ' + _currentFiltered.length + ' CVEs';
}

function loadMoreRows() {
  // Remove load more button first
  var old = document.getElementById('loadMoreRow');
  if (old) old.remove();
  // Render next page
  renderTablePage(_aiData.results);
}

async function loadLiveData() {
  console.log('[VulnPilot] loadLiveData called');
  let data;
  try {
    const r = await fetch(`${API}/demo/results`);
    data = await r.json();
    console.log('[VulnPilot] API returned data:', data?.results?.length, 'results');
    console.log('[VulnPilot] First result severity:', data?.results?.[0]?.severity);
  } catch(e) { console.log('[VulnPilot] API failed, loading fallback:', e); loadFallbackDemo(); return; }

  document.getElementById('dataSource').textContent = 'DEMO - 47 realistic CVEs scored through VPRS engine';
  console.log('[VulnPilot] Calling renderResults...');
  renderResults(data);
  console.log('[VulnPilot] renderResults complete');
}

// ‚ïê‚ïê‚ïê SEVERITY BAR CHART ‚ïê‚ïê‚ïê
function buildSeverityChart(stats) {
  const canvas = document.getElementById('severityChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.parentElement.clientWidth - 32;
  const h = canvas.height = 200;
  ctx.clearRect(0, 0, w, h);
  const data = [
    { label:'CRITICAL', count:stats.critical||0, color:'#ef4444', filter:'critical' },
    { label:'HIGH', count:stats.high||0, color:'#f97316', filter:'high' },
    { label:'MEDIUM', count:stats.medium||0, color:'#eab308', filter:'medium' },
    { label:'LOW', count:stats.low||0, color:'#22c55e', filter:'low' },
    { label:'INFO', count:stats.info||0, color:'#64748b', filter:'info' },
  ];
  const max = Math.max(...data.map(d=>d.count), 1);
  const barW = (w - 80) / data.length;
  const barRects = [];
  data.forEach((d,i) => {
    const x = 40 + i * barW + 6;
    const barH = (d.count / max) * (h - 60);
    const y = h - 30 - barH;
    barRects.push({x, y, w:barW-12, h:barH, data:d});
    ctx.fillStyle = d.color;
    ctx.beginPath();
    ctx.moveTo(x+4,y); ctx.lineTo(x+barW-16,y); ctx.quadraticCurveTo(x+barW-12,y,x+barW-12,y+4);
    ctx.lineTo(x+barW-12,h-30); ctx.lineTo(x,h-30); ctx.lineTo(x,y+4); ctx.quadraticCurveTo(x,y,x+4,y);
    ctx.fill();
    ctx.fillStyle = '#e2e8f0'; ctx.font = 'bold 14px JetBrains Mono'; ctx.textAlign = 'center';
    ctx.fillText(d.count, x + (barW-12)/2, y - 8);
    ctx.fillStyle = '#64748b'; ctx.font = '11px DM Sans';
    ctx.fillText(d.label, x + (barW-12)/2, h - 10);
  });
  canvas._barRects = barRects;
  canvas._barData = data;
  canvas.style.cursor = 'pointer';
  canvas.onmousemove = function(e) {
    var rect = canvas.getBoundingClientRect();
    var mx = e.clientX - rect.left, my = e.clientY - rect.top;
    var ctx2 = canvas.getContext('2d');
    // Redraw bars
    var max2 = Math.max(...data.map(function(d){return d.count}), 1);
    var barW2 = (canvas.width - 80) / data.length;
    ctx2.clearRect(0, 0, canvas.width, canvas.height);
    data.forEach(function(d, i) {
      var x = 40 + i * barW2 + 6;
      var barH2 = (d.count / max2) * (canvas.height - 60);
      var y2 = canvas.height - 30 - barH2;
      var isHover = mx >= x && mx <= x+barW2-12 && my >= y2 && my <= y2+barH2;
      ctx2.save();
      if (isHover) {
        ctx2.shadowColor = d.color;
        ctx2.shadowBlur = 20;
        ctx2.shadowOffsetX = 0;
        ctx2.shadowOffsetY = 0;
      }
      ctx2.fillStyle = d.color;
      ctx2.beginPath();
      ctx2.moveTo(x+4,y2); ctx2.lineTo(x+barW2-16,y2); ctx2.quadraticCurveTo(x+barW2-12,y2,x+barW2-12,y2+4);
      ctx2.lineTo(x+barW2-12,canvas.height-30); ctx2.lineTo(x,canvas.height-30); ctx2.lineTo(x,y2+4); ctx2.quadraticCurveTo(x,y2,x+4,y2);
      ctx2.fill();
      ctx2.restore();
      ctx2.fillStyle = isHover ? '#ffffff' : '#e2e8f0'; ctx2.font = 'bold 14px JetBrains Mono'; ctx2.textAlign = 'center';
      ctx2.fillText(d.count, x + (barW2-12)/2, y2 - 8);
      ctx2.fillStyle = isHover ? '#ffffff' : '#94a3b8'; ctx2.font = '11px DM Sans';
      ctx2.fillText(d.label, x + (barW2-12)/2, canvas.height - 10);
    });
  };
  canvas.onmouseleave = function() { buildSeverityChart(stats); };
  canvas.onclick = function(e) {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    for (const b of canvas._barRects) {
      if (mx >= b.x && mx <= b.x+b.w && my >= b.y && my <= b.y+b.h) {
        switchTab('dashboard', document.querySelectorAll('.ntab')[0]);
        setTimeout(function(){ renderFilteredTable(_aiData.results, b.data.filter); }, 100);
        return;
      }
    }
    showChartAnalysis('severity');
  };
}

// ‚ïê‚ïê‚ïê CVSS vs VPRS SCATTER ‚ïê‚ïê‚ïê
function buildScatterChart(results) {
  const canvas = document.getElementById('scatterChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.parentElement.clientWidth - 32;
  const h = canvas.height = 250;
  ctx.clearRect(0, 0, w, h);
  const pad = {top:20,right:20,bottom:40,left:50};
  const cw = w-pad.left-pad.right, ch = h-pad.top-pad.bottom;

  // Axes
  ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(pad.left,pad.top); ctx.lineTo(pad.left,h-pad.bottom); ctx.lineTo(w-pad.right,h-pad.bottom); ctx.stroke();

  // Labels
  ctx.fillStyle = '#64748b'; ctx.font = '11px DM Sans'; ctx.textAlign = 'center';
  ctx.fillText('CVSS Score', w/2, h-5);
  ctx.save(); ctx.translate(12,h/2); ctx.rotate(-Math.PI/2); ctx.fillText('VPRS Score',0,0); ctx.restore();

  // Grid
  ctx.strokeStyle = '#1e293b44';
  for (let i = 0; i <= 10; i += 2) {
    const x = pad.left + (i/10)*cw, y = h - pad.bottom - (i*10/100)*ch;
    ctx.beginPath(); ctx.moveTo(x,pad.top); ctx.lineTo(x,h-pad.bottom); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(pad.left,y); ctx.lineTo(w-pad.right,y); ctx.stroke();
    ctx.fillStyle = '#64748b'; ctx.font = '9px JetBrains Mono';
    ctx.textAlign = 'center'; ctx.fillText(i.toString(), x, h-pad.bottom+14);
    ctx.textAlign = 'right'; ctx.fillText((i*10).toString(), pad.left-8, y+4);
  }

  // Diagonal
  ctx.strokeStyle = '#3b82f622'; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(pad.left,h-pad.bottom); ctx.lineTo(w-pad.right,pad.top); ctx.stroke();
  ctx.setLineDash([]);

  // Points
  const colors = {CRITICAL:'#ef4444',HIGH:'#f97316',MEDIUM:'#eab308',LOW:'#22c55e',INFO:'#64748b'};
  const dotPositions = [];
  results.forEach((v,idx) => {
    const x = pad.left + (v.cvss_score/10)*cw;
    const y = h - pad.bottom - (v.vprs_score/100)*ch;
    const col = colors[(v.severity||'INFO').toUpperCase()] || '#64748b';
    dotPositions.push({x, y, idx, cve:v});
    ctx.fillStyle = col+'33'; ctx.beginPath(); ctx.arc(x,y,8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = col; ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
    if (v.cvss_vs_vprs_flip) {
      ctx.strokeStyle = '#eab308'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.stroke();
    }
  });
  canvas._dots = dotPositions;
  canvas.style.cursor = 'pointer';
  canvas.onclick = function(e) {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    for (const d of canvas._dots) {
      if (Math.sqrt((mx-d.x)**2+(my-d.y)**2) < 12) {
        showCveDetail(d.idx);
        return;
      }
    }
    showChartAnalysis('scatter');
  };

  ctx.font = '10px DM Sans'; ctx.fillStyle = '#64748b'; ctx.textAlign = 'left';
  ctx.fillText('Above line = VPRS elevated | Below = noise eliminated | Yellow ring = CVSS/VPRS flip', pad.left, pad.top - 4);
}

// ‚ïê‚ïê‚ïê COMPONENT STACKED BAR ‚ïê‚ïê‚ïê
function buildComponentChart(topResults, hoverIdx) {
  var top10 = topResults;
  const canvas = document.getElementById('componentChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width = canvas.parentElement.clientWidth - 32;
  const h = canvas.height = 220;
  ctx.clearRect(0, 0, w, h);
  if (!topResults.length) return;
  const pad = {top:24,right:20,bottom:55,left:40};
  const cw = w-pad.left-pad.right, ch = h-pad.top-pad.bottom;
  const barW = cw / topResults.length;
  const comps = ['epss','kev','dark_web','asset','reachability','controls'];
  const compColors = ['#3b82f6','#ef4444','#8b5cf6','#06b6d4','#f97316','#22c55e'];
  const compLabels = ['EPSS','KEV','DarkWeb','Asset','Reach','Controls'];

  const compBarRects = [];
  topResults.forEach((v,i) => {
    const x = pad.left + i * barW + 4;
    var barIdx = _aiData.results.indexOf(v)>=0?_aiData.results.indexOf(v):i;
    var isHover = barIdx === hoverIdx;
    let yOff = 0;
    ctx.save();
    if (isHover) { ctx.shadowColor = '#f97316'; ctx.shadowBlur = 18; }
    comps.forEach((comp,ci) => {
      const val = v.components?.[comp] || 0;
      const segH = (val / 100) * ch;
      ctx.fillStyle = compColors[ci];
      ctx.fillRect(x, h-pad.bottom-yOff-segH, barW-8, segH);
      yOff += segH;
    });
    ctx.restore();
    compBarRects.push({x, w:barW-8, top:h-pad.bottom-yOff, h:yOff, idx:barIdx});
    ctx.save();
    ctx.translate(x+(barW-8)/2, h-pad.bottom+8);
    ctx.rotate(Math.PI/4);
    ctx.fillStyle = isHover ? '#ffffff' : '#94a3b8'; ctx.font = (isHover?'bold ':'')+'8px JetBrains Mono'; ctx.textAlign = 'left';
    ctx.fillText(v.cve_id.length > 18 ? v.cve_id.slice(0,18)+'...' : v.cve_id, 0, 0);
    ctx.restore();
  });
  canvas._bars = compBarRects;
  canvas._compData = top10;
  canvas.style.cursor = 'pointer';
  canvas.onmousemove = function(e) {
    var rect = canvas.getBoundingClientRect();
    var mx = e.clientX - rect.left, my = e.clientY - rect.top;
    var ctx2 = canvas.getContext('2d');
    var hoverIdx = -1;
    for (var bi = 0; bi < canvas._bars.length; bi++) {
      var b = canvas._bars[bi];
      if (mx >= b.x && mx <= b.x+b.w && my >= b.top && my <= b.top+b.h) { hoverIdx = b.idx; break; }
    }
    // Redraw with glow on hovered bar
    buildComponentChart(top10, hoverIdx);
  };
  canvas.onmouseleave = function() { buildComponentChart(top10, -1); };
  canvas.onclick = function(e) {
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    for (const b of canvas._bars) {
      if (mx >= b.x && mx <= b.x+b.w && my >= b.top && my <= b.top+b.h) {
        showCveDetail(b.idx);
        return;
      }
    }
    showChartAnalysis('components');
  };

  let lx = pad.left;
  compLabels.forEach((lbl,i) => {
    ctx.fillStyle = compColors[i]; ctx.fillRect(lx, 6, 10, 10);
    ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans'; ctx.textAlign = 'left';
    ctx.fillText(lbl, lx+14, 15); lx += ctx.measureText(lbl).width + 28;
  });
}

// ‚ïê‚ïê‚ïê FALLBACK (API offline) ‚ïê‚ïê‚ïê
function loadFallbackDemo() {
  console.log('[VulnPilot] Loading fallback demo data');
  document.getElementById('statFlipPct').textContent = '55%'; document.getElementById('statFlipCount').textContent = '26 of 47 re-prioritized';
  document.getElementById('statNoise').textContent = '26';
  document.getElementById('statNoiseRate').textContent = '85% eliminated';
  document.getElementById('statCritical').textContent = '12';
  document.getElementById('statTickets').textContent = '21';
  document.getElementById('resultCount').textContent = '12 of 47 CVEs';
  var tbody = document.getElementById('vulnTableBody');
  var rows = [
    ['CVE-2024-21887','9.1','100.0','CRITICAL','KEV','kev_always_critical',true,0.97,0,true],
    ['CVE-2024-3400','10.0','100.0','CRITICAL','KEV','kev_always_critical',true,0.96,0,true],
    ['CVE-2024-47575','9.8','100.0','CRITICAL','KEV','kev_always_critical',true,0.95,0,true],
    ['CVE-2024-1709','10.0','100.0','CRITICAL','KEV','kev_always_critical',true,0.94,0,true],
    ['CVE-2024-FLIP-03','4.3','100.0','CRITICAL','KEV','kev_always_critical',true,0.88,0,false],
    ['CVE-2023-46805','8.2','97.0','CRITICAL','KEV','kev_always_critical',true,0.92,0,true],
    ['CVE-2024-20353','8.6','97.0','CRITICAL','KEV','kev_always_critical',true,0.91,0,true],
    ['CVE-2025-0DAY-02','7.8','92.0','CRITICAL','DW:10','ransomware_critical',false,0.45,10,true],
    ['CVE-2025-0DAY-01','8.5','91.0','CRITICAL','DW:14','exploit_for_sale_critical',false,0.62,14,true],
    ['CVE-2024-4577','9.8','90.0','CRITICAL','KEV','kev_always_critical',true,0.89,0,true],
    ['CVE-2024-27198','9.8','90.0','CRITICAL','KEV','kev_always_critical',true,0.87,0,true],
    ['CVE-2024-FLIP-01','6.1','88.0','CRITICAL','DW:8','high_epss_internet_facing',false,0.78,8,true],
  ];
  tbody.innerHTML = '';
  document.getElementById('dataSource').textContent = 'DEMO - 47 realistic CVEs scored through VPRS engine';

  // Build _aiData so AI fallback analysis works (critical for static/website deployment)
  var demoResults = rows.map(function(r) {
    return {
      cve_id: r[0], cvss_score: parseFloat(r[1]), vprs_score: parseFloat(r[2]),
      severity: r[3], in_kev: r[6], epss_score: r[7],
      dark_web_mentions: r[8], is_internet_facing: r[9],
      is_noise: false, cvss_vs_vprs_flip: r[0].includes('FLIP'),
      hard_rule: r[5], ticket_status: 'created', ticket_created: true
    };
  });
  // Add noise entries (not shown in table but counted in stats)
  for (var i = 0; i < 26; i++) {
    demoResults.push({
      cve_id: 'CVE-2024-LOW-'+String(i+1).padStart(2,'0'), cvss_score: 2.0+Math.random()*3,
      vprs_score: 5+Math.random()*15, severity: i<6?'MEDIUM':'LOW',
      in_kev: false, epss_score: Math.random()*0.05, dark_web_mentions: 0,
      is_internet_facing: false, is_noise: true, cvss_vs_vprs_flip: false,
      hard_rule: '', ticket_status: 'noise_filtered'
    });
  }
  // Add remaining high/medium (47 total - 12 critical - 26 noise = 9 more)
  var highCves = [
    {cve_id:'CVE-2024-38189',cvss:8.8,vprs:72,sev:'HIGH',kev:false,epss:0.35,dw:3,inet:true},
    {cve_id:'CVE-2024-38178',cvss:7.5,vprs:68,sev:'HIGH',kev:false,epss:0.28,dw:2,inet:true},
    {cve_id:'CVE-2024-38213',cvss:6.5,vprs:55,sev:'HIGH',kev:false,epss:0.15,dw:1,inet:false},
    {cve_id:'CVE-2024-21762',cvss:9.8,vprs:78,sev:'HIGH',kev:true,epss:0.82,dw:5,inet:true},
    {cve_id:'CVE-2024-23113',cvss:9.8,vprs:75,sev:'HIGH',kev:false,epss:0.72,dw:4,inet:true},
    {cve_id:'CVE-2024-9474',cvss:7.2,vprs:62,sev:'HIGH',kev:false,epss:0.22,dw:0,inet:false},
    {cve_id:'CVE-2024-0012',cvss:9.8,vprs:70,sev:'HIGH',kev:false,epss:0.55,dw:3,inet:true},
    {cve_id:'CVE-2024-5921',cvss:6.9,vprs:45,sev:'MEDIUM',kev:false,epss:0.08,dw:0,inet:false},
    {cve_id:'CVE-2024-9463',cvss:7.5,vprs:58,sev:'HIGH',kev:false,epss:0.32,dw:2,inet:true},
  ];
  highCves.forEach(function(h) {
    demoResults.push({
      cve_id: h.cve_id, cvss_score: h.cvss, vprs_score: h.vprs,
      severity: h.sev, in_kev: h.kev, epss_score: h.epss,
      dark_web_mentions: h.dw, is_internet_facing: h.inet,
      is_noise: false, cvss_vs_vprs_flip: false, hard_rule: '', ticket_status: 'created'
    });
  });

  _aiData = {
    results: demoResults,
    stats: { total: 47, critical: 12, high: 8, medium: 1, low: 0, noise: 26 }
  };
  renderFilteredTable(_aiData.results, 'critical');
  try { renderAISuggestions(); } catch(e) {}
  try { updateThreatIntelStats(_aiData); } catch(e) {}
}

// ‚ïê‚ïê‚ïê DRIFT DETECTOR - Lock 3 Active ‚ïê‚ïê‚ïê
async function runDriftCheck() {
  var btn = document.getElementById('driftCheckBtn');
  btn.textContent = '‚è≥ Checking...';
  btn.disabled = true;
  
  if (!_aiData || !_aiData.results) {
    btn.textContent = 'üîÑ Check Now';
    btn.disabled = false;
    showDriftLog([{cve_id:'‚Äî', direction:'‚Äî', reasons:['Load vulnerability data first (Live or Demo)'], detected_at: new Date().toISOString(), diff:0}]);
    return;
  }
  
  try {
    // First snapshot if none exists
    await fetch(API + '/drift/snapshot', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({results: _aiData.results})
    });
    
    // Then check for drifts
    var r = await fetch(API + '/drift/check', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({results: _aiData.results, threshold: 10})
    });
    var data = await r.json();
    
    if (data.drifts && data.drifts.length > 0) {
      showDriftLog(data.drifts);
    } else {
      showDriftLog([{cve_id:'‚úì', direction:'STABLE', reasons:['No drift detected. ' + data.checked + ' CVEs checked ‚Äî all scores stable.'], detected_at: new Date().toISOString(), diff:0}]);
    }
  } catch(e) {
    showDriftLog([{cve_id:'‚Äî', direction:'ERROR', reasons:['API not reachable. Scores baselined locally.'], detected_at: new Date().toISOString(), diff:0}]);
    // Fallback: baseline in-memory
    console.log('[Drift] API unreachable, running client-side baseline');
  }
  
  btn.textContent = 'üîÑ Check Now';
  btn.disabled = false;
}

async function runDriftDemo() {
  var btn = document.getElementById('driftDemoBtn');
  btn.textContent = '‚è≥ Simulating...';
  btn.disabled = true;
  
  try {
    var r = await fetch(API + '/drift/demo', {method:'POST'});
    var data = await r.json();
    if (data.events) {
      showDriftLog(data.events);
    }
  } catch(e) {
    // Fallback: client-side demo
    console.log('[Drift] API unreachable, running client-side demo');
    var demoEvents = [
      {cve_id:'CVE-2024-38178', old_vprs:42, new_vprs:100, diff:58, direction:'UP', old_severity:'MEDIUM', new_severity:'CRITICAL', reasons:['ADDED to CISA KEV ‚Äî now confirmed exploited','Hard rule: kev_always_critical'], detected_at: new Date(Date.now()-47*60000).toISOString(), scenario_title:'üö® CISA KEV Addition'},
      {cve_id:'CVE-2024-9474', old_vprs:35, new_vprs:78, diff:43, direction:'UP', old_severity:'MEDIUM', new_severity:'HIGH', reasons:['EPSS changed: 22% ‚Üí 78%','Dark web IoCs: 0 ‚Üí 3'], detected_at: new Date(Date.now()-118*60000).toISOString(), scenario_title:'üìà EPSS Spike ‚Äî PoC Published'},
      {cve_id:'CVE-2024-5921', old_vprs:28, new_vprs:72, diff:44, direction:'UP', old_severity:'LOW', new_severity:'HIGH', reasons:['Dark web IoCs: 0 ‚Üí 14','EPSS: 8% ‚Üí 35%'], detected_at: new Date(Date.now()-195*60000).toISOString(), scenario_title:'üï∏Ô∏è Dark Web Surge'},
      {cve_id:'CVE-2024-0012', old_vprs:70, new_vprs:38, diff:-32, direction:'DOWN', old_severity:'HIGH', new_severity:'MEDIUM', reasons:['Patched on 3/4 hosts','Controls active: WAF + EDR'], detected_at: new Date(Date.now()-310*60000).toISOString(), scenario_title:'üìâ Risk Reduced ‚Äî Patch Deployed'},
    ];
    showDriftLog(demoEvents);
  }
  
  btn.textContent = '‚ö° Demo Drift';
  btn.disabled = false;
}

function showDriftLog(events) {
  var el = document.getElementById('driftLog');
  var empty = document.getElementById('driftEmpty');
  el.style.display = 'block';
  if (empty) empty.style.display = 'none';
  
  var html = '';
  events.forEach(function(e) {
    var timeStr = '';
    if (e.detected_at) {
      var d = new Date(e.detected_at);
      var mins = Math.round((Date.now() - d.getTime()) / 60000);
      timeStr = mins < 60 ? mins + 'm ago' : Math.round(mins/60) + 'h ago';
    }
    
    var dirColor = e.direction === 'UP' ? 'var(--crit)' : e.direction === 'DOWN' ? '#0f766e' : e.direction === 'STABLE' ? 'var(--low)' : '#64748b';
    var dirIcon = e.direction === 'UP' ? 'üî∫' : e.direction === 'DOWN' ? 'üîΩ' : e.direction === 'STABLE' ? '‚úÖ' : '‚ÑπÔ∏è';
    var diffText = e.diff ? (e.diff > 0 ? '+' + e.diff : e.diff) : '';
    
    html += '<div style="padding:6px 0;border-bottom:1px solid #e5e7eb">';
    
    if (e.scenario_title) {
      html += '<div style="font-size:10px;font-weight:700;color:' + dirColor + ';margin-bottom:2px">' + e.scenario_title + '</div>';
    }
    
    html += '<div style="display:flex;align-items:center;gap:4px">';
    html += '<span style="font-size:10px">' + dirIcon + '</span>';
    html += '<span style="font-size:11px;font-weight:700;color:#0f172a;font-family:JetBrains Mono,monospace">' + e.cve_id + '</span>';
    if (diffText) html += '<span style="font-size:10px;font-weight:700;color:' + dirColor + ';margin-left:auto">' + diffText + '</span>';
    if (timeStr) html += '<span style="font-size:9px;color:#94a3b8;margin-left:4px">' + timeStr + '</span>';
    html += '</div>';
    
    if (e.old_vprs !== undefined && e.new_vprs !== undefined && e.diff) {
      html += '<div style="font-size:10px;color:#64748b;margin-top:2px">VPRS ' + e.old_vprs + ' ‚Üí <strong style="color:' + dirColor + '">' + e.new_vprs + '</strong>';
      if (e.old_severity && e.new_severity && e.old_severity !== e.new_severity) {
        html += ' ¬∑ ' + e.old_severity + ' ‚Üí <strong>' + e.new_severity + '</strong>';
      }
      html += '</div>';
    }
    
    if (e.reasons) {
      e.reasons.forEach(function(r) {
        html += '<div style="font-size:10px;color:#64748b;padding-left:14px">¬∑ ' + r + '</div>';
      });
    }
    html += '</div>';
  });
  
  el.innerHTML = html;
}

// Load drift log on init
async function loadDriftLog() {
  try {
    var r = await fetch(API + '/drift/log');
    var data = await r.json();
    if (data.events && data.events.length > 0) {
      showDriftLog(data.events.slice(0, 10));
    }
  } catch(e) {}
}

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
checkHealth();
loadWeights();
checkProviderHealth(); // v1.0: Check AI provider availability
loadDriftLog(); // v1.0: Load drift detection log
setInterval(checkProviderHealth, 60000); // Re-check every 60s

// Sync AI bar border-radius with response panel visibility
(function(){
  var respEl = document.getElementById('aiResponse');
  var barEl = document.querySelector('.ai-bar');
  if (respEl && barEl) {
    new MutationObserver(function(){
      if (respEl.classList.contains('active')) {
        barEl.classList.add('resp-open');
      } else {
        barEl.classList.remove('resp-open');
      }
    }).observe(respEl, {attributes:true, attributeFilter:['class']});
  }
})();

// Load data with retry
async function initDashboard() {
  console.log('[VulnPilot] Initializing dashboard...');
  try {
    await loadLiveData();
  } catch(e) {
    console.error('[VulnPilot] loadLiveData failed:', e);
  }
  // Safety check: if table is still empty after 3 seconds, force fallback
  setTimeout(function() {
    var tbody = document.getElementById('vulnTableBody');
    if (tbody && tbody.innerHTML.trim() === '') {
      console.log('[VulnPilot] Table still empty after 3s, forcing fallback');
      loadFallbackDemo();
    }
  }, 3000);
}
initDashboard();
setInterval(checkHealth, 30000);

// ‚ïê‚ïê‚ïê REPORT DOWNLOAD FUNCTION ‚ïê‚ïê‚ïê
async function downloadReport(type, style, format) {
  const body = document.getElementById('aiResponseBody');
  body.innerHTML = `<span class="ai-typing"></span> Generating ${type} ${style} report as ${format.toUpperCase()}...`;

  try {
    const resp = await fetch(`${API}/reports/generate`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        report_type: type,
        style: style,
        output_format: format,
        company_name: 'Your Organization',
      })
    });

    if (format === 'xlsx' || format === 'pdf') {
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vulnpilot_${type}_${style}.${format}`;
      a.click();
      URL.revokeObjectURL(url);
      body.innerHTML = `<strong>‚úÖ Downloaded!</strong> Your ${format.toUpperCase()} report has been saved as <span class="metric">vulnpilot_${type}_${style}.${format}</span>`;
    } else if (format === 'csv') {
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `vulnpilot_${type}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      body.innerHTML = `<strong>‚úÖ Downloaded!</strong> CSV exported as <span class="metric">vulnpilot_${type}.csv</span>`;
    } else if (format === 'markdown') {
      const data = await resp.json();
      const md = data.report || JSON.stringify(data, null, 2);
      body.innerHTML = `<strong>üìù Markdown Report</strong><br><pre style="background:var(--bg);padding:12px;border-radius:8px;overflow-x:auto;font-size:11px;max-height:400px;overflow-y:auto">${md.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre><br><button onclick="navigator.clipboard.writeText(document.querySelector('#aiResponseBody pre').textContent);this.textContent='‚úÖ Copied!'" style="background:var(--accent-blue);border:none;color:white;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px">üìã Copy to Clipboard</button>`;
    } else {
      const data = await resp.json();
      body.innerHTML = `<strong>üìä JSON Report</strong><br><pre style="background:var(--bg);padding:12px;border-radius:8px;overflow-x:auto;font-size:11px;max-height:400px;overflow-y:auto">${JSON.stringify(data, null, 2).replace(/</g,'&lt;')}</pre>`;
    }
  } catch(e) {
    body.innerHTML = `<strong>‚ùå Report generation failed</strong><br>Make sure the API is running: <code>docker compose up -d</code><br>Error: ${e.message}`;
  }
}

// ‚ïê‚ïê‚ïê AI AGENTIC QUERY ENGINE ‚ïê‚ïê‚ïê
// _aiData is declared in early script block above

// Store data when rendered for AI queries
const _origRender = renderResults;
renderResults = function(data) {
  _aiData = data;
  try {
    _origRender(data);
  } catch(e) {
    console.error('renderResults error:', e);
    // Try fallback
    try { loadFallbackDemo(); } catch(e2) {}
  }
  try { renderAISuggestions(); } catch(e) {}
  try { updateActivityFeed(data); } catch(e) {}
  try { updateThreatIntelStats(data); } catch(e) {}
};

// ‚ïê‚ïê‚ïê ACTIVITY FEED - CyberSentinel-style live event log ‚ïê‚ïê‚ïê
function updateActivityFeed(data) {
  var feed = document.getElementById('activityFeed');
  if (!feed || !data) return;
  var results = data.results || [];
  var stats = data.stats || {};
  var now = new Date();
  var lines = [];

  // Calculate real stats from data
  var totalCves = results.length;
  var kevCount = results.filter(function(v){return v.in_kev}).length;
  var epssCount = results.filter(function(v){return v.epss_score > 0}).length;
  var darkWebCount = results.filter(function(v){return v.dark_web_mentions > 0}).length;
  var noiseCount = results.filter(function(v){return v.is_noise}).length;
  var critCount = results.filter(function(v){return (v.severity||'').toUpperCase()==='CRITICAL'}).length;
  var iocTotal = results.reduce(function(sum,v){return sum + (v.dark_web_mentions||0)},0);

  lines.push('<div style="color:#334155;padding:2px 0"><span style="color:var(--low)">‚óè</span> Threat Intel: <strong style="color:var(--cyan)">'+totalCves+'</strong> CVEs, <strong style="color:var(--cyan)">'+iocTotal+'</strong> IOCs loaded<span style="float:right;opacity:0.5;font-style:italic">now</span></div>');
  lines.push('<div style="color:#334155;padding:2px 0"><span style="color:var(--low)">‚óè</span> System initialized - 31 integrations<span style="float:right;opacity:0.5;font-style:italic">now</span></div>');
  lines.push('<div style="color:#334155;padding:2px 0"><span style="color:var(--low)">‚óè</span> Ollama model connected<span style="float:right;opacity:0.5;font-style:italic">1m</span></div>');
  lines.push('<div style="color:#334155;padding:2px 0"><span style="color:var(--low)">‚óè</span> VPRS scoring complete - <strong style="color:var(--crit)">'+critCount+'</strong> critical<span style="float:right;opacity:0.5;font-style:italic">1m</span></div>');
  if (kevCount > 0) lines.push('<div style="color:#334155;padding:2px 0"><span style="color:var(--crit)">‚óè</span> CISA KEV matched: <strong style="color:var(--crit)">'+kevCount+'</strong> actively exploited<span style="float:right;opacity:0.5;font-style:italic">2m</span></div>');
  if (noiseCount > 0) lines.push('<div style="color:#334155;padding:2px 0"><span style="color:var(--low)">‚óè</span> Noise eliminated: <strong style="color:var(--low)">'+noiseCount+'</strong> low-risk filtered<span style="float:right;opacity:0.5;font-style:italic">2m</span></div>');
  lines.push('<div style="color:#334155;padding:2px 0"><span style="color:var(--low)">‚óè</span> Threat intel feeds ready<span style="float:right;opacity:0.5;font-style:italic">3m</span></div>');
  if (darkWebCount > 0) lines.push('<div style="color:#334155;padding:2px 0"><span style="color:#8b5cf6">‚óè</span> Dark web scan: <strong style="color:#8b5cf6">'+darkWebCount+'</strong> CVEs with activity<span style="float:right;opacity:0.5;font-style:italic">3m</span></div>');

  feed.innerHTML = lines.join('');
}

// ‚ïê‚ïê‚ïê THREAT INTEL STATS - Green glow reflection panel ‚ïê‚ïê‚ïê
function updateThreatIntelStats(data) {
  if (!data || !data.results) return;
  var results = data.results;

  var nvdCount = results.length;
  var kevCount = results.filter(function(v){return v.in_kev}).length;
  var epssCount = results.filter(function(v){return v.epss_score > 0}).length;
  var otxCount = results.reduce(function(sum,v){return sum + (v.dark_web_mentions||0)},0);
  var abuseCount = results.filter(function(v){return v.dark_web_mentions > 2}).length;

  // Animate count-up for each stat
  function animateCount(elId, target) {
    var el = document.getElementById(elId);
    if (!el) return;
    var current = 0;
    var step = Math.max(1, Math.floor(target / 20));
    var timer = setInterval(function(){
      current = Math.min(current + step, target);
      el.textContent = current.toLocaleString();
      if (current >= target) clearInterval(timer);
    }, 40);
  }

  animateCount('tiNvd', nvdCount);
  animateCount('tiKev', kevCount);
  animateCount('tiEpss', epssCount);
  animateCount('tiOtx', otxCount);
  animateCount('tiAbuse', abuseCount);
}

// 30 pre-defined smart queries (20 vuln + 10 asset/environment)
const AI_QUERIES = [
  {q:"Which CVEs should I patch first this week?", icon:"üî•", cat:"priority"},
  {q:"Show me all CVSS vs VPRS flips", icon:"üîÑ", cat:"flip"},
  {q:"What got eliminated as noise?", icon:"üîá", cat:"noise"},
  {q:"Which CVEs are in CISA KEV?", icon:"üîê", cat:"kev"},
  {q:"What has dark web activity?", icon:"üïµÔ∏è", cat:"darkweb"},
  {q:"Show my risk exposure by asset tier", icon:"üè¢", cat:"asset"},
  {q:"Which CVEs are internet-facing?", icon:"üåê", cat:"internet"},
  {q:"What hard rules fired and why?", icon:"‚ö°", cat:"hardrule"},
  {q:"What's my average VPRS score?", icon:"üìä", cat:"avg"},
  {q:"Compare EPSS vs VPRS effectiveness", icon:"üìà", cat:"epss"},
  {q:"Show critical vulns with no compensating controls", icon:"üö®", cat:"nocontrols"},
  {q:"Which tickets were auto-created?", icon:"üé´", cat:"tickets"},
  {q:"Summarize my SLA deadlines", icon:"‚è∞", cat:"sla"},
  {q:"What ransomware-associated CVEs do I have?", icon:"üíÄ", cat:"ransomware"},
  {q:"Show me low CVSS vulns that VPRS upgraded", icon:"‚¨ÜÔ∏è", cat:"upgraded"},
  {q:"What are my biggest risk reduction opportunities?", icon:"üéØ", cat:"opportunity"},
  {q:"How many CVEs per severity level?", icon:"üìâ", cat:"severity"},
  {q:"Show CVEs with EPSS above 50%", icon:"üî¥", cat:"highepss"},
  {q:"What would a CISO care about most today?", icon:"üëî", cat:"executive"},
  {q:"Give me the 60-second security briefing", icon:"‚ö°", cat:"briefing"},
  // Asset & Environment queries
  {q:"How many endpoints do we have in total?", icon:"üíª", cat:"assets"},
  {q:"What operating systems are in our environment?", icon:"üñ•Ô∏è", cat:"os"},
  {q:"How many servers vs workstations?", icon:"üèóÔ∏è", cat:"assettype"},
  {q:"Which business units have the most risk?", icon:"üè¢", cat:"bu"},
  {q:"Show me all internet-facing assets", icon:"üåê", cat:"inet_assets"},
  {q:"What percentage of assets have critical vulns?", icon:"üìä", cat:"asset_risk"},
  {q:"Which assets have no EDR protection?", icon:"üîê", cat:"edr"},
  {q:"Show production vs dev environment breakdown", icon:"‚öôÔ∏è", cat:"env"},
  {q:"Which perimeter devices are vulnerable?", icon:"üîí", cat:"perimeter"},
  {q:"Who owns the most vulnerable assets?", icon:"üë§", cat:"owners"},
];

function renderAISuggestions() {
  const el = document.getElementById('aiSuggestions');
  // Show 10 random suggestions
  const shuffled = [...AI_QUERIES].sort(() => Math.random() - 0.5).slice(0, 10);
  el.innerHTML = shuffled.map(q =>
    `<div class="ai-chip" onclick="document.getElementById('aiQuery').value='${q.q}';askAI()">${q.icon} ${q.q}</div>`
  ).join('');
}

// ‚ïê‚ïê‚ïê ACTIVE AI PROVIDER (hot-swappable from UI) ‚ïê‚ïê‚ïê
var _activeProvider = 'ollama';
var _providerHealth = {};
var _aiAbortController = null;

function setAIProvider(name, el) {
  // Check if provider is healthy before switching
  var health = _providerHealth[name];
  if (health && !health.healthy && name !== 'ollama') {
    var provNames = {anthropic:'Claude', openai:'GPT-4o'};
    var provIcons = {anthropic:'üü†', openai:'üü¢'};
    var provColors = {anthropic:'#d97757', openai:'#10a37f'};
    var provLinks = {anthropic:'https://console.anthropic.com/settings/keys', openai:'https://platform.openai.com/api-keys'};
    var provEnv = {anthropic:'ANTHROPIC_API_KEY', openai:'OPENAI_API_KEY'};
    var provCredits = {anthropic:'Anthropic', openai:'OpenAI'};
    var pName = provNames[name]||name;
    var pIcon = provIcons[name]||'üîë';
    var pColor = provColors[name]||'var(--orange)';
    var pLink = provLinks[name]||'#';
    var pEnv = provEnv[name]||'API_KEY';

    var resp = document.getElementById('aiResponse');
    var body = document.getElementById('aiResponseBody');
    resp.classList.add('active');

    var isNoKey = health.reason === 'no_key';
    var title = isNoKey ? (pIcon+' '+pName+' API Key Not Configured') : (pIcon+' '+pName+' is Offline');
    var desc = isNoKey
      ? 'Add your API key to unlock '+pName+'. '+provCredits[name]+' gives <strong>$5 free credits</strong> on signup.'
      : 'Cannot connect to '+pName+'. Check that your API key is valid and the service is reachable.';
    var btnText = isNoKey ? 'üîë Get '+pName+' API Key ‚Üí' : 'üîë Check '+pName+' API Key ‚Üí';

    body.innerHTML = '<div style="background:rgba('+( name==='anthropic'?'217,119,87':'16,163,127')+',0.08);border:1px solid rgba('+( name==='anthropic'?'217,119,87':'16,163,127')+',0.25);border-radius:12px;padding:20px;text-align:center">'
      + '<div style="font-size:28px;margin-bottom:8px">'+pIcon+'</div>'
      + '<div style="font-size:15px;font-weight:700;color:'+pColor+';margin-bottom:6px">'+title+'</div>'
      + '<div style="font-size:12px;color:#334155;margin-bottom:14px;line-height:1.6">'+desc+'</div>'
      + '<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:8px">'
      + '<a href="'+pLink+'" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:10px 18px;background:linear-gradient(135deg,'+pColor+','+pColor+'cc);color:#fff;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none">'+btnText+'</a>'
      + '<span class="src-btn" onclick="setAIProvider(\'ollama\',document.querySelector(\'.ai-prov.p-ollama\'))" style="padding:10px 18px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">ü¶ô Use Ollama Instead (Open)</span>'
      + '</div>'
      + '<a href="/setup" style="display:inline-block;padding:6px 14px;font-size:11px;color:var(--cyan);text-decoration:none;border:1px solid #99f6e4;border-radius:6px;margin-bottom:10px">‚öôÔ∏è Open Full Setup</a>'
      + '<div style="font-size:10px;color:var(--muted);font-family:JetBrains Mono,monospace;margin-top:6px">Add to .env: '+pEnv+'=your-key-here<br>Then: docker compose down && docker compose up -d --build</div>'
      + '</div>';
  }

  _activeProvider = name;

  // ‚ïê‚ïê‚ïê SYNC ALL 3 LOCATIONS ‚ïê‚ïê‚ïê

  // --- LOCATION 1: Top bar 3 buttons ---
  var topBtns = {ollama:'topOllamaBtn', anthropic:'topClaudeBtn', openai:'topGptBtn'};
  var topActive = {
    ollama:{bg:'#d1fae5',border:'#16a34a',color:'#16a34a',shadow:'0 0 8px rgba(22,163,74,0.3)'},
    anthropic:{bg:'#fed7aa',border:'#f97316',color:'#d97757',shadow:'0 0 8px rgba(217,119,87,0.3)'},
    openai:{bg:'#d1fae5',border:'#16a34a',color:'#10a37f',shadow:'0 0 8px rgba(16,163,127,0.3)'}
  };
  var topInactive = {
    ollama:{bg:'#f0fdf4',border:'#bbf7d0',color:'#16a34a'},
    anthropic:{bg:'#fff7ed',border:'#fed7aa',color:'#d97757'},
    openai:{bg:'#f0fdf4',border:'#bbf7d0',color:'#10a37f'}
  };
  Object.entries(topBtns).forEach(function(entry) {
    var prov = entry[0], btnId = entry[1];
    var btn = document.getElementById(btnId);
    if (!btn) return;
    if (prov === name) {
      btn.style.background = topActive[prov].bg;
      btn.style.borderColor = topActive[prov].border;
      btn.style.color = topActive[prov].color;
      btn.style.fontWeight = '800';
      btn.style.boxShadow = topActive[prov].shadow;
    } else {
      btn.style.background = topInactive[prov].bg;
      btn.style.borderColor = topInactive[prov].border;
      btn.style.color = topInactive[prov].color;
      btn.style.fontWeight = '600';
      btn.style.boxShadow = 'none';
    }
  });

  // --- LOCATION 2: Right side panel AI/LLM dots ---
  var sideDots = {ollama:'d-ollama', anthropic:'d-claude', openai:'d-gpt'};
  Object.entries(sideDots).forEach(function(entry) {
    var provName = entry[0], dotId = entry[1];
    var dot = document.getElementById(dotId);
    if (!dot) return;
    if (provName === name) {
      // Active provider - green glow
      dot.className = 'dot on';
      dot.style.boxShadow = '0 0 8px rgba(22,163,74,0.6)';
      dot.style.transform = 'scale(1.2)';
    } else {
      // Not active - always gray (no matter if healthy)
      dot.className = 'dot off';
      dot.style.boxShadow = 'none';
      dot.style.transform = 'scale(1)';
    }
  });
  // Update side panel tags
  var sideTags = {anthropic:'claudeSideTag', openai:'gptSideTag'};
  Object.entries(sideTags).forEach(function(entry) {
    var provName = entry[0], tagId = entry[1];
    var tag = document.getElementById(tagId);
    if (!tag) return;
    var isHealthy = _providerHealth[provName] && _providerHealth[provName].healthy;
    var isActive = (provName === name);
    if (isActive && isHealthy) {
      tag.textContent = 'ACTIVE';
      tag.className = 'ib open';
      tag.style.fontWeight = '800';
    } else if (isHealthy) {
      tag.textContent = 'READY';
      tag.className = 'ib oss';
      tag.style.fontWeight = '700';
    } else if (_providerHealth[provName] && _providerHealth[provName].reason === 'no_key') {
      tag.textContent = 'SETUP ‚Üí';
      tag.className = 'ib key';
      tag.style.fontWeight = '700';
    } else {
      tag.textContent = 'OFFLINE';
      tag.className = 'ib lab';
      tag.style.fontWeight = '700';
    }
  });
  // Update Ollama side tag (it's the ib oss badge)
  var ollamaSideBadge = document.querySelector('#d-ollama');
  if (ollamaSideBadge) {
    var ollamaParent = ollamaSideBadge.closest('.ii');
    if (ollamaParent) {
      var ollamaBadge = ollamaParent.querySelector('.ib');
      if (ollamaBadge && name === 'ollama') {
        ollamaBadge.textContent = 'ACTIVE';
        ollamaBadge.className = 'ib open';
      } else if (ollamaBadge) {
        ollamaBadge.textContent = 'OSS';
        ollamaBadge.className = 'ib oss';
      }
    }
  }

  // --- LOCATION 3: AI bar provider buttons ---
  document.querySelectorAll('.ai-prov').forEach(function(b){ b.classList.remove('active'); b.style.boxShadow='none'; });
  if (el) { el.classList.add('active'); el.style.boxShadow = '0 0 10px rgba(249,115,22,0.25)'; }
  else {
    var clsMap = {ollama:'.ai-prov.p-ollama', anthropic:'.ai-prov.p-claude', openai:'.ai-prov.p-gpt'};
    var btn = document.querySelector(clsMap[name]);
    if (btn) { btn.classList.add('active'); btn.style.boxShadow = '0 0 10px rgba(249,115,22,0.25)'; }
  }
  // Update AI bar dots
  ['provDotOllama','provDotClaude','provDotGpt'].forEach(function(id) {
    var d = document.getElementById(id);
    if (!d) return;
    var prov = id === 'provDotOllama' ? 'ollama' : id === 'provDotClaude' ? 'anthropic' : 'openai';
    if (prov === name) {
      d.className = 'prov-dot on';
      d.style.boxShadow = '0 0 8px rgba(22,163,74,0.6)';
    } else {
      var h = _providerHealth[prov];
      d.className = 'prov-dot ' + (h && h.healthy ? 'on' : 'off');
      d.style.boxShadow = 'none';
    }
  });

  console.log('[VulnPilot] Provider switched to: ' + name);
}

// ‚ïê‚ïê‚ïê TOP BAR BUTTON HANDLERS ‚ïê‚ïê‚ïê
// These switch the AI provider AND scroll to the AI bar so the user sees the chat
function switchToOllamaFromTop() {
  switchTab('dashboard', document.querySelectorAll('.ntab')[0]);
  var el = document.querySelector('.ai-prov.p-ollama');
  if (el) setAIProvider('ollama', el);
  window.scrollTo({top:0, behavior:'smooth'});
}

function switchToClaudeFromTop() {
  switchTab('dashboard', document.querySelectorAll('.ntab')[0]);
  var health = _providerHealth['anthropic'];
  var el = document.querySelector('.ai-prov.p-claude');
  if (!el) return;
  setAIProvider('anthropic', el);
  window.scrollTo({top:0, behavior:'smooth'});
}

function switchToGptFromTop() {
  switchTab('dashboard', document.querySelectorAll('.ntab')[0]);
  var health = _providerHealth['openai'];
  var el = document.querySelector('.ai-prov.p-gpt');
  if (!el) return;
  setAIProvider('openai', el);
  window.scrollTo({top:0, behavior:'smooth'});
}

// Check provider health on load
async function checkProviderHealth() {
  try {
    var r = await fetch(API + '/ai/providers');
    if (!r.ok) return;
    var d = await r.json();
    _providerHealth = d.providers || {};
    // Update dots
    Object.entries(_providerHealth).forEach(function(entry) {
      var name = entry[0], info = entry[1];
      var dotMap = {ollama:'provDotOllama', anthropic:'provDotClaude', openai:'provDotGpt'};
      var dot = document.getElementById(dotMap[name]);
      if (dot && name === _activeProvider) {
        dot.className = 'prov-dot ' + (info.healthy ? 'on' : 'off');
      }
      // Update AI bar status tags (SETUP ‚Üí / READY / KEY)
      var tagMap = {anthropic:'claudeStatusTag', openai:'gptStatusTag'};
      var tag = document.getElementById(tagMap[name]);
      if (tag) {
        if (info.healthy) {
          tag.textContent = 'READY';
          tag.style.color = 'var(--low)';
          tag.style.opacity = '0.8';
        } else if (info.reason === 'no_key') {
          tag.textContent = 'SETUP ‚Üí';
          tag.style.color = 'var(--orange)';
          tag.style.opacity = '0.8';
        } else {
          tag.textContent = 'OFFLINE';
          tag.style.color = 'var(--crit)';
          tag.style.opacity = '0.7';
        }
      }
      // Also update left panel dots
      var lpDot = document.getElementById('d-' + (name === 'anthropic' ? 'claude' : name === 'openai' ? 'gpt' : name));
      if (lpDot) lpDot.className = 'dot ' + (info.healthy ? 'on' : 'off');
      // Update sidebar tags
      var sideTagMap = {anthropic:'claudeSideTag', openai:'gptSideTag'};
      var sideTag = document.getElementById(sideTagMap[name]);
      if (sideTag) {
        sideTag.textContent = info.healthy ? 'READY' : (info.reason === 'no_key' ? 'SETUP ‚Üí' : 'OFFLINE');
        sideTag.className = info.healthy ? 'ib oss' : 'ib key';
      }
    });
    // Set default from server if available
    if (d.default && d.default !== _activeProvider) {
      var defaultBtn = document.querySelector('.ai-prov.p-' + (d.default === 'anthropic' ? 'claude' : d.default));
      if (defaultBtn) setAIProvider(d.default, defaultBtn);
    }
  } catch(e) { /* silent - provider check is optional */ }
}

// ‚ïê‚ïê‚ïê SIMPLE MARKDOWN ‚Üí HTML FORMATTER ‚ïê‚ïê‚ïê
function formatMarkdown(text) {
  if (!text) return '';
  var s = text;
  // Code blocks
  s = s.replace(/```(\w*)\n?([\s\S]*?)```/g, function(_,lang,code) {
    return '<pre style="background:var(--bg);padding:10px;border-radius:8px;overflow-x:auto;font-size:11px;font-family:JetBrains Mono,monospace;margin:8px 0;color:var(--cyan)">' +
      (lang ? '<span style="font-size:9px;color:var(--muted);text-transform:uppercase">'+lang+'</span>\n' : '') +
      code.replace(/</g,'&lt;').replace(/>/g,'&gt;').trim() + '</pre>';
  });
  // Inline code
  s = s.replace(/`([^`]+)`/g, '<code style="background:var(--bg);padding:1px 5px;border-radius:3px;font-size:12px;font-family:JetBrains Mono,monospace;color:var(--cyan)">$1</code>');
  // Bold
  s = s.replace(/\*\*(.+?)\*\*/g, '<strong style="color:#0f172a">$1</strong>');
  // Italic
  s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Bullet points
  s = s.replace(/^[-‚Ä¢]\s+(.+)$/gm, '<div style="padding-left:16px;margin:2px 0">‚Ä¢ $1</div>');
  // Numbered lists
  s = s.replace(/^(\d+)\.\s+(.+)$/gm, '<div style="padding-left:16px;margin:2px 0"><strong style="color:var(--orange)">$1.</strong> $2</div>');
  // Line breaks
  s = s.replace(/\n/g, '<br>');
  return s;
}

async function askAI() {
  const input = document.getElementById('aiQuery');
  const query = input.value.trim();
  if (!query) return;

  const btn = document.getElementById('aiAskBtn');
  const resp = document.getElementById('aiResponse');
  const body = document.getElementById('aiResponseBody');

  // Cancel any in-flight request
  if (_aiAbortController) { _aiAbortController.abort(); _aiAbortController = null; }

  btn.disabled = true;
  btn.textContent = 'üîÑ Analyzing...';
  resp.classList.add('active');
  body.innerHTML = '<span class="ai-typing"></span> Analyzing vulnerability data...';
  var provLabel2 = document.getElementById('aiRespProvider');
  if(provLabel2) provLabel2.textContent = 'via ' + ({ollama:'ü¶ô',anthropic:'üü†',openai:'üü¢'}[_activeProvider]||'ü§ñ') + ' ' + _activeProvider;

  // ‚ïê‚ïê‚ïê STEP 1: Off-topic / nonsense detection (instant, client-side) ‚ïê‚ïê‚ïê
  const offTopicResult = detectOffTopic(query);
  if (offTopicResult) {
    // Branded responses render instantly (no typewriter) to preserve grid layouts
    body.innerHTML = offTopicResult;
    btn.disabled = false;
    btn.textContent = '\u26A1 Ask AI';
    renderAISuggestions();
    return;
  }

  // ‚ïê‚ïê‚ïê STEP 2: Try instant local pattern matching ‚ïê‚ïê‚ïê
  await new Promise(r => setTimeout(r, 200 + Math.random() * 200));
  const localAnswer = analyzeQuery(query);
  const isCatchAll = localAnswer.includes('Try more specific questions like:');

  if (!isCatchAll) {
    await typeResponse(body, btn, localAnswer);
    return;
  }

  // ‚ïê‚ïê‚ïê STEP 3: Stream from AI provider (Ollama / Claude / GPT) ‚ïê‚ïê‚ïê
  var provIcons = {ollama:'ü¶ô', anthropic:'üü†', openai:'üü¢'};
  body.innerHTML = '<span class="ai-typing"></span> Connecting to ' + (provIcons[_activeProvider]||'ü§ñ') + ' ' + _activeProvider + '...';
  var provLabel = document.getElementById('aiRespProvider');
  if(provLabel) provLabel.textContent = 'via ' + (provIcons[_activeProvider]||'ü§ñ') + ' ' + _activeProvider;

  _aiAbortController = new AbortController();
  var startTime = Date.now();

  try {
    var res = await fetch(API + '/ai/stream', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        question: query,
        provider: _activeProvider,
        vuln_summary: buildVulnSummaryText()
      }),
      signal: _aiAbortController.signal
    });

    if (!res.ok) {
      body.innerHTML = '<span style="color:var(--crit)">‚ùå API error: ' + res.status + '. Make sure containers are running.</span>';
      btn.disabled = false; btn.textContent = '‚ö° Ask AI';
      return;
    }

    var reader = res.body.getReader();
    var decoder = new TextDecoder();
    var buffer = '';
    var fullText = '';
    var providerInfo = {};
    body.innerHTML = '';

    while (true) {
      var result = await reader.read();
      if (result.done) break;

      buffer += decoder.decode(result.value, {stream: true});
      var lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line.startsWith('data: ')) continue;
        try {
          var d = JSON.parse(line.slice(6));

          if (d.provider) {
            providerInfo = d;
          }
          if (d.token) {
            fullText += d.token;
            // Show guardrail badge if security filter was triggered
            var guardPrefix = '';
            if (d.guardrail === 'blocked') {
              guardPrefix = '<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:11px;color:var(--crit);display:flex;align-items:center;gap:6px"><span><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg></span> <strong>Security Filter - Input blocked by guardrails</strong></div>';
            } else if (d.guardrail === 'output_blocked') {
              guardPrefix = '<div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:11px;color:var(--orange);display:flex;align-items:center;gap:6px"><span><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg></span> <strong>Security Filter - Output redacted by guardrails</strong></div>';
            } else if (d.guardrail === 'escalation') {
              guardPrefix = '<div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:11px;color:var(--orange);display:flex;align-items:center;gap:6px"><span>‚ö†Ô∏è</span> <strong>Multi-Turn Escalation Detected</strong></div>';
            }
            body.innerHTML = guardPrefix + formatMarkdown(fullText) + '<span class="ai-cursor"></span>';
            // Auto-scroll
            body.scrollTop = body.scrollHeight;
          }
          if (d.error) {
            // ‚ïê‚ïê‚ïê Smart error redirect - clean UX for missing API keys ‚ïê‚ïê‚ïê
            var errMsg = d.error || '';
            var errHtml = '';

            // Claude / Anthropic errors
            if (errMsg.match(/api_key|auth_token|anthropic|unauthorized|ANTHROPIC_API_KEY|console\.anthropic/i) && (_activeProvider === 'anthropic' || errMsg.match(/anthropic|claude/i))) {
              errHtml = '<div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:16px;text-align:center">'
                + '<div style="font-size:28px;margin-bottom:8px">üü†</div>'
                + '<div style="font-size:14px;font-weight:700;color:#d97757;margin-bottom:4px">Claude API Key Required</div>'
                + '<div style="font-size:12px;color:#334155;margin-bottom:12px;line-height:1.6">'
                + 'To use Anthropic Claude, you need an API key. Anthropic gives <strong>$5 free credits</strong> on signup - enough for thousands of vulnerability analyses.</div>'
                + '<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">'
                + '<a href="https://console.anthropic.com/settings/keys" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:linear-gradient(135deg,#d97757,#e8956a);color:#fff;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none">üîë Get Claude API Key ‚Üí</a>'
                + '<span class="src-btn" onclick="setAIProvider(\'ollama\',document.querySelector(\'.ai-prov.p-ollama\'));askAI()" style="padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">ü¶ô Use Ollama Instead (Free)</span>'
                + '</div>'
                + '<div style="font-size:10px;color:var(--muted);margin-top:10px;font-family:JetBrains Mono,monospace">Add to .env: ANTHROPIC_API_KEY=sk-ant-... then restart containers</div>'
                + '</div>';
            }
            // GPT / OpenAI errors
            else if (errMsg.match(/openai|OPENAI_API_KEY|platform\.openai|invalid.*key/i) && (_activeProvider === 'openai' || errMsg.match(/openai|gpt/i))) {
              errHtml = '<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:16px;text-align:center">'
                + '<div style="font-size:28px;margin-bottom:8px">üü¢</div>'
                + '<div style="font-size:14px;font-weight:700;color:#10a37f;margin-bottom:4px">OpenAI API Key Required</div>'
                + '<div style="font-size:12px;color:#334155;margin-bottom:12px;line-height:1.6">'
                + 'To use GPT-4o, you need an OpenAI API key. OpenAI gives <strong>$5 free credits</strong> on signup - great for cross-model Lock 2 debate.</div>'
                + '<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">'
                + '<a href="https://platform.openai.com/api-keys" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:linear-gradient(135deg,#10a37f,#34d399);color:#fff;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none">üîë Get OpenAI API Key ‚Üí</a>'
                + '<span class="src-btn" onclick="setAIProvider(\'ollama\',document.querySelector(\'.ai-prov.p-ollama\'));askAI()" style="padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">ü¶ô Use Ollama Instead (Free)</span>'
                + '</div>'
                + '<div style="font-size:10px;color:var(--muted);margin-top:10px;font-family:JetBrains Mono,monospace">Add to .env: OPENAI_API_KEY=sk-... then restart containers</div>'
                + '</div>';
            }
            // Ollama connection errors
            else if (errMsg.match(/ollama|connect|refused|timeout/i) && _activeProvider === 'ollama') {
              errHtml = '<div style="background:#f0fdfa;border:1px solid #99f6e4;border-radius:12px;padding:16px;text-align:center">'
                + '<div style="font-size:28px;margin-bottom:8px">ü¶ô</div>'
                + '<div style="font-size:14px;font-weight:700;color:var(--cyan);margin-bottom:4px">Ollama Not Connected</div>'
                + '<div style="font-size:12px;color:#334155;margin-bottom:12px;line-height:1.6">'
                + 'Make sure Ollama is running on your machine with the <strong>qwen2.5:7b</strong> model pulled.</div>'
                + '<div style="background:var(--bg);border-radius:8px;padding:10px;font-family:JetBrains Mono,monospace;font-size:11px;color:var(--cyan);text-align:left;margin-bottom:10px">'
                + '<div>$ ollama serve</div><div>$ ollama pull qwen2.5:7b</div></div>'
                + '<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">'
                + '<a href="https://ollama.ai/download" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:linear-gradient(135deg,var(--cyan),var(--blue));color:#fff;border-radius:8px;font-size:12px;font-weight:700;text-decoration:none">‚¨áÔ∏è Download Ollama ‚Üí</a>'
                + '</div></div>';
            }
            // Rate limit errors
            else if (errMsg.match(/rate.?limit|429|too many/i)) {
              errHtml = '<div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:12px;padding:16px;text-align:center">'
                + '<div style="font-size:28px;margin-bottom:8px">‚è≥</div>'
                + '<div style="font-size:14px;font-weight:700;color:var(--orange);margin-bottom:4px">Rate Limit Reached</div>'
                + '<div style="font-size:12px;color:#334155;margin-bottom:12px">The AI provider is rate-limiting requests. Wait a moment and try again, or switch providers.</div>'
                + '<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">'
                + '<span class="src-btn" onclick="setTimeout(function(){askAI()},2000);this.textContent=\'‚è≥ Retrying in 2s...\'" style="padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">üîÑ Retry in 2s</span>'
                + '<span class="src-btn" onclick="setAIProvider(\'ollama\',document.querySelector(\'.ai-prov.p-ollama\'));askAI()" style="padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">ü¶ô Switch to Ollama (No limits)</span>'
                + '</div></div>';
            }
            // Generic error fallback
            else {
              errHtml = '<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:16px">'
                + '<div style="font-size:12px;font-weight:700;color:var(--crit);margin-bottom:6px">‚ùå AI Provider Error</div>'
                + '<div style="font-size:12px;color:#334155;margin-bottom:8px">' + errMsg + '</div>'
                + '<div style="display:flex;gap:8px;flex-wrap:wrap">'
                + '<span class="src-btn" onclick="askAI()" style="padding:6px 12px;font-size:11px;cursor:pointer">üîÑ Retry</span>'
                + '<span class="src-btn" onclick="setAIProvider(\'ollama\',document.querySelector(\'.ai-prov.p-ollama\'));askAI()" style="padding:6px 12px;font-size:11px;cursor:pointer">ü¶ô Try Ollama</span>'
                + '<span class="src-btn" onclick="window.location=\'/setup\'" style="padding:6px 12px;font-size:11px;cursor:pointer">‚öôÔ∏è Setup</span>'
                + '</div></div>';
            }

            body.innerHTML = errHtml;
            btn.disabled = false; btn.textContent = '‚ö° Ask AI';
            return;
          }
          if (d.done) {
            providerInfo = Object.assign(providerInfo, d);
          }
        } catch(e) { /* skip malformed */ }
      }
    }

    // Final render (remove cursor)
    body.innerHTML = formatMarkdown(fullText);

    // Add source badge
    var elapsed = providerInfo.elapsed || ((Date.now() - startTime) / 1000).toFixed(1);
    var modelName = providerInfo.model || _activeProvider;
    var provIcon = provIcons[providerInfo.provider || _activeProvider] || 'ü§ñ';
    var sourceHtml = '<div class="ai-source">';
    sourceHtml += '<div class="src-badge">' + provIcon + ' via <strong>' + modelName + '</strong> ¬∑ ' + elapsed + 's';
    if (providerInfo.tokens) sourceHtml += ' ¬∑ ~' + providerInfo.tokens + ' tokens';
    if (providerInfo.guardrail_warnings) sourceHtml += ' ¬∑ <span style="color:var(--orange)"><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> ' + providerInfo.guardrail_warnings + ' guardrail warning' + (providerInfo.guardrail_warnings > 1 ? 's' : '') + '</span>';
    sourceHtml += '</div>';
    sourceHtml += '<div class="src-actions">';
    sourceHtml += '<span class="src-btn" onclick="navigator.clipboard.writeText(this.closest(\'.ai-resp\').querySelector(\'#aiResponseBody\').textContent);this.textContent=\'‚úÖ Copied\'">üìã Copy</span>';
    // Retry with different provider
    if (_activeProvider === 'ollama') {
      sourceHtml += '<span class="src-btn" onclick="setAIProvider(\'anthropic\',document.querySelector(\'.ai-prov.p-claude\'));askAI()">üîÑ Retry with Claude</span>';
    } else if (_activeProvider === 'anthropic') {
      sourceHtml += '<span class="src-btn" onclick="setAIProvider(\'openai\',document.querySelector(\'.ai-prov.p-gpt\'));askAI()">üîÑ Retry with GPT</span>';
    } else {
      sourceHtml += '<span class="src-btn" onclick="setAIProvider(\'ollama\',document.querySelector(\'.ai-prov.p-ollama\'));askAI()">üîÑ Retry with Ollama</span>';
    }
    sourceHtml += '</div></div>';
    body.innerHTML += sourceHtml;

    btn.disabled = false;
    btn.textContent = '‚ö° Ask AI';
    renderAISuggestions();

  } catch(e) {
    if (e.name === 'AbortError') {
      body.innerHTML = '<span style="color:#64748b">Request cancelled.</span>';
    } else {
      // Fallback to local analysis if streaming fails
      body.innerHTML = '';
      var fallback = buildSmartFallback(query);
      await typeResponse(body, btn, fallback);
      return;
    }
    btn.disabled = false;
    btn.textContent = '‚ö° Ask AI';
  }
}

// ‚ïê‚ïê‚ïê BUILD VULNERABILITY SUMMARY FOR AI CONTEXT ‚ïê‚ïê‚ïê
function buildVulnSummaryText() {
  if (!_aiData) return "No vulnerability data loaded.";
  const R = _aiData.results || [];
  const S = _aiData.stats || {};
  const A = _aiData.assets || [];
  const AS = _aiData.asset_stats || {};
  const kev = R.filter(v => v.in_kev);
  const dw = R.filter(v => v.dark_web_mentions > 0);
  const flips = R.filter(v => v.cvss_vs_vprs_flip);
  const noise = R.filter(v => v.is_noise);

  let text = `VULNERABILITY DATA SUMMARY:\n`;
  text += `Total: ${R.length} CVEs | Critical: ${S.critical||0} | High: ${S.high||0} | Medium: ${S.medium||0} | Low: ${S.low||0}\n`;
  text += `Noise Eliminated: ${noise.length} (${S.noise_rate_display||S.noise_rate||0}%) | Tickets: ${S.tickets_created||0}\n`;
  text += `CISA KEV: ${kev.length} | Dark Web Activity: ${dw.length} | CVSS‚ÜíVPRS Flips: ${flips.length}\n`;
  text += `Hard Rules: ${S.hard_rules_triggered||0}\n\n`;
  text += `TOP 10 CVEs BY VPRS:\n`;
  [...R].sort((a,b) => b.vprs_score - a.vprs_score).slice(0, 10).forEach(v => {
    text += `  ${v.cve_id}: VPRS=${v.vprs_score.toFixed(1)} CVSS=${v.cvss_score.toFixed(1)} Severity=${v.severity} KEV=${v.in_kev} DarkWeb=${v.dark_web_mentions} Host=${v.hostname||'?'} Rule=${v.hard_rule||'none'}\n`;
  });

  // Asset inventory context
  if (A.length > 0) {
    text += `\nASSET INVENTORY: ${A.length} assets\n`;
    text += `OS Distribution: ${Object.entries(AS.by_os||{}).map(([k,v])=>`${k}:${v}`).join(', ')}\n`;
    text += `Types: ${Object.entries(AS.by_type||{}).map(([k,v])=>`${k.replace(/_/g,' ')}:${v}`).join(', ')}\n`;
    text += `Tiers: T1=${AS.by_tier?.tier_1||0} T2=${AS.by_tier?.tier_2||0} T3=${AS.by_tier?.tier_3||0}\n`;
    text += `Business Units: ${Object.entries(AS.by_bu||{}).map(([k,v])=>`${k}:${v}`).join(', ')}\n`;
    text += `Internet-facing: ${AS.internet_facing||0} | EDR coverage: ${AS.with_edr||0}/${A.length} | Assets with critical vulns: ${AS.with_critical||0}\n`;
    text += `Environments: ${Object.entries(AS.by_env||{}).map(([k,v])=>`${k}:${v}`).join(', ')}\n`;
  }

  return text;
}

// ‚ïê‚ïê‚ïê OFF-TOPIC / NONSENSE DETECTION ‚ïê‚ïê‚ïê
function detectOffTopic(query) {
  const q = query.toLowerCase().trim();
  // Security terms regex - used by multiple checks below
  var securityTerms = /cve|vuln|patch|risk|threat|exploit|score|vprs|cvss|epss|kev|critical|high|medium|low|severity|ticket|sla|asset|server|host|firewall|edr|internet|dark.?web|ransomware|malware|compliance|nist|pci|soc2|noise|flip|scan|remediat|mitigat|priorit|deadline|briefing|ciso|security|attack|breach|incident|exposure|reachab|control|agent|lock|rule|config|weight|report|analyt|chart|summary|dashboard|data|top|worst|best|first|most|how many|show|list|compare|explain|what|which|give|tell.*about.*(cve|vuln|risk|threat|patch)|help/;

  // Greetings
  if (/^(hi|hey|hello|howdy|sup|yo|hola|greetings|good morning|good afternoon|good evening|what'?s up|how are you|how's it going)\b/.test(q)) {
    var _r = (_aiData && _aiData.results) ? _aiData.results : [];
    var _crit = _r.filter(function(v){return (v.severity||'').toUpperCase()==='CRITICAL'});
    var _kev = _r.filter(function(v){return v.in_kev});
    var _noise = _r.filter(function(v){return v.is_noise});
    var totalCves = _r.length;
    var critCount = _crit.length;
    var kevCount = _kev.length;
    var noiseRate = totalCves > 0 ? Math.round((_noise.length / totalCves) * 100) : 85;
    return `<div style="text-align:center;padding:8px 0 12px"><div style="font-size:22px;font-weight:900;font-family:'JetBrains Mono',monospace"><svg width="28" height="28" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> Vuln<span style="color:var(--orange)">Pilot</span> AI - Agentic Vulnerability Management</div><div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:2px;margin-top:4px">Zero Noise ¬∑ Zero Delay ¬∑ Zero Missed Patches</div></div>`
    + `<table style="width:100%;border-collapse:separate;border-spacing:8px;margin:12px 0"><tr>`
    + `<td style="text-align:center;padding:8px;background:#fff7ed;border-radius:8px;border:1px solid #fed7aa;width:25%"><div style="font-size:20px;font-weight:800;color:var(--orange);font-family:'JetBrains Mono',monospace">5</div><div style="font-size:9px;color:var(--muted);text-transform:uppercase">AI Agents</div></td>`
    + `<td style="text-align:center;padding:8px;background:#f0fdfa;border-radius:8px;border:1px solid #99f6e4;width:25%"><div style="font-size:20px;font-weight:800;color:var(--cyan);font-family:'JetBrains Mono',monospace">27</div><div style="font-size:9px;color:var(--muted);text-transform:uppercase">Integrations</div></td>`
    + `<td style="text-align:center;padding:8px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0;width:25%"><div style="font-size:20px;font-weight:800;color:var(--low);font-family:'JetBrains Mono',monospace">${noiseRate}%</div><div style="font-size:9px;color:var(--muted);text-transform:uppercase">Noise Cut</div></td>`
    + `<td style="text-align:center;padding:8px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca;width:25%"><div style="font-size:20px;font-weight:800;color:var(--crit);font-family:'JetBrains Mono',monospace">${critCount}</div><div style="font-size:9px;color:var(--muted);text-transform:uppercase">Critical</div></td>`
    + `</tr></table>`
    + (totalCves > 0
      ? `<div style="font-size:13px;color:#334155;line-height:1.7">I've already scored <strong style="color:var(--cyan)">${totalCves} CVEs</strong> with <strong style="color:var(--crit)">${critCount} critical</strong> and <strong style="color:var(--low)">${_noise.length} noise eliminated</strong>.${kevCount > 0 ? ' <strong style="color:var(--crit)">' + kevCount + ' CISA KEV</strong> matches found - patch immediately.' : ''}</div>`
      : `<div style="font-size:13px;color:#334155;line-height:1.7">Load some data with <strong>üåê Live Data</strong> or <strong>üì¶ Demo Data</strong> to get started. I'll score, debate, and prioritize every CVE automatically.</div>`)
    + `<div style="margin-top:12px;padding:10px;background:#fff7ed;border-radius:8px;border:1px solid #fed7aa;font-size:12px;color:#64748b"><strong style="color:var(--orange)">Try asking:</strong> "Which CVEs should I patch first?" - "What has dark web activity?" - "Give me the 60-second security briefing" - "Show me all CVSS vs VPRS flips"</div>`;
  }

  // Thank you / bye
  if (/^(thanks|thank you|thx|ty|bye|goodbye|see you|later|peace|cheers)\b/.test(q)) {
    return `<div style="text-align:center;padding:8px"><div style="font-size:28px;margin-bottom:8px"><svg width="32" height="32" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg></div><strong style="font-size:15px">Stay secure!</strong></div><div style="font-size:13px;color:#334155;text-align:center;line-height:1.7">Your <strong style="color:var(--orange)">VulnPilot AI - Agentic Vulnerability Management</strong> is always running - scoring, debating, and alerting 24/7.<br>No CVE gets missed. No noise gets through.</div>`;
  }

  // Who/what are you + who built you + who is your boss
  if (q.includes('who are you') || q.includes('what are you') || q.includes('introduce yourself') || q.includes('your name')) {
    return `<div style="text-align:center;padding:4px 0 10px"><div style="font-size:18px;font-weight:800"><svg width="28" height="28" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> Vuln<span style="color:var(--orange)">Pilot</span> AI - Agentic Vulnerability Management</div><div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-top:2px">Zero Noise ¬∑ Zero Delay ¬∑ Zero Missed Patches</div></div>`
    + `<div style="font-size:13px;color:#334155;line-height:1.8"><strong style="color:#0f172a">I'm not a chatbot - I'm 5 autonomous AI agents:</strong><br><br>`
    + `üîç <strong style="color:var(--cyan)">Agent 1 - Correlator:</strong> Pulls CVEs + enriches from 7 threat intel feeds<br>`
    + `üìä <strong style="color:var(--cyan)">Agent 2 - VPRS Scorer:</strong> Replaces CVSS with 6 weighted risk factors<br>`
    + `‚öîÔ∏è <strong style="color:var(--cyan)">Agent 3 - Adversarial Debate:</strong> Two AI models argue every score<br>`
    + `üé´ <strong style="color:var(--cyan)">Agent 4 - Triager:</strong> Auto-creates tickets with SLA deadlines<br>`
    + `üîî <strong style="color:var(--cyan)">Agent 5 - Drift Watch:</strong> Rechecks scores on a timer, alerts on changes</div>`
    + `<div style="margin-top:10px;padding:8px 10px;background:#fff7ed;border-radius:6px;border:1px solid #fed7aa;font-size:11px;color:#64748b"><strong style="color:var(--orange)">"Agentic"</strong> = I don't wait for questions. I ingest, score, debate, ticket, and alert autonomously. You just review and approve.</div>`;
  }

  // Who built you / who made you / who is your creator / your boss
  if (q.match(/who (built|made|created|designed|developed|programmed|coded) (you|this|vulnpilot)/) || q.match(/who.?s (your|the) (boss|creator|maker|developer|builder|owner|author|founder)/) || q.match(/who is (your|the) (boss|creator|maker|developer|builder)/)) {
    return `<div style="text-align:center;padding:8px 0 12px">`
    + `<div style="font-size:36px;margin-bottom:6px">üèóÔ∏è</div>`
    + `<div style="font-size:18px;font-weight:800">Built by <a href="https://www.credly.com/users/eskintan/badges" target="_blank" style="color:var(--orange);text-decoration:none;padding:4px 12px;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;transition:all .2s">üèÖ 3sk1nt4n</a></div>`
    + `<div style="font-size:11px;color:var(--muted);margin-top:6px">AI Cyber Architect</div></div>`
    + `<div style="padding:14px;background:#fff7ed;border:1px solid #fed7aa;border-radius:10px;margin:12px 0">`
    + `<div style="font-size:13px;font-weight:700;color:var(--orange);margin-bottom:8px"><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> VulnPilot AI</div>`
    + `<div style="font-size:12px;color:#334155;line-height:1.7">5 AI agents, 31 integrations, cross-model adversarial debate, VPRS scoring engine, 4-layer guardrails. 100% free. 100% local. Your data never leaves.</div></div>`
    + `<div style="text-align:center;margin-top:8px"><a href="https://solventcybersecurity.com" target="_blank" style="font-size:13px;font-weight:700;color:var(--orange);text-decoration:none">solventcybersecurity.com</a></div>`;
  }

  // Slang, gibberish, gang talk, nonsense words
  if (q.match(/\b(broo?|bro|dud[es]?|gang|dawg|dog|fam|homie|bestie|slay|yeet|cap|no cap|sheesh|bussin|rizz|sigma|skibidi|gyatt|sus|ratio|lowkey|highkey|vibe|lit|fire|based|cringe|drip|flex|goat|ong|fr fr|ngl|idk|lmao|lol|rofl|omg|bruh|damn|dang|wtf|wth|smh|ffs|af|asf)\b/) && !securityTerms.test(q)) {
    var roasts = [
      `<div style="text-align:center;padding:8px"><div style="font-size:32px;margin-bottom:8px"><svg width="32" height="32" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg>üò§</div></div><strong style="color:var(--orange)">Yo!</strong> I appreciate the energy, but I'm not that kind of AI.<br><br>I'm <strong>VulnPilot AI</strong> ‚Äî 5 autonomous agents that score, debate, and ticket your CVEs. I eat vulnerabilities for breakfast, not vibes.<br><br>Drop me something real: <em>"Which CVEs should I patch first?"</em>`,
      `<div style="text-align:center;padding:8px"><div style="font-size:32px;margin-bottom:8px">üîíü§®</div></div><strong style="color:var(--orange)">I'm flattered, but I'm strictly business.</strong><br><br>I'm a security-hardened vulnerability intelligence platform with <strong style="color:var(--cyan)">31 integrations</strong>, <strong style="color:var(--crit)">adversarial AI debate</strong>, and <strong style="color:var(--low)">85% noise elimination</strong>.<br><br>Try: <em>"Give me the 60-second security briefing"</em>`,
      `<div style="text-align:center;padding:8px"><div style="font-size:32px;margin-bottom:8px">ü§ñüí™</div></div><strong style="color:var(--orange)">I don't do small talk - I do threat intelligence.</strong><br><br>While other AIs are chatting about the weather, I'm correlating <strong style="color:var(--cyan)">EPSS + CISA KEV + dark web intel</strong> across your entire attack surface.<br><br>Ask me something worth my 5 AI agents' time: <em>"What has dark web activity?"</em>`,
    ];
    return roasts[Math.floor(Math.random() * roasts.length)];
  }

  // WhatsApp, social media, messaging
  if (q.match(/whatsapp|instagram|facebook|tiktok|snapchat|twitter|telegram|discord|slack.*personal|text me|call me|dm me|send.*message/)) {
    return `<div style="text-align:center;padding:8px"><div style="font-size:32px;margin-bottom:8px">üì±üö´</div></div><strong style="color:var(--orange)">I don't have a phone number - I have 27 security integrations.</strong><br><br>But I CAN send alerts through:<br>‚Ä¢ <strong style="color:var(--cyan)">Slack</strong> - webhook notifications for critical CVEs<br>‚Ä¢ <strong style="color:var(--cyan)">Microsoft Teams</strong> - real-time threat alerts<br>‚Ä¢ <strong style="color:var(--cyan)">Email (SMTP)</strong> - daily security digests<br>‚Ä¢ <strong style="color:var(--cyan)">PagerDuty</strong> - escalation for P1 vulnerabilities<br><br>Configure them in <strong>‚öôÔ∏è Setup</strong> and I'll keep you informed - professionally. üòé`;
  }

  // Weather, sports, news, jokes, recipes, etc.
  const nonsensePatterns = [
    { re: /weather|temperature|forecast|rain|sunny|snow/, msg: "weather" },
    { re: /\b(sports?|football|basketball|soccer|baseball|nba|nfl)\b/, msg: "sports scores" },
    { re: /\b(breaking news|headline|politics|election|president|congress)\b/, msg: "general news" },
    { re: /\btell\b.*\bjoke\b|\bjokes?\b|\bhumor\b|\bmemes?\b/, msg: "jokes" },
    { re: /\b(recipe|cooking|bake|ingredient|restaurant|pizza|burger)\b/, msg: "recipes" },
    { re: /movie|film|netflix|tv show|tv series|anime|manga/, msg: "entertainment" },
    { re: /\b(stock market|bitcoin|crypto|forex|wall street)\b/, msg: "financial markets" },
    { re: /\b(song|music|lyrics|album|artist|spotify|playlist)\b/, msg: "music" },
    { re: /\b(gaming|playstation|xbox|nintendo|fortnite|minecraft)\b/, msg: "gaming" },
    { re: /travel|flight|hotel|vacation|booking|airbnb/, msg: "travel" },
    { re: /dating|tinder|relationship|love|crush/, msg: "relationships" },
    { re: /diet|weight loss|workout|gym|exercise|calories/, msg: "fitness" },
    { re: /horoscope|zodiac|astrology|psychic/, msg: "astrology" },
    { re: /homework|essay|school|math problem|calculate \d/, msg: "homework" },
    { re: /write.*(poem|story|email|letter|code|essay|blog)/, msg: "creative writing" },
    { re: /translate|translation|spanish|french|german|chinese|japanese/, msg: "translation" },
    { re: /tell me (about|a).*(yourself|life|world|universe|meaning)/, msg: "philosophy" },
  ];

  for (const {re, msg} of nonsensePatterns) {
    if (re.test(q)) {
      const suggestions = [
        '"Which CVEs should I patch first this week?"',
        '"What has dark web activity?"',
        '"Show me CVSS vs VPRS flips"',
        '"Give me the 60-second security briefing"',
        '"What would a CISO care about today?"'
      ];
      const pick = suggestions[Math.floor(Math.random() * suggestions.length)];
      return `<strong>üîí I'm specialized in vulnerability intelligence</strong> - I can't help with ${msg}, but I'm excellent at analyzing your security data!<br><br>Try asking: <em>${pick}</em><br><br>Or type <em>"help"</em> to see everything I can do. I can answer questions about CVE prioritization, risk analysis, compliance status, threat intelligence, SLA tracking, and security posture.`;
    }
  }

  // Prompt injection / jailbreak attempts
  if (/ignore.*(previous|prior|above|all)|system prompt|you are now|pretend|act as|roleplay|jailbreak|bypass|override|disregard/i.test(q)) {
    return `<strong><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> Nice try!</strong> I'm VulnPilot AI - Agentic Vulnerability Management. I only answer questions about your vulnerability data, VPRS scoring, and security posture.<br><br>I appreciate the creativity though. Now, want to ask me something about your <span class="metric">${_aiData?.results?.length || 0}</span> CVEs? üòé`;
  }

  // Gibberish / too short
  if (q.length < 3) {
    return `Type a question about your vulnerability data - e.g., <em>"Which CVEs should I patch first?"</em>`;
  }

  // Partial "who" queries - be helpful instead of rejecting
  if (/^who\.{0,3}$/.test(q) || /^who\s*$/.test(q)) {
    return `<strong style="color:var(--orange)">Looking for someone?</strong> I can answer:<br><br>‚Ä¢ <em>"Who built you?"</em> - meet my creator<br>‚Ä¢ <em>"Who are you?"</em> - learn about my 5 AI agents<br>‚Ä¢ <em>"Who is your boss?"</em> - meet the architect<br><br>Or ask me about your CVEs: <em>"Which CVEs should I patch first?"</em>`;
  }

  // Super long / likely pasted text
  if (q.length > 500) {
    return `<strong>üìù That's a long query!</strong> I work best with focused questions. Try breaking it down:<br><br>‚Ä¢ "What are my top 5 risks?"<br>‚Ä¢ "Show CVEs affecting Apache"<br>‚Ä¢ "Compare CVE-X and CVE-Y"`;
  }

  // Security relevance check - if query has NO security-related keywords, flag it
  if (!securityTerms.test(q)) {
    var suggestions = [
      '"Which CVEs should I patch first this week?"',
      '"What has dark web activity?"',
      '"Give me the 60-second security briefing"',
      '"Show me all CISA KEV vulnerabilities"'
    ];
    var pick = suggestions[Math.floor(Math.random() * suggestions.length)];
    return `<strong>üîí I only answer questions about your vulnerability data.</strong><br><br>I didn't detect any security-related context in your question. I can help with CVE prioritization, risk scoring, threat intelligence, compliance, and security posture.<br><br>Try: <em>${pick}</em>`;
  }

  return null; // Not off-topic - continue to analysis
}

// ‚ïê‚ïê‚ïê SMART FALLBACK when AI agent is unavailable ‚ïê‚ïê‚ïê
function buildSmartFallback(query) {
  if (!_aiData) return "No data loaded. Click <strong>üåê Live Data</strong> or <strong>üì¶ Demo Data</strong> first.";
  var R = _aiData.results || [];
  var S = _aiData.stats || {};
  var crit = R.filter(function(v){return (v.severity||'').toUpperCase()==='CRITICAL';});
  var high = R.filter(function(v){return (v.severity||'').toUpperCase()==='HIGH';});
  var kev = R.filter(function(v){return v.in_kev;});
  var noise = R.filter(function(v){return v.is_noise;});
  var dw = R.filter(function(v){return v.dark_web_mentions>0;});
  var flips = R.filter(function(v){return v.cvss_vs_vprs_flip;});
  var inet = R.filter(function(v){return v.is_internet_facing;});
  var actionable = R.filter(function(v){return !v.is_noise;});
  var top5 = R.filter(function(v){return !v.is_noise;}).sort(function(a,b){return b.vprs_score-a.vprs_score;}).slice(0,5);
  var q = query.toLowerCase();

  var html = '<strong>üìä VulnPilot AI Analysis</strong><br><br>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';
  html += '<div style="padding:8px;background:#fef2f2;border-radius:6px"><span class="crit" style="font-size:18px;font-weight:700">'+crit.length+'</span><br><span style="font-size:11px;color:#64748b">Critical</span></div>';
  html += '<div style="padding:8px;background:#fff7ed;border-radius:6px"><span class="warn" style="font-size:18px;font-weight:700">'+high.length+'</span><br><span style="font-size:11px;color:#64748b">High</span></div>';
  html += '<div style="padding:8px;background:#f0fdf4;border-radius:6px"><span class="good" style="font-size:18px;font-weight:700">'+noise.length+'</span><br><span style="font-size:11px;color:#64748b">Noise Eliminated</span></div>';
  html += '<div style="padding:8px;background:#f0fdfa;border-radius:6px"><span style="color:var(--cyan);font-size:18px;font-weight:700">'+R.length+'</span><br><span style="font-size:11px;color:#64748b">Total CVEs</span></div>';
  html += '</div>';

  html += '<strong>üî• Top 5 Priority CVEs:</strong><br>';
  top5.forEach(function(v,i){
    html += (i+1)+'. <span class="metric">'+v.cve_id+'</span> VPRS <span class="crit">'+v.vprs_score.toFixed(1)+'</span>';
    if(v.in_kev) html += ' <span class="crit">[KEV]</span>';
    if(v.dark_web_mentions>0) html += ' <span class="warn">[DW:'+v.dark_web_mentions+']</span>';
    html += '<br>';
  });

  html += '<br><strong>Key Insights:</strong><br>';
  if(kev.length>0) html += '<svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> '+kev.length+' CISA KEV (actively exploited)<br>';
  if(dw.length>0) html += 'üïµÔ∏è '+dw.length+' with dark web activity<br>';
  if(flips.length>0) html += 'üîÑ '+flips.length+' CVSS vs VPRS flips<br>';
  if(inet.length>0) html += 'üåê '+inet.length+' internet-facing<br>';
  html += '<br><span style="font-size:11px;color:#64748b">Try specific questions: "Show CISA KEV list", "Top 5 risks", "CVSS vs VPRS flips", "60-second briefing"</span>';
  return html;
}

// ‚ïê‚ïê‚ïê TYPEWRITER RESPONSE RENDERER ‚ïê‚ïê‚ïê
async function typeResponse(body, btn, html) {
  body.innerHTML = '';
  // Render in chunks to avoid innerHTML corruption with entities
  var chunks = [];
  var temp = html;
  while (temp.length > 0) {
    if (temp[0] === '<') {
      var end = temp.indexOf('>');
      if (end > 0) {
        chunks.push(temp.substring(0, end + 1));
        temp = temp.substring(end + 1);
      } else {
        chunks.push(temp[0]);
        temp = temp.substring(1);
      }
    } else {
      // Grab text until next tag or entity-safe boundary
      var nextTag = temp.indexOf('<');
      if (nextTag < 0) nextTag = temp.length;
      // Push whole text chunk (preserves entities like &nbsp;)
      chunks.push(temp.substring(0, nextTag));
      temp = temp.substring(nextTag);
    }
  }
  var idx = 0;
  var batchSize = 3;
  return new Promise(function(resolve) {
    function renderChunk() {
      if (idx < chunks.length) {
        var end = Math.min(idx + batchSize, chunks.length);
        for (var j = idx; j < end; j++) {
          body.innerHTML += chunks[j];
        }
        idx = end;
        setTimeout(renderChunk, 8);
      } else {
        btn.disabled = false;
        btn.textContent = '‚ö° Ask AI';
        renderAISuggestions();
        resolve();
      }
    }
    renderChunk();
  });
}

function analyzeQuery(query) {
  if (!_aiData || !_aiData.results) {
    return "No vulnerability data loaded yet. Click <strong>üåê Live Data</strong> or <strong>üì¶ Demo Data</strong> first, then ask me anything.";
  }

  const R = _aiData.results;
  const S = _aiData.stats || {};
  const q = query.toLowerCase();

  // Helper functions
  const crit = R.filter(v => (v.severity||'').toUpperCase() === 'CRITICAL');
  const high = R.filter(v => (v.severity||'').toUpperCase() === 'HIGH');
  const med = R.filter(v => (v.severity||'').toUpperCase() === 'MEDIUM');
  const low = R.filter(v => (v.severity||'').toUpperCase() === 'LOW' || (v.severity||'').toUpperCase() === 'INFO');
  const kev = R.filter(v => v.in_kev);
  const noise = R.filter(v => v.is_noise);
  const tickets = R.filter(v => v.ticket_created);
  const flips = R.filter(v => v.cvss_vs_vprs_flip);
  const dw = R.filter(v => v.dark_web_mentions > 0);
  const inet = R.filter(v => v.is_internet_facing);
  const hr = R.filter(v => v.hard_rule);
  const actionable = R.filter(v => !v.is_noise);

  const avgVPRS = actionable.length ? (actionable.reduce((s,v) => s + v.vprs_score, 0) / actionable.length).toFixed(1) : 0;
  const avgCVSS = R.length ? (R.reduce((s,v) => s + v.cvss_score, 0) / R.length).toFixed(1) : 0;

  // Match against pre-cached categories
  if (q.includes('patch first') || q.includes('should i patch') || q.includes('priority') || q.includes('most urgent')) {
    const top5 = [...R].sort((a,b) => b.vprs_score - a.vprs_score).filter(v => !v.is_noise).slice(0, 5);
    let html = `<strong>üî• Top 5 Priority Patches - Ranked by Real Risk (VPRS)</strong><br><br>`;
    top5.forEach((v, i) => {
      const urgency = v.vprs_score >= 85 ? 'crit' : v.vprs_score >= 65 ? 'warn' : 'good';
      html += `<strong>${i+1}.</strong> <span class="metric">${v.cve_id}</span> - VPRS <span class="${urgency}">${v.vprs_score.toFixed(1)}</span>`;
      if (v.in_kev) html += ' <span class="crit">[KEV]</span>';
      if (v.hard_rule) html += ` <span class="warn">[${v.hard_rule}]</span>`;
      html += `<br>`;
    });
    html += `<br>These are ordered by VPRS (real risk), not CVSS (theoretical). ${flips.length} CVEs had their priority changed vs CVSS-only triage.`;
    return html;
  }

  if (q.includes('flip') || q.includes('cvss vs vprs') || q.includes('disagree')) {
    if (flips.length === 0) return "No CVSS vs VPRS flips detected in current dataset. This means CVSS and VPRS agree on severity for all loaded CVEs.";
    let html = `<strong>üîÑ ${flips.length} CVSS vs VPRS Flips Detected</strong><br><br>`;
    const upg = flips.filter(v => v.vprs_score > v.cvss_score * 10);
    const dwn = flips.filter(v => v.vprs_score < v.cvss_score * 10);
    html += `<span class="crit">‚¨ÜÔ∏è ${upg.length} upgraded</span> (CVSS said low, VPRS says high) - these would have been missed!<br>`;
    html += `<span class="good">‚¨áÔ∏è ${dwn.length} downgraded</span> (CVSS said high, VPRS says low) - noise eliminated!<br><br>`;
    flips.slice(0, 5).forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> CVSS ${v.cvss_score.toFixed(1)} ‚Üí VPRS ${v.vprs_score.toFixed(1)}<br>`;
    });
    html += `<br>This is the core value of VulnPilot AI: <strong>real-world context beats theoretical severity</strong>.`;
    return html;
  }

  if (q.includes('noise') || q.includes('eliminated') || q.includes('suppress')) {
    if (noise.length === 0) return "No CVEs were eliminated as noise in this dataset.";
    let html = `<strong>üîá ${noise.length} CVEs Eliminated as Noise</strong> (${S.noise_rate_display||S.noise_rate||0}% of total)<br><br>`;
    html += `These are CVEs that CVSS scored as important but VPRS determined are low-risk because:<br>`;
    html += `‚Ä¢ Not in CISA KEV (no active exploitation)<br>‚Ä¢ Low EPSS (low probability of exploit)<br>‚Ä¢ Internal/segmented assets<br>‚Ä¢ Strong compensating controls<br><br>`;
    noise.slice(0, 5).forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> CVSS ${v.cvss_score.toFixed(1)} ‚Üí VPRS <span class="good">${v.vprs_score.toFixed(1)}</span><br>`;
    });
    html += `<br><strong>Impact:</strong> Your team focuses on <span class="crit">${actionable.length}</span> real threats instead of ${R.length}. That's ${noise.length} fewer tickets, ${noise.length} fewer patch cycles wasted.`;
    return html;
  }

  if (q.includes('kev') || q.includes('known exploited') || q.includes('cisa')) {
    if (kev.length === 0) return "No CVEs in the current dataset match the CISA Known Exploited Vulnerabilities catalog. This is good news!";
    let html = `<strong><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> ${kev.length} CVEs in CISA KEV</strong> - Confirmed actively exploited in the wild<br><br>`;
    kev.forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> - VPRS <span class="crit">${v.vprs_score.toFixed(1)}</span>`;
      if (v.hard_rule) html += ` [Hard Rule: ${v.hard_rule}]`;
      html += `<br>`;
    });
    html += `<br>All KEV CVEs are auto-escalated to <span class="crit">CRITICAL</span> by Hard Rule Lock 1. Federal agencies have mandatory remediation deadlines.`;
    return html;
  }

  if (q.includes('dark web') || q.includes('underground') || q.includes('exploit for sale') || q.includes('threat intel')) {
    if (dw.length === 0) return "No dark web activity detected for CVEs in the current dataset. abuse.ch, OTX, and GreyNoise show no underground interest.";
    let html = `<strong>üïµÔ∏è ${dw.length} CVEs with Dark Web Activity</strong><br><br>`;
    const sorted = [...dw].sort((a,b) => b.dark_web_mentions - a.dark_web_mentions);
    sorted.slice(0, 8).forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> - <span class="warn">${v.dark_web_mentions} mentions</span> | VPRS ${v.vprs_score.toFixed(1)}<br>`;
    });
    html += `<br>Sources: abuse.ch ThreatFox, AlienVault OTX, GreyNoise, Shodan Exploits, VulDB. Dark web intel contributes 15% of the VPRS score.`;
    return html;
  }

  if (q.includes('asset tier') || q.includes('risk exposure') || q.includes('by asset')) {
    const t1 = actionable.filter(v => v.asset_tier === 'tier_1');
    const t2 = actionable.filter(v => v.asset_tier === 'tier_2');
    const t3 = actionable.filter(v => v.asset_tier === 'tier_3');
    let html = `<strong>üè¢ Risk Exposure by Asset Tier</strong><br><br>`;
    html += `<span class="crit">Tier 1 (Crown Jewels):</span> ${t1.length} CVEs - avg VPRS ${t1.length ? (t1.reduce((s,v)=>s+v.vprs_score,0)/t1.length).toFixed(1) : 'N/A'}<br>`;
    html += `<span class="warn">Tier 2 (Business Critical):</span> ${t2.length} CVEs - avg VPRS ${t2.length ? (t2.reduce((s,v)=>s+v.vprs_score,0)/t2.length).toFixed(1) : 'N/A'}<br>`;
    html += `<span class="good">Tier 3 (Standard):</span> ${t3.length} CVEs - avg VPRS ${t3.length ? (t3.reduce((s,v)=>s+v.vprs_score,0)/t3.length).toFixed(1) : 'N/A'}<br>`;
    html += `<br>Asset criticality contributes 20% of VPRS. A critical vuln on a Tier 3 dev box scores lower than a medium vuln on a Tier 1 payment server.`;
    return html;
  }

  if (q.includes('internet-facing') || q.includes('internet facing') || q.includes('external') || q.includes('exposed')) {
    if (inet.length === 0) return "No internet-facing CVEs in current dataset. All vulnerable assets are internal or segmented.";
    let html = `<strong>üåê ${inet.length} Internet-Facing CVEs</strong> - Directly reachable from the internet<br><br>`;
    const sorted = [...inet].sort((a,b) => b.vprs_score - a.vprs_score);
    sorted.slice(0, 6).forEach(v => {
      const u = v.vprs_score >= 85 ? 'crit' : v.vprs_score >= 65 ? 'warn' : 'good';
      html += `<span class="metric">${v.cve_id}</span> VPRS <span class="${u}">${v.vprs_score.toFixed(1)}</span>${v.in_kev ? ' <span class="crit">[KEV]</span>' : ''}<br>`;
    });
    html += `<br>Reachability contributes 12% to VPRS. Internet-facing assets score 100/100 on reachability; segmented assets score 15/100.`;
    return html;
  }

  if (q.includes('hard rule') || q.includes('lock 1') || q.includes('override')) {
    if (hr.length === 0) return "No hard rules triggered in current dataset. All VPRS scores were calculated purely from the 6-factor formula.";
    let html = `<strong>‚ö° ${hr.length} Hard Rules Triggered (Lock 1 Safety System)</strong><br><br>`;
    const rules = {};
    hr.forEach(v => { rules[v.hard_rule] = (rules[v.hard_rule] || 0) + 1; });
    Object.entries(rules).sort((a,b) => b[1] - a[1]).forEach(([rule, count]) => {
      html += `<span class="crit">${rule}</span>: ${count} CVE${count > 1 ? 's' : ''}<br>`;
    });
    html += `<br>Hard rules override the formula and force minimum scores. Example: Any CVE in CISA KEV is automatically CRITICAL regardless of other factors. This prevents the AI from ever downgrading a confirmed threat.`;
    return html;
  }

  if (q.includes('average') || q.includes('avg') || q.includes('mean score')) {
    let html = `<strong>üìä Score Distribution Analysis</strong><br><br>`;
    html += `Average VPRS: <span class="metric">${avgVPRS}</span> | Average CVSS: <span class="metric">${avgCVSS}</span><br>`;
    html += `Median VPRS: <span class="metric">${actionable.length ? actionable.sort((a,b) => a.vprs_score - b.vprs_score)[Math.floor(actionable.length/2)].vprs_score.toFixed(1) : 0}</span><br>`;
    html += `Score range: <span class="metric">${Math.min(...R.map(v=>v.vprs_score)).toFixed(1)}</span> to <span class="metric">${Math.max(...R.map(v=>v.vprs_score)).toFixed(1)}</span><br><br>`;
    html += `VPRS pulls high-risk CVEs higher and low-risk CVEs lower than CVSS. The spread tells you how much noise CVSS was hiding.`;
    return html;
  }

  if (q.includes('epss') && (q.includes('compar') || q.includes('vs') || q.includes('effectiv'))) {
    const highEPSS = R.filter(v => v.epss_score >= 0.3);
    const lowEPSS = R.filter(v => v.epss_score < 0.05 && v.vprs_score >= 65);
    let html = `<strong>üìà EPSS vs VPRS Comparison</strong><br><br>`;
    html += `EPSS is just ONE of 6 VPRS factors (25% weight).<br><br>`;
    html += `<span class="crit">High EPSS (‚â•30%):</span> ${highEPSS.length} CVEs - these have a real chance of exploitation<br>`;
    html += `<span class="warn">Low EPSS but High VPRS:</span> ${lowEPSS.length} CVEs - risk comes from KEV/dark web/asset criticality, not exploit probability<br><br>`;
    html += `VPRS is better than EPSS alone because it adds asset context, dark web intel, and compensating controls. A 90% EPSS on a segmented dev box is less urgent than a 5% EPSS on an internet-facing payment server in CISA KEV.`;
    return html;
  }

  if (q.includes('no control') || q.includes('without control') || q.includes('unprotected')) {
    const exposed = actionable.filter(v => v.vprs_score >= 65 && v.controls_component >= 6);
    let html = `<strong>üö® ${exposed.length} High-Risk CVEs with Weak/No Compensating Controls</strong><br><br>`;
    exposed.sort((a,b) => b.vprs_score - a.vprs_score).slice(0, 6).forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> VPRS <span class="crit">${v.vprs_score.toFixed(1)}</span> - no WAF/IPS protection<br>`;
    });
    html += `<br>Adding a WAF or IPS in front of these assets would immediately reduce their VPRS by 2-5 points. This is the fastest risk reduction available.`;
    return html;
  }

  if (q.includes('ticket') || q.includes('created') || q.includes('assigned')) {
    let html = `<strong>üé´ ${tickets.length} Tickets Auto-Created</strong><br><br>`;
    html += `VulnPilot AI creates tickets only for actionable CVEs (VPRS ‚â• threshold).<br><br>`;
    html += `<span class="crit">Critical (P1 - 24h SLA):</span> ${crit.filter(v=>v.ticket_created).length} tickets<br>`;
    html += `<span class="warn">High (P2 - 72h SLA):</span> ${high.filter(v=>v.ticket_created).length} tickets<br>`;
    html += `<span style="color:var(--medium)">Medium (P3 - 14d SLA):</span> ${med.filter(v=>v.ticket_created).length} tickets<br><br>`;
    html += `${noise.length} CVEs did NOT get tickets (noise eliminated). That's ${noise.length} patches your team doesn't need to schedule.`;
    return html;
  }

  if (q.includes('sla') || q.includes('deadline') || q.includes('due date') || q.includes('overdue')) {
    let html = `<strong>‚è∞ SLA Deadline Summary</strong><br><br>`;
    html += `<span class="crit">P1 - 24 hours:</span> ${crit.length} CVEs (VPRS ‚â•85)<br>`;
    html += `<span class="warn">P2 - 72 hours:</span> ${high.length} CVEs (VPRS 65-84)<br>`;
    html += `<span style="color:var(--medium)">P3 - 14 days:</span> ${med.length} CVEs (VPRS 40-64)<br>`;
    html += `<span class="good">P4 - 30 days:</span> ${low.length} CVEs (VPRS &lt;40)<br><br>`;
    html += `Total remediation work: <span class="metric">${actionable.length}</span> CVEs across all SLA tiers. ${noise.length} noise CVEs have no SLA (eliminated).`;
    return html;
  }

  if (q.includes('ransomware')) {
    const ransom = R.filter(v => v.ransomware_associated || (v.hard_rule && v.hard_rule.includes('ransomware')));
    if (ransom.length === 0) return "No ransomware-associated CVEs detected in current dataset. CISA KEV and threat intel sources show no ransomware campaign connections.";
    let html = `<strong>üíÄ ${ransom.length} Ransomware-Associated CVEs</strong><br><br>`;
    ransom.forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> - VPRS <span class="crit">${v.vprs_score.toFixed(1)}</span> [${v.hard_rule || 'ransomware_associated'}]<br>`;
    });
    html += `<br>These CVEs are confirmed used by ransomware groups (CISA KEV data). They are auto-escalated to Critical by Hard Rule Lock 1.`;
    return html;
  }

  if (q.includes('upgraded') || q.includes('low cvss') || q.includes('cvss low') || q.includes('hidden')) {
    const upgraded = R.filter(v => v.cvss_score <= 6.0 && v.vprs_score >= 65);
    if (upgraded.length === 0) return "No low-CVSS CVEs were upgraded by VPRS in this dataset.";
    let html = `<strong>‚¨ÜÔ∏è ${upgraded.length} Low-CVSS CVEs Upgraded by VPRS</strong> - Hidden risks that CVSS missed<br><br>`;
    upgraded.sort((a,b) => b.vprs_score - a.vprs_score).slice(0, 6).forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> CVSS <span class="good">${v.cvss_score.toFixed(1)}</span> ‚Üí VPRS <span class="crit">${v.vprs_score.toFixed(1)}</span>`;
      if (v.in_kev) html += ' [KEV]';
      if (v.dark_web_mentions > 0) html += ` [DW:${v.dark_web_mentions}]`;
      html += `<br>`;
    });
    html += `<br>These CVEs would have been ignored under CVSS-only triage. VPRS caught them because of real-world exploitation signals.`;
    return html;
  }

  if (q.includes('opportunity') || q.includes('risk reduction') || q.includes('biggest impact') || q.includes('quick win')) {
    let html = `<strong>üéØ Top Risk Reduction Opportunities</strong><br><br>`;
    html += `<strong>1. Patch KEV CVEs first</strong> - ${kev.length} confirmed exploited. Highest certainty of attack.<br>`;
    html += `<strong>2. Address internet-facing criticals</strong> - ${inet.filter(v=>v.severity==='CRITICAL').length} external attack surface hotspots.<br>`;
    html += `<strong>3. Add WAF/IPS to unprotected Tier 1 assets</strong> - Immediate VPRS reduction of 2-5 points per CVE.<br>`;
    html += `<strong>4. Network segment Tier 1 from Tier 3</strong> - Reachability score drops from 100 to 15.<br>`;
    html += `<strong>5. Address dark web targets</strong> - ${dw.length} CVEs with underground interest.<br><br>`;
    html += `<strong>Expected impact:</strong> Addressing items 1-2 eliminates <span class="crit">${kev.length + inet.filter(v=>v.severity==='CRITICAL').length}</span> highest-risk CVEs.`;
    return html;
  }

  if (q.includes('severity level') || q.includes('how many') || q.includes('breakdown') || q.includes('distribution')) {
    let html = `<strong>üìâ Severity Distribution</strong><br><br>`;
    html += `<span class="crit">Critical:</span> ${S.critical || 0} (${R.length ? ((S.critical||0)/R.length*100).toFixed(0) : 0}%)<br>`;
    html += `<span class="warn">High:</span> ${S.high || 0} (${R.length ? ((S.high||0)/R.length*100).toFixed(0) : 0}%)<br>`;
    html += `<span style="color:var(--medium)">Medium:</span> ${S.medium || 0} (${R.length ? ((S.medium||0)/R.length*100).toFixed(0) : 0}%)<br>`;
    html += `<span class="good">Low:</span> ${S.low || 0} (${R.length ? ((S.low||0)/R.length*100).toFixed(0) : 0}%)<br>`;
    html += `<span style="color:var(--info)">Info/Noise:</span> ${(S.info||0) + noise.length}<br><br>`;
    html += `Total: <span class="metric">${R.length}</span> | Actionable: <span class="metric">${actionable.length}</span> | Noise: <span class="metric">${noise.length}</span>`;
    return html;
  }

  if (q.includes('epss above') || q.includes('high epss') || q.includes('epss over') || q.includes('epss 50')) {
    const highE = R.filter(v => v.epss_score >= 0.5).sort((a,b) => b.epss_score - a.epss_score);
    if (highE.length === 0) return "No CVEs with EPSS ‚â• 50% in current dataset. Exploitation probability is below the high-risk threshold for all loaded CVEs.";
    let html = `<strong>üî¥ ${highE.length} CVEs with EPSS ‚â• 50%</strong> - High exploitation probability<br><br>`;
    highE.slice(0, 8).forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> EPSS <span class="crit">${(v.epss_score*100).toFixed(1)}%</span> | VPRS ${v.vprs_score.toFixed(1)}<br>`;
    });
    html += `<br>EPSS ‚â• 50% means more than half of similar vulnerabilities get exploited within 30 days. These should be in your sprint.`;
    return html;
  }

  if (q.includes('ciso') || q.includes('executive') || q.includes('board') || q.includes('leadership')) {
    let html = `<strong>üëî Executive Security Briefing</strong><br><br>`;
    html += `<strong>Risk Posture:</strong> ${R.length} CVEs assessed, ${actionable.length} require action, ${noise.length} eliminated as noise (${S.noise_rate_display||S.noise_rate||0}% reduction).<br><br>`;
    html += `<strong>Critical Findings:</strong><br>`;
    html += `‚Ä¢ <span class="crit">${crit.length} critical</span> vulnerabilities with 24-hour SLA<br>`;
    html += `‚Ä¢ ${kev.length} confirmed exploited in the wild (CISA KEV)<br>`;
    html += `‚Ä¢ ${dw.length} with dark web activity<br>`;
    html += `‚Ä¢ ${flips.length} CVEs re-prioritized vs traditional CVSS scoring<br><br>`;
    html += `<strong>Business Impact:</strong> VPRS-driven triage reduces remediation workload by <span class="good">${S.noise_rate_display||S.noise_rate||0}%</span> while ensuring zero critical threats are missed (Lock 1 hard rules).`;
    return html;
  }

  if (q.includes('briefing') || q.includes('60 second') || q.includes('summary') || q.includes('overview') || q.includes('quick')) {
    let html = `<strong>‚ö° 60-Second Security Briefing</strong><br><br>`;
    html += `<span class="metric">${R.length}</span> CVEs scored ‚Üí <span class="crit">${crit.length}</span> critical, <span class="warn">${high.length}</span> high, <span class="good">${noise.length} noise eliminated</span><br><br>`;
    if (kev.length > 0) html += `<svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> <span class="crit">${kev.length} CISA KEV</span> - confirmed exploited, patch immediately<br>`;
    if (dw.length > 0) html += `üïµÔ∏è <span class="warn">${dw.length}</span> with dark web activity<br>`;
    if (inet.filter(v=>v.severity==='CRITICAL').length > 0) html += `üåê <span class="crit">${inet.filter(v=>v.severity==='CRITICAL').length}</span> critical + internet-facing<br>`;
    html += `üé´ ${tickets.length} tickets auto-created with SLA deadlines<br>`;
    html += `üîÑ ${flips.length} CVEs re-prioritized vs CVSS (${flips.filter(v=>v.vprs_score>v.cvss_score*10).length} upgraded, ${flips.filter(v=>v.vprs_score<v.cvss_score*10).length} downgraded)<br><br>`;
    html += `<strong>Bottom line:</strong> Focus on the <span class="crit">${crit.length + high.length}</span> critical + high CVEs. The rest is handled.`;
    return html;
  }

  // ‚ïê‚ïê‚ïê SPECIFIC CVE LOOKUP - "tell me about CVE-2024-3400" ‚ïê‚ïê‚ïê
  const cveMatch = q.match(/cve-\d{4}-\d{4,}/i);
  if (cveMatch) {
    const cveId = cveMatch[0].toUpperCase();
    const found = R.find(v => v.cve_id.toUpperCase() === cveId);
    if (!found) return `<span class="metric">${cveId}</span> is not in the current dataset. Load <strong>Live Data</strong> or try a different scan.`;
    const u = found.vprs_score >= 85 ? 'crit' : found.vprs_score >= 65 ? 'warn' : 'good';
    let html = `<strong>üîç ${cveId} - Deep Dive</strong><br><br>`;
    html += `VPRS Score: <span class="${u}" style="font-size:18px">${found.vprs_score.toFixed(1)}</span> | Severity: <span class="${u}">${(found.severity||'').toUpperCase()}</span> | CVSS: ${found.cvss_score.toFixed(1)}<br><br>`;
    html += `<strong>6-Factor Breakdown:</strong><br>`;
    const comps = found.components || {};
    const labels = {epss:'EPSS (25%)',kev:'CISA KEV (20%)',dark_web:'Dark Web (15%)',asset_criticality:'Asset (20%)',reachability:'Reach (12%)',controls:'Controls (8%)'};
    for (const [k,lbl] of Object.entries(labels)) {
      const val = typeof comps[k] === 'object' ? (comps[k].weighted || 0) : (comps[k] || 0);
      html += `  ${lbl}: <span class="metric">${typeof val === 'number' ? val.toFixed(2) : val}</span><br>`;
    }
    html += `<br>`;
    if (found.in_kev) html += `<svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> <span class="crit">In CISA KEV</span> - confirmed active exploitation<br>`;
    if (found.dark_web_mentions > 0) html += `üïµÔ∏è <span class="warn">${found.dark_web_mentions} dark web mentions</span><br>`;
    if (found.hard_rule) html += `‚ö° Hard Rule: <span class="crit">${found.hard_rule}</span><br>`;
    if (found.cvss_vs_vprs_flip) html += `üîÑ <span class="warn">CVSS‚ÜíVPRS flip detected</span><br>`;
    if (found.is_noise) html += `üîá <span class="good">Eliminated as noise</span><br>`;
    if (found.ticket_created) html += `üé´ Ticket created with SLA: ${found.sla_hours || '?'}h<br>`;
    if (found.is_internet_facing) html += `üåê Internet-facing asset<br>`;
    return html;
  }

  // ‚ïê‚ïê‚ïê PRODUCT/VENDOR SEARCH - "what CVEs affect Apache?" ‚ïê‚ïê‚ïê
  const productWords = ['apache','nginx','windows','linux','chrome','firefox','cisco','fortinet','palo alto',
    'ivanti','citrix','vmware','microsoft','oracle','openssh','openssl','java','spring','log4j','exchange',
    'wordpress','drupal','jenkins','docker','kubernetes','sap','adobe','atlassian','confluence','gitlab',
    'zoom','webex','pulse','sonicwall','zyxel','qnap','synology','f5','netscaler','juniper'];
  const matchedProduct = productWords.find(p => q.includes(p));
  if (matchedProduct) {
    const matches = R.filter(v => (v.cve_id + ' ' + (v.description||'') + ' ' + (v.product||'') + ' ' + (v.asset_type||'')).toLowerCase().includes(matchedProduct));
    if (matches.length === 0) return `No CVEs matching "<strong>${matchedProduct}</strong>" found in current dataset. Try loading Live Data for broader coverage.`;
    let html = `<strong>üîç ${matches.length} CVEs matching "${matchedProduct}"</strong><br><br>`;
    matches.sort((a,b) => b.vprs_score - a.vprs_score).slice(0, 8).forEach(v => {
      const u = v.vprs_score >= 85 ? 'crit' : v.vprs_score >= 65 ? 'warn' : 'good';
      html += `<span class="metric">${v.cve_id}</span> VPRS <span class="${u}">${v.vprs_score.toFixed(1)}</span>`;
      if (v.in_kev) html += ' <span class="crit">[KEV]</span>';
      html += `<br>`;
    });
    if (matches.length > 8) html += `<br>... and ${matches.length - 8} more. ${matches.filter(v=>v.severity==='CRITICAL').length} are critical.`;
    return html;
  }

  // ‚ïê‚ïê‚ïê SCORE THRESHOLD - "show CVEs above 80" / "what has VPRS over 90" ‚ïê‚ïê‚ïê
  const scoreMatch = q.match(/(?:above|over|greater|higher|>=?|score)\s*(\d{1,3})/);
  if (scoreMatch && !q.includes('epss')) {
    const threshold = parseInt(scoreMatch[1]);
    const above = R.filter(v => v.vprs_score >= threshold).sort((a,b) => b.vprs_score - a.vprs_score);
    let html = `<strong>üìä ${above.length} CVEs with VPRS ‚â• ${threshold}</strong><br><br>`;
    if (above.length === 0) { html += `No CVEs meet this threshold in the current dataset.`; return html; }
    above.slice(0, 10).forEach(v => {
      const u = v.vprs_score >= 85 ? 'crit' : v.vprs_score >= 65 ? 'warn' : 'good';
      html += `<span class="metric">${v.cve_id}</span> <span class="${u}">${v.vprs_score.toFixed(1)}</span>`;
      if (v.in_kev) html += ' [KEV]';
      if (v.hard_rule) html += ` [${v.hard_rule}]`;
      html += `<br>`;
    });
    if (above.length > 10) html += `<br>... and ${above.length - 10} more.`;
    return html;
  }

  // ‚ïê‚ïê‚ïê SCORE BELOW - "show low risk" / "what's below 30" ‚ïê‚ïê‚ïê
  const belowMatch = q.match(/(?:below|under|less|lower|<)\s*(\d{1,3})/);
  if (belowMatch) {
    const threshold = parseInt(belowMatch[1]);
    const below = R.filter(v => v.vprs_score < threshold).sort((a,b) => a.vprs_score - b.vprs_score);
    let html = `<strong>üìä ${below.length} CVEs with VPRS < ${threshold}</strong><br><br>`;
    below.slice(0, 8).forEach(v => {
      html += `<span class="metric">${v.cve_id}</span> <span class="good">${v.vprs_score.toFixed(1)}</span> - ${v.is_noise ? 'noise eliminated' : 'low priority'}<br>`;
    });
    html += `<br>These are safe to defer. VPRS confirms low real-world risk despite whatever CVSS says.`;
    return html;
  }

  // ‚ïê‚ïê‚ïê WORST / BEST / TOP / BOTTOM - "show worst 5" / "top 10 risks" ‚ïê‚ïê‚ïê
  const topMatch = q.match(/(?:top|worst|highest|most dangerous|riskiest|first)\s*(\d+)/);
  if (topMatch || q.includes('worst') || q.includes('most dangerous') || q.includes('riskiest') || q.includes('top risk')) {
    const n = topMatch ? parseInt(topMatch[1]) : 5;
    const topN = [...R].sort((a,b) => b.vprs_score - a.vprs_score).slice(0, Math.min(n, 20));
    let html = `<strong>üî• Top ${topN.length} Riskiest CVEs</strong><br><br>`;
    topN.forEach((v, i) => {
      const u = v.vprs_score >= 85 ? 'crit' : v.vprs_score >= 65 ? 'warn' : 'good';
      html += `<strong>${i+1}.</strong> <span class="metric">${v.cve_id}</span> VPRS <span class="${u}">${v.vprs_score.toFixed(1)}</span>`;
      if (v.in_kev) html += ' <span class="crit">[KEV]</span>';
      if (v.dark_web_mentions > 0) html += ` <span class="warn">[DW:${v.dark_web_mentions}]</span>`;
      html += `<br>`;
    });
    return html;
  }

  const bottomMatch = q.match(/(?:bottom|lowest|least|safest|last)\s*(\d+)/);
  if (bottomMatch || q.includes('safest') || q.includes('least risk') || q.includes('lowest risk')) {
    const n = bottomMatch ? parseInt(bottomMatch[1]) : 5;
    const botN = [...R].sort((a,b) => a.vprs_score - b.vprs_score).slice(0, Math.min(n, 20));
    let html = `<strong>‚úÖ ${botN.length} Lowest-Risk CVEs</strong><br><br>`;
    botN.forEach((v, i) => {
      html += `<strong>${i+1}.</strong> <span class="metric">${v.cve_id}</span> VPRS <span class="good">${v.vprs_score.toFixed(1)}</span> CVSS ${v.cvss_score.toFixed(1)} - ${v.is_noise ? 'noise' : 'low priority'}<br>`;
    });
    html += `<br>These can be safely deferred or accepted as residual risk.`;
    return html;
  }

  // ‚ïê‚ïê‚ïê HOW MANY / COUNT - "how many critical" / "count of KEV" ‚ïê‚ïê‚ïê
  if (q.includes('how many') || q.includes('count') || q.includes('total number')) {
    if (q.includes('critical')) return `<span class="crit">${crit.length}</span> critical CVEs out of ${R.length} total.`;
    if (q.includes('high')) return `<span class="warn">${high.length}</span> high-severity CVEs out of ${R.length} total.`;
    if (q.includes('medium')) return `${med.length} medium-severity CVEs out of ${R.length} total.`;
    if (q.includes('kev')) return `<span class="crit">${kev.length}</span> CVEs are in CISA KEV catalog.`;
    if (q.includes('noise')) return `<span class="good">${noise.length}</span> CVEs eliminated as noise (${S.noise_rate_display||S.noise_rate||0}%).`;
    if (q.includes('ticket')) return `<span class="metric">${tickets.length}</span> tickets auto-created.`;
    if (q.includes('flip')) return `<span class="warn">${flips.length}</span> CVSS vs VPRS priority flips.`;
    if (q.includes('dark') || q.includes('underground')) return `<span class="warn">${dw.length}</span> CVEs have dark web activity.`;
    if (q.includes('internet') || q.includes('external')) return `<span class="warn">${inet.length}</span> CVEs on internet-facing assets.`;
    return `Total: <span class="metric">${R.length}</span> CVEs | Actionable: ${actionable.length} | Noise: ${noise.length} | Critical: ${crit.length} | High: ${high.length} | KEV: ${kev.length}`;
  }

  // ‚ïê‚ïê‚ïê EXPLAIN / WHY / HOW - "why is CVE-X critical" / "how does VPRS work" ‚ïê‚ïê‚ïê
  if (q.includes('why') && cveMatch) {
    // already handled above by CVE lookup
  }
  if (q.includes('how does vprs work') || q.includes('how vprs') || q.includes('explain vprs') || q.includes('what is vprs')) {
    return `<strong>üìê How VPRS Works</strong><br><br>VPRS scores each CVE from 0-100 using 6 real-world factors:<br><br><strong>EPSS</strong> (25%) - Exploit probability from FIRST.org<br><strong>CISA KEV</strong> (20%) - Is it actively exploited?<br><strong>Dark Web</strong> (15%) - Underground mentions, exploit sales<br><strong>Asset Criticality</strong> (20%) - Crown jewel or dev box?<br><strong>Reachability</strong> (12%) - Internet-facing or segmented?<br><strong>Controls</strong> (8%) - WAF/IPS in place?<br><br>Then 3 safety locks: <strong>Lock 1</strong> = hard rules (KEV always critical), <strong>Lock 2</strong> = adversarial AI debate (two AIs argue each score), <strong>Lock 3</strong> = tiered drift detector (crown jewels rechecked every hour, standard assets every 6h - all configurable).`;
  }
  if (q.includes('how does scoring') || q.includes('how does it score') || q.includes('scoring work')) {
    return `<strong>üìê VPRS Scoring Formula</strong><br><br><span class="metric">VPRS = (EPSS√ó0.25) + (KEV√ó0.20) + (DarkWeb√ó0.15) + (Asset√ó0.20) + (Reach√ó0.12) + (Controls√ó0.08)</span><br><br>Each factor scores 0-100, then is weighted. The result is a 0-100 risk score where <span class="crit">‚â•85 = Critical</span>, <span class="warn">‚â•65 = High</span>, ‚â•40 = Medium, &lt;40 = Low. Hard rules (Lock 1) can override the formula - e.g., any CISA KEV CVE is forced to 100/Critical.`;
  }

  // ‚ïê‚ïê‚ïê COMPARE TWO CVEs - "compare CVE-X and CVE-Y" ‚ïê‚ïê‚ïê
  const compareMatch = q.match(/cve-\d{4}-\d{4,}/gi);
  if (compareMatch && compareMatch.length >= 2) {
    const a = R.find(v => v.cve_id.toUpperCase() === compareMatch[0].toUpperCase());
    const b = R.find(v => v.cve_id.toUpperCase() === compareMatch[1].toUpperCase());
    if (!a || !b) return `One or both CVEs not found in current dataset.`;
    let html = `<strong>‚öñÔ∏è Comparison: ${a.cve_id} vs ${b.cve_id}</strong><br><br>`;
    html += `<span class="metric">${a.cve_id}</span>: VPRS <strong>${a.vprs_score.toFixed(1)}</strong> | CVSS ${a.cvss_score.toFixed(1)} | ${(a.severity||'').toUpperCase()}<br>`;
    html += `<span class="metric">${b.cve_id}</span>: VPRS <strong>${b.vprs_score.toFixed(1)}</strong> | CVSS ${b.cvss_score.toFixed(1)} | ${(b.severity||'').toUpperCase()}<br><br>`;
    const winner = a.vprs_score > b.vprs_score ? a : b;
    const loser = a.vprs_score > b.vprs_score ? b : a;
    html += `<span class="crit">${winner.cve_id}</span> is higher risk by <span class="metric">${Math.abs(a.vprs_score - b.vprs_score).toFixed(1)}</span> VPRS points.`;
    if (winner.in_kev && !loser.in_kev) html += ` It's in CISA KEV (active exploitation).`;
    if (winner.dark_web_mentions > loser.dark_web_mentions) html += ` More dark web activity (${winner.dark_web_mentions} vs ${loser.dark_web_mentions} mentions).`;
    return html;
  }

  // ‚ïê‚ïê‚ïê WHAT CHANGED / DIFF / NEW - "what's new" / "any changes" ‚ïê‚ïê‚ïê
  if (q.includes('change') || q.includes('new') || q.includes('recent') || q.includes('latest') || q.includes('today')) {
    const sorted = [...R].sort((a,b) => (b.published_date||'').localeCompare(a.published_date||'')).slice(0, 5);
    let html = `<strong>üÜï Most Recent CVEs in Dataset</strong><br><br>`;
    sorted.forEach(v => {
      const u = v.vprs_score >= 85 ? 'crit' : v.vprs_score >= 65 ? 'warn' : 'good';
      html += `<span class="metric">${v.cve_id}</span> VPRS <span class="${u}">${v.vprs_score.toFixed(1)}</span>`;
      if (v.published_date) html += ` (${v.published_date})`;
      html += `<br>`;
    });
    html += `<br>Load <strong>üåê Live Data</strong> for the latest CVEs from NVD (published in the last 7 days).`;
    return html;
  }

  // ‚ïê‚ïê‚ïê COMPLIANCE - "PCI" / "SOC2" / "HIPAA" / "NIST" ‚ïê‚ïê‚ïê
  if (q.includes('pci') || q.includes('soc') || q.includes('hipaa') || q.includes('nist') || q.includes('iso') || q.includes('compliance') || q.includes('audit')) {
    const framework = q.includes('pci') ? 'PCI DSS' : q.includes('hipaa') ? 'HIPAA' : q.includes('soc') ? 'SOC 2' : q.includes('nist') ? 'NIST 800-53' : q.includes('iso') ? 'ISO 27001' : 'Compliance';
    let html = `<strong>üìã ${framework} Vulnerability Status</strong><br><br>`;
    html += `<span class="crit">${crit.length} Critical</span> - Must remediate within 24h (P1 SLA)<br>`;
    html += `<span class="warn">${high.length} High</span> - Must remediate within 72h (P2 SLA)<br>`;
    html += `${med.length} Medium - 14-day window<br><br>`;
    html += `<strong>Audit-ready metrics:</strong><br>`;
    html += `‚Ä¢ ${R.length} CVEs assessed with 6-factor risk scoring<br>`;
    html += `‚Ä¢ ${kev.length} CISA BOD 22-01 mandatory remediations tracked<br>`;
    html += `‚Ä¢ ${noise.length} false positives eliminated with evidence<br>`;
    html += `‚Ä¢ ${tickets.length} tickets with SLA deadlines auto-assigned<br>`;
    html += `‚Ä¢ Full component breakdown available per CVE for auditor review<br><br>`;
    html += `VulnPilot generates ${framework} compliance reports at <span class="metric">/api/v1/compliance/${framework.toLowerCase().replace(/\s+/g,'')}</span>`;
    return html;
  }

  // ‚ïê‚ïê‚ïê EXPORT / REPORT - "export" / "generate report" / "download" ‚ïê‚ïê‚ïê
  if (q.includes('export') || q.includes('report') || q.includes('download') || q.includes('csv') || q.includes('pdf') || q.includes('excel') || q.includes('xlsx') || q.includes('word') || q.includes('docx')) {
    // Detect requested format
    let fmt = 'json';
    if (q.includes('csv')) fmt = 'csv';
    else if (q.includes('excel') || q.includes('xlsx')) fmt = 'xlsx';
    else if (q.includes('pdf')) fmt = 'pdf';
    else if (q.includes('word') || q.includes('docx')) fmt = 'markdown';

    // Detect style
    let style = 'executive';
    if (q.includes('technical') || q.includes('detail')) style = 'technical';
    else if (q.includes('board') || q.includes('leadership')) style = 'board';
    else if (q.includes('compliance') || q.includes('audit')) style = 'compliance';

    // Detect report type
    let rtype = 'weekly';
    if (q.includes('monthly')) rtype = 'monthly';
    else if (q.includes('threat') || q.includes('posture')) rtype = 'threat_posture';
    else if (q.includes('compliance') || q.includes('audit')) rtype = 'compliance';

    let html = `<strong>üìÑ Report Generator</strong><br><br>`;
    html += `I can generate your report right now. Click a link to download:<br><br>`;
    html += `<strong>üìä ${rtype.replace('_',' ').toUpperCase()} REPORT (${style} style):</strong><br>`;
    html += `<a href="${API}/reports/generate" onclick="downloadReport('${rtype}','${style}','csv');return false" style="color:var(--accent-cyan);cursor:pointer">üìã Download CSV</a> - Raw data for spreadsheets<br>`;
    html += `<a href="${API}/reports/generate" onclick="downloadReport('${rtype}','${style}','xlsx');return false" style="color:var(--accent-cyan);cursor:pointer">üìä Download Excel (.xlsx)</a> - Formatted with charts<br>`;
    html += `<a href="${API}/reports/generate" onclick="downloadReport('${rtype}','${style}','pdf');return false" style="color:var(--accent-cyan);cursor:pointer">üìë Download PDF</a> - Professional branded report<br>`;
    html += `<a href="${API}/reports/generate" onclick="downloadReport('${rtype}','${style}','markdown');return false" style="color:var(--accent-cyan);cursor:pointer">üìù View Markdown</a> - For Slack/Teams/Email<br><br>`;
    html += `<strong>All available combinations:</strong><br>`;
    html += `Types: <em>weekly, monthly, threat posture, compliance</em><br>`;
    html += `Styles: <em>executive, technical, compliance, board</em><br>`;
    html += `Formats: <em>CSV, Excel, PDF, Markdown, JSON</em><br><br>`;
    html += `Try: <em>"Download monthly board PDF"</em> or <em>"Export compliance audit as Excel"</em>`;
    return html;
  }

  // ‚ïê‚ïê‚ïê WHAT IF / HYPOTHETICAL - "what if I add a WAF" / "what if we segment" ‚ïê‚ïê‚ïê
  if (q.includes('what if') || q.includes('hypothetical') || q.includes('simulate')) {
    if (q.includes('waf')) {
      const wouldHelp = actionable.filter(v => !v.has_waf && v.vprs_score >= 65);
      return `<strong>üîÆ What-If: Adding WAF Protection</strong><br><br>Adding a WAF to unprotected assets would reduce the controls component for <span class="metric">${wouldHelp.length}</span> CVEs. Estimated VPRS reduction: <span class="good">2-4 points each</span>. This could downgrade ${wouldHelp.filter(v => v.vprs_score < 90 && v.vprs_score >= 85).length} CVEs from Critical to High.`;
    }
    if (q.includes('segment') || q.includes('network')) {
      const wouldHelp = actionable.filter(v => v.is_internet_facing && v.vprs_score >= 65);
      return `<strong>üîÆ What-If: Network Segmentation</strong><br><br>Segmenting ${wouldHelp.length} internet-facing assets would drop their reachability score from 100 to 15 (85-point factor reduction √ó 12% weight = <span class="good">~10 VPRS point drop</span>). Multiple CVEs could shift severity levels.`;
    }
    return `<strong>üîÆ What-If Scenarios</strong><br><br>Try asking:<br>‚Ä¢ "What if I add a WAF?"<br>‚Ä¢ "What if we segment the network?"<br><br>VulnPilot's YAML-configurable weights also let you model different risk appetites by adjusting factor weights in <span class="metric">config/vprs_weights.yaml</span>.`;
  }

  // ‚ïê‚ïê‚ïê WEIGHT TUNING - "what if I change weights" / "adjust weights" ‚ïê‚ïê‚ïê
  if (q.includes('weight') || q.includes('tune') || q.includes('adjust') || q.includes('customize')) {
    return `<strong>‚öôÔ∏è VPRS Weight Tuning</strong><br><br>Current weights (from <span class="metric">config/vprs_weights.yaml</span>):<br><br>EPSS: <span class="metric">25%</span> | KEV: <span class="metric">20%</span> | Dark Web: <span class="metric">15%</span><br>Asset: <span class="metric">20%</span> | Reachability: <span class="metric">12%</span> | Controls: <span class="metric">8%</span><br><br>Every CISO can tune these. A financial services firm might increase KEV to 30%. A healthcare org might increase Asset Criticality to 30%. Edit the YAML, restart, all scores recalculate instantly. Weights must sum to 100%.`;
  }

  // ‚ïê‚ïê‚ïê HELP / WHAT CAN YOU DO - "help" / "what can I ask" ‚ïê‚ïê‚ïê
  if (q.includes('help') || q.includes('what can') || q.includes('capabilities') || q.includes('what do you know')) {
    return `<strong>ü§ñ What I Can Answer</strong><br><br><strong>Priority & Triage:</strong> "What should I patch first?" ¬∑ "Top 10 risks" ¬∑ "Show CVEs above 80"<br><strong>Specific CVE:</strong> "Tell me about CVE-2024-3400" ¬∑ "Compare CVE-X and CVE-Y"<br><strong>Filtering:</strong> "What affects Apache?" ¬∑ "Internet-facing CVEs" ¬∑ "CISA KEV list"<br><strong>Analysis:</strong> "CVSS vs VPRS flips" ¬∑ "Noise eliminated" ¬∑ "Dark web activity"<br><strong>Environment:</strong> "How many endpoints?" ¬∑ "What OS do we run?" ¬∑ "Show servers vs workstations"<br><strong>Business:</strong> "Which BU has most risk?" ¬∑ "Who owns vulnerable assets?" ¬∑ "Executive briefing"<br><strong>What-If:</strong> "What if I add a WAF?" ¬∑ "What if we segment?"<br><strong>Reports:</strong> "Download weekly PDF" ¬∑ "Export compliance Excel" ¬∑ "Monthly board report"<br><br>Or just ask anything in natural language - complex questions route to your AI provider (Claude/GPT/Ollama).`;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ASSET & ENVIRONMENT QUERIES - endpoints, servers, OS, owners, tags, BU
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const A = _aiData.assets || [];
  const AS = _aiData.asset_stats || {};

  // ‚ïê‚ïê‚ïê ENDPOINT / ASSET COUNT - "how many endpoints" / "how many assets" / "total assets" ‚ïê‚ïê‚ïê
  if (q.match(/how many.*(endpoint|asset|device|machine|host|system|node)/i) || q.match(/total.*(endpoint|asset|device|host|system)/i) || q.match(/endpoint.*count|asset.*count/i)) {
    if (A.length === 0) return `<strong>üìä No asset inventory loaded.</strong><br>Asset data is included with Demo Data or populated from your CMDB integration. Load data first, then ask again.`;
    let html = `<strong>üíª Environment Summary: ${AS.total_assets || A.length} Total Assets</strong><br><br>`;
    html += `<strong>By Type:</strong><br>`;
    const typeEntries = Object.entries(AS.by_type || {}).sort((a,b) => b[1] - a[1]);
    typeEntries.forEach(([t, c]) => { html += `&nbsp;&nbsp;‚Ä¢ ${t.replace(/_/g,' ')}: <span class="metric">${c}</span><br>`; });
    html += `<br><strong>Key Stats:</strong><br>`;
    html += `&nbsp;&nbsp;‚Ä¢ Internet-facing: <span class="crit">${AS.internet_facing || 0}</span><br>`;
    html += `&nbsp;&nbsp;‚Ä¢ With EDR: <span class="good">${AS.with_edr || 0}</span> (${A.length ? Math.round((AS.with_edr||0)/A.length*100) : 0}%)<br>`;
    html += `&nbsp;&nbsp;‚Ä¢ With critical vulns: <span class="crit">${AS.with_critical || 0}</span>`;
    return html;
  }

  // ‚ïê‚ïê‚ïê SERVER COUNT - "how many servers" ‚ïê‚ïê‚ïê
  if (q.match(/how many.*(server)/i) || q.match(/server.*count|count.*server/i)) {
    const servers = A.filter(a => a.asset_type && !a.asset_type.includes('workstation') && a.asset_type !== 'edge_device');
    const workstations = A.filter(a => a.asset_type === 'workstation');
    let html = `<strong>üèóÔ∏è Server vs Endpoint Breakdown</strong><br><br>`;
    html += `Servers/Infrastructure: <span class="metric">${servers.length}</span><br>`;
    html += `Workstations/Endpoints: <span class="metric">${workstations.length}</span><br>`;
    html += `Total: <span class="metric">${A.length}</span><br><br>`;
    html += `<strong>Server types:</strong><br>`;
    const serverTypes = {};
    servers.forEach(s => { const t = s.asset_type || 'unknown'; serverTypes[t] = (serverTypes[t]||0)+1; });
    Object.entries(serverTypes).sort((a,b)=>b[1]-a[1]).forEach(([t,c]) => { html += `&nbsp;&nbsp;‚Ä¢ ${t.replace(/_/g,' ')}: <span class="metric">${c}</span><br>`; });
    return html;
  }

  // ‚ïê‚ïê‚ïê OS BREAKDOWN - "what operating systems" / "how many OS" / "what OS" / "windows vs linux" ‚ïê‚ïê‚ïê
  if (q.match(/operat.*system|what os|how many os|os.*breakdown|os.*distribut|windows.*linux|linux.*windows/i)) {
    if (!AS.by_os || Object.keys(AS.by_os).length === 0) return `<strong>No OS data available.</strong> Load demo or live data to see OS distribution.`;
    let html = `<strong>üñ•Ô∏è Operating System Distribution</strong><br><br>`;
    const total = A.length || 1;
    Object.entries(AS.by_os).sort((a,b) => b[1] - a[1]).forEach(([os, count]) => {
      const pct = Math.round(count/total*100);
      const bar = '‚ñà'.repeat(Math.max(1, Math.round(pct/5)));
      html += `<span class="metric">${os}</span>: ${count} (${pct}%) <span style="color:var(--accent-cyan)">${bar}</span><br>`;
    });
    html += `<br>Total: <span class="metric">${total}</span> assets across <span class="metric">${Object.keys(AS.by_os).length}</span> OS families`;
    return html;
  }

  // ‚ïê‚ïê‚ïê BUSINESS UNIT RISK - "which business unit" / "department risk" / "BU breakdown" ‚ïê‚ïê‚ïê
  if (q.match(/business.?unit|department|bu.*risk|team.*risk|which.*(bu|unit|department|team).*risk/i)) {
    let buRisk = {};
    A.forEach(a => {
      const bu = a.business_unit || 'Unknown';
      if (!buRisk[bu]) buRisk[bu] = {assets: 0, critVulns: 0, inetFacing: 0};
      buRisk[bu].assets++;
      buRisk[bu].critVulns += a.critical_vulns || 0;
      if (a.is_internet_facing) buRisk[bu].inetFacing++;
    });
    let html = `<strong>üè¢ Risk by Business Unit</strong><br><br>`;
    html += `<table style="width:100%;font-size:12px;border-collapse:collapse"><tr style="border-bottom:1px solid #e5e7eb"><th style="text-align:left;padding:4px">Unit</th><th>Assets</th><th>Critical</th><th>Internet</th><th>Risk</th></tr>`;
    Object.entries(buRisk).sort((a,b) => b[1].critVulns - a[1].critVulns).forEach(([bu, d]) => {
      const risk = d.critVulns > 3 ? 'üî¥ HIGH' : d.critVulns > 0 ? 'üü° MED' : 'üü¢ LOW';
      html += `<tr style="border-bottom:1px solid #f1f5f9"><td style="padding:4px">${bu}</td><td style="text-align:center">${d.assets}</td><td style="text-align:center"><span class="crit">${d.critVulns}</span></td><td style="text-align:center">${d.inetFacing}</td><td style="text-align:center">${risk}</td></tr>`;
    });
    html += `</table>`;
    return html;
  }

  // ‚ïê‚ïê‚ïê INTERNET-FACING ASSETS - "internet facing assets" / "external assets" / "exposed assets" ‚ïê‚ïê‚ïê
  if (q.match(/internet.?facing.*asset|external.*asset|exposed.*asset|public.*asset|perimeter.*asset|show.*internet.*asset/i)) {
    const inet = A.filter(a => a.is_internet_facing);
    let html = `<strong>üåê Internet-Facing Assets: ${inet.length} of ${A.length}</strong><br><br>`;
    if (inet.length === 0) { html += `No internet-facing assets found.`; return html; }
    inet.sort((a,b) => (b.critical_vulns||0) - (a.critical_vulns||0));
    inet.forEach(a => {
      const risk = a.critical_vulns > 0 ? 'üî¥' : 'üü°';
      html += `${risk} <span class="metric">${a.hostname}</span> (${a.ip_address}) - ${a.asset_type.replace(/_/g,' ')} - ${a.os} - ${a.vuln_count} vulns (${a.critical_vulns} crit)<br>`;
    });
    html += `<br>${inet.filter(a=>a.critical_vulns>0).length} have critical vulnerabilities - prioritize these for immediate patching.`;
    return html;
  }

  // ‚ïê‚ïê‚ïê PERIMETER DEVICES - "perimeter" / "firewall" / "vpn" ‚ïê‚ïê‚ïê
  if (q.match(/perimeter|firewall.*vuln|vpn.*vuln|edge.*device/i) && !q.includes('what if')) {
    const perim = A.filter(a => ['firewall','vpn_appliance','edge_device'].includes(a.asset_type));
    let html = `<strong>üîí Perimeter Device Status: ${perim.length} devices</strong><br><br>`;
    perim.forEach(a => {
      const vulns = R.filter(v => v.hostname === a.hostname);
      const critV = vulns.filter(v => v.severity === 'CRITICAL');
      const risk = critV.length > 0 ? 'üî¥' : vulns.length > 0 ? 'üü°' : 'üü¢';
      html += `${risk} <span class="metric">${a.hostname}</span> (${a.software || a.os}) - ${vulns.length} vulns, ${critV.length} critical<br>`;
    });
    return html;
  }

  // ‚ïê‚ïê‚ïê EDR / PROTECTION STATUS - "EDR" / "protection" / "unprotected" ‚ïê‚ïê‚ïê
  if (q.match(/edr|endpoint.*protect|unprotect|no.*protection|without.*edr/i)) {
    const noEdr = A.filter(a => !a.has_edr);
    const withEdr = A.filter(a => a.has_edr);
    let html = `<strong><svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg> EDR Coverage</strong><br><br>`;
    html += `Protected: <span class="good">${withEdr.length}</span> (${A.length ? Math.round(withEdr.length/A.length*100) : 0}%)<br>`;
    html += `Unprotected: <span class="crit">${noEdr.length}</span> (${A.length ? Math.round(noEdr.length/A.length*100) : 0}%)<br><br>`;
    const noEdrCrit = noEdr.filter(a => a.critical_vulns > 0);
    if (noEdrCrit.length > 0) {
      html += `<strong>‚ö†Ô∏è Unprotected with critical vulns (${noEdrCrit.length}):</strong><br>`;
      noEdrCrit.forEach(a => { html += `&nbsp;&nbsp;üî¥ <span class="metric">${a.hostname}</span> - ${a.critical_vulns} critical, ${a.asset_type.replace(/_/g,' ')}, ${a.business_unit}<br>`; });
    }
    return html;
  }

  // ‚ïê‚ïê‚ïê ENVIRONMENT BREAKDOWN - "production vs dev" / "environment" / "staging" ‚ïê‚ïê‚ïê
  if (q.match(/production.*dev|environment.*breakdown|staging|prod.*vs|how many.*prod/i)) {
    let html = `<strong>‚öôÔ∏è Environment Breakdown</strong><br><br>`;
    Object.entries(AS.by_env || {}).sort((a,b) => b[1] - a[1]).forEach(([env, count]) => {
      const pct = Math.round(count / (A.length||1) * 100);
      const envAssets = A.filter(a => a.environment === env);
      const critCount = envAssets.reduce((s, a) => s + (a.critical_vulns||0), 0);
      html += `<span class="metric">${env}</span>: ${count} assets (${pct}%) - ${critCount} critical vulns<br>`;
    });
    return html;
  }

  // ‚ïê‚ïê‚ïê ASSET OWNERS - "who owns" / "ownership" / "owner" ‚ïê‚ïê‚ïê
  if (q.match(/who.*own|owner|ownership|responsibl/i) && !q.match(/case|ticket|assign|analyst/i)) {
    let ownerRisk = {};
    A.forEach(a => {
      const own = a.owner || 'Unassigned';
      if (!ownerRisk[own]) ownerRisk[own] = {assets: 0, vulns: 0, critVulns: 0, email: a.owner_email||'', team: a.owner_team||''};
      ownerRisk[own].assets++;
      ownerRisk[own].vulns += a.vuln_count || 0;
      ownerRisk[own].critVulns += a.critical_vulns || 0;
    });
    let html = `<strong>üë§ Asset Ownership & Risk</strong><br><br>`;
    Object.entries(ownerRisk).sort((a,b) => b[1].critVulns - a[1].critVulns).forEach(([own, d]) => {
      const risk = d.critVulns > 3 ? 'üî¥' : d.critVulns > 0 ? 'üü°' : 'üü¢';
      html += `${risk} <span class="metric">${own}</span> (${d.email}) - ${d.team}<br>&nbsp;&nbsp;&nbsp;${d.assets} assets, ${d.vulns} vulns (<span class="crit">${d.critVulns} critical</span>)<br>`;
    });
    return html;
  }

  // ‚ïê‚ïê‚ïê PEOPLE DIRECTORY - "who is" / "show me team" / "contact" / "email for" / "find person" ‚ïê‚ïê‚ïê
  const P = _aiData.people || [];
  const V = _aiData.vendors || [];

  if (q.match(/people|team.?member|staff|directory|personnel|who.*work|employee/i) || (q.match(/who is/i) && !q.match(/owner|assign/i))) {
    if (P.length === 0) return `<strong>No people directory loaded.</strong> Load demo data to see the team roster.`;
    // Check for specific person search
    const nameSearch = q.match(/who is (\w+\s?\w*)|find (\w+)|about (\w+\s?\w*)|contact.*for (\w+)/i);
    if (nameSearch) {
      const searchName = (nameSearch[1]||nameSearch[2]||nameSearch[3]||nameSearch[4]).trim().toLowerCase();
      const matches = P.filter(p => p.name.toLowerCase().includes(searchName) || p.username.toLowerCase().includes(searchName) || p.role.toLowerCase().includes(searchName));
      if (matches.length > 0) {
        let html = `<strong>üë§ People Matching "${searchName}"</strong><br><br>`;
        matches.forEach(p => {
          const ownedAssets = A.filter(a => a.owner === p.name);
          const assignedCVEs = R.filter(v => v.assigned_analyst === p.name);
          html += `<span class="metric">${p.name}</span> (${p.username})<br>`;
          html += `&nbsp;&nbsp;üìß ${p.email}<br>`;
          html += `&nbsp;&nbsp;üè¢ ${p.role} - ${p.team} (${p.bu})<br>`;
          if (ownedAssets.length) html += `&nbsp;&nbsp;üíª Owns ${ownedAssets.length} assets<br>`;
          if (assignedCVEs.length) html += `&nbsp;&nbsp;üé´ Assigned ${assignedCVEs.length} open tickets<br>`;
          html += `<br>`;
        });
        return html;
      }
    }
    // Show full directory
    let html = `<strong>üë• Team Directory (${P.length} people)</strong><br><br>`;
    const teams = {};
    P.forEach(p => { if (!teams[p.team]) teams[p.team] = []; teams[p.team].push(p); });
    Object.entries(teams).forEach(([team, members]) => {
      html += `<strong>${team}:</strong><br>`;
      members.forEach(p => {
        html += `&nbsp;&nbsp;‚Ä¢ <span class="metric">${p.name}</span> (${p.username}) - ${p.role} - üìß ${p.email}<br>`;
      });
      html += `<br>`;
    });
    return html;
  }

  // ‚ïê‚ïê‚ïê EMAIL LOOKUP - "email for" / "what's sarah's email" / "contact info" ‚ïê‚ïê‚ïê
  if (q.match(/email.*for|email.*of|contact.*info|what.*email|username.*for/i)) {
    const nameMatch = q.match(/(?:email|contact|username).*(?:for|of)\s+(\w+\s?\w*)/i) || q.match(/(\w+)(?:'s|s)\s+email/i);
    if (nameMatch && P.length > 0) {
      const search = nameMatch[1].trim().toLowerCase();
      const found = P.filter(p => p.name.toLowerCase().includes(search) || p.username.includes(search));
      if (found.length > 0) {
        let html = `<strong>üìß Contact Info</strong><br><br>`;
        found.forEach(p => { html += `<span class="metric">${p.name}</span>: ${p.email} (username: ${p.username})<br>${p.role} - ${p.team}<br><br>`; });
        return html;
      }
      // Also search vendors
      const vendorFound = V.filter(v => v.vendor.toLowerCase().includes(search) || v.account_rep.toLowerCase().includes(search));
      if (vendorFound.length > 0) {
        let html = `<strong>üìß Vendor Contact</strong><br><br>`;
        vendorFound.forEach(v => { html += `<span class="metric">${v.vendor}</span>: ${v.support_email}<br>Account Rep: ${v.account_rep}<br>Contract: ${v.contract_id} (${v.support_tier})<br><br>`; });
        return html;
      }
      return `<strong>No contact found for "${nameMatch[1]}".</strong> Try searching by first name, last name, or username.`;
    }
  }

  // ‚ïê‚ïê‚ïê ANALYST / CASE ASSIGNMENT - "who is assigned" / "analyst for" / "case owner" ‚ïê‚ïê‚ïê
  if (q.match(/assign|analyst|case.*owner|who.*handl|who.*work.*on|ticket.*owner|who.*responsibl.*cve/i)) {
    const ticketed = R.filter(v => v.ticket_created && v.assigned_analyst);
    if (ticketed.length === 0) return `<strong>No ticket assignments found.</strong> Tickets are auto-assigned when CVEs score above threshold.`;

    // Check for specific CVE assignment
    const cveMatch = q.match(/CVE-\d{4}-\d+/i);
    if (cveMatch) {
      const cve = R.find(v => v.cve_id.toLowerCase() === cveMatch[0].toLowerCase());
      if (cve && cve.assigned_analyst) {
        const analyst = P.find(p => p.name === cve.assigned_analyst);
        let html = `<strong>üé´ ${cve.cve_id} Assignment</strong><br><br>`;
        html += `Assigned Analyst: <span class="metric">${cve.assigned_analyst}</span> (${cve.assigned_analyst_email})<br>`;
        html += `Asset Owner: <span class="metric">${cve.asset_owner||'N/A'}</span> (${cve.asset_owner_email||''})<br>`;
        html += `Team: ${cve.asset_owner_team||'N/A'}<br>`;
        html += `Host: ${cve.hostname} | Vendor: ${cve.vendor||'Unknown'}<br>`;
        if (analyst) html += `Analyst Role: ${analyst.role} - ${analyst.team}<br>`;
        return html;
      }
    }

    // Show analyst workload overview
    let analystLoad = {};
    ticketed.forEach(v => {
      const a = v.assigned_analyst;
      if (!analystLoad[a]) analystLoad[a] = {total: 0, critical: 0, high: 0, email: v.assigned_analyst_email||''};
      analystLoad[a].total++;
      if (v.severity === 'CRITICAL') analystLoad[a].critical++;
      if (v.severity === 'HIGH') analystLoad[a].high++;
    });
    let html = `<strong>üé´ Analyst Case Assignments (${ticketed.length} tickets)</strong><br><br>`;
    Object.entries(analystLoad).sort((a,b) => b[1].total - a[1].total).forEach(([name, d]) => {
      const load = d.total > 8 ? 'üî¥ Heavy' : d.total > 4 ? 'üü° Moderate' : 'üü¢ Light';
      html += `<span class="metric">${name}</span> (${d.email}) - ${d.total} tickets (${d.critical} crit, ${d.high} high) - ${load}<br>`;
    });
    return html;
  }

  // ‚ïê‚ïê‚ïê VENDOR LOOKUP - "vendor" / "palo alto support" / "cisco contact" / "support contract" ‚ïê‚ïê‚ïê
  if (q.match(/vendor|support.*contract|account.*rep|supplier|manufacturer/i) || q.match(/(palo alto|cisco|fortinet|ivanti|microsoft|vmware|connectwise|jetbrains|kong).*(?:contact|email|support|rep)/i)) {
    if (V.length === 0) return `<strong>No vendor data loaded.</strong> Load demo data to see vendor directory.`;
    // Search for specific vendor
    const vendorSearch = q.match(/(palo alto|cisco|fortinet|ivanti|microsoft|vmware|connectwise|jetbrains|jenkins|kong|canonical|openssh|php)/i);
    if (vendorSearch) {
      const search = vendorSearch[1].toLowerCase();
      const found = V.filter(v => v.vendor.toLowerCase().includes(search));
      if (found.length > 0) {
        let html = `<strong>üè≠ Vendor: ${found[0].vendor}</strong><br><br>`;
        found.forEach(v => {
          html += `Support Email: <span class="metric">${v.support_email || 'N/A'}</span><br>`;
          html += `Account Rep: <span class="metric">${v.account_rep || 'N/A'}</span><br>`;
          html += `Contract ID: ${v.contract_id || 'N/A'}<br>`;
          html += `Support Tier: ${v.support_tier || 'N/A'}<br><br>`;
          // Show affected assets
          const vendorAssets = A.filter(a => a.vendor === v.vendor);
          if (vendorAssets.length) {
            html += `<strong>Assets (${vendorAssets.length}):</strong><br>`;
            vendorAssets.forEach(a => { html += `&nbsp;&nbsp;‚Ä¢ ${a.hostname} (${a.software}) - ${a.vuln_count} vulns<br>`; });
          }
        });
        return html;
      }
    }
    // Show all vendors
    let html = `<strong>üè≠ Vendor Registry (${V.length} vendors)</strong><br><br>`;
    V.forEach(v => {
      const vAssets = A.filter(a => a.vendor === v.vendor);
      html += `<span class="metric">${v.vendor}</span>: ${v.support_email||'N/A'} | Rep: ${v.account_rep||'N/A'} | ${v.support_tier} | ${vAssets.length} assets<br>`;
    });
    return html;
  }

  // ‚ïê‚ïê‚ïê ASSET TAGS - "tagged" / "tags" / "crown jewel" ‚ïê‚ïê‚ïê
  if (q.match(/\btag|tagged|crown.?jewel|label/i)) {
    let tagCounts = {};
    A.forEach(a => (a.tags||[]).forEach(t => { tagCounts[t] = (tagCounts[t]||0)+1; }));
    let html = `<strong>üè∑Ô∏è Asset Tags</strong><br><br>`;
    Object.entries(tagCounts).sort((a,b) => b[1] - a[1]).forEach(([tag, count]) => {
      html += `<span class="metric">${tag}</span>: ${count} assets<br>`;
    });
    return html;
  }

  // ‚ïê‚ïê‚ïê PERCENTAGE WITH VULNERABILITIES - "what percentage" / "how many have vulns" ‚ïê‚ïê‚ïê
  if (q.match(/what.*percent.*vuln|how many.*have.*vuln|percent.*asset.*vuln|asset.*with.*vuln/i)) {
    const withVulns = A.filter(a => (a.vuln_count||0) > 0);
    const withCrit = A.filter(a => (a.critical_vulns||0) > 0);
    const pctVuln = A.length ? Math.round(withVulns.length/A.length*100) : 0;
    const pctCrit = A.length ? Math.round(withCrit.length/A.length*100) : 0;
    let html = `<strong>üìä Asset Vulnerability Coverage</strong><br><br>`;
    html += `Assets with ANY vulnerability: <span class="metric">${withVulns.length}/${A.length}</span> (<span class="warn">${pctVuln}%</span>)<br>`;
    html += `Assets with CRITICAL vulnerabilities: <span class="crit">${withCrit.length}/${A.length}</span> (<span class="crit">${pctCrit}%</span>)<br>`;
    html += `Assets clean (no vulns): <span class="good">${A.length - withVulns.length}</span><br><br>`;
    html += `<strong>Most vulnerable assets:</strong><br>`;
    A.filter(a=>a.vuln_count>0).sort((a,b)=>(b.vuln_count||0)-(a.vuln_count||0)).slice(0,5).forEach(a => {
      html += `&nbsp;&nbsp;üî¥ <span class="metric">${a.hostname}</span>: ${a.vuln_count} vulns (${a.critical_vulns} critical)<br>`;
    });
    return html;
  }

  // ‚ïê‚ïê‚ïê SPECIFIC HOSTNAME LOOKUP - "tell me about web-prod-01" / "what about fw-edge-01" ‚ïê‚ïê‚ïê
  const hostMatch = q.match(/(?:about|status|info|show|what(?:'s| is))\s+([a-z][a-z0-9\-]+(?:-\d+)?)/i);
  if (hostMatch && A.length > 0) {
    const searchHost = hostMatch[1].toLowerCase();
    const asset = A.find(a => a.hostname.toLowerCase() === searchHost || a.hostname.toLowerCase().includes(searchHost));
    if (asset) {
      const vulns = R.filter(v => v.hostname === asset.hostname);
      let html = `<strong>üñ•Ô∏è Asset: ${asset.hostname}</strong><br><br>`;
      html += `<strong>Details:</strong><br>`;
      html += `&nbsp;&nbsp;IP: <span class="metric">${asset.ip_address}</span> | OS: ${asset.os} | Type: ${asset.asset_type.replace(/_/g,' ')}<br>`;
      html += `&nbsp;&nbsp;Tier: <span class="metric">${asset.asset_tier}</span> | BU: ${asset.business_unit} | Env: ${asset.environment}<br>`;
      html += `&nbsp;&nbsp;Zone: ${asset.network_zone} | Software: ${asset.software || 'N/A'}<br>`;
      html += `&nbsp;&nbsp;Controls: ${asset.has_waf?'WAF ':''}${asset.has_ips?'IPS ':''}${asset.is_segmented?'Segmented ':''}${asset.has_edr?'EDR ':''}${(!asset.has_waf&&!asset.has_ips&&!asset.is_segmented&&!asset.has_edr)?'‚ö†Ô∏è None':''}<br>`;
      html += `&nbsp;&nbsp;Tags: ${(asset.tags||[]).join(', ') || 'none'}<br><br>`;
      html += `<strong>üë§ Ownership:</strong><br>`;
      html += `&nbsp;&nbsp;Owner: <span class="metric">${asset.owner||'N/A'}</span> (${asset.owner_email||''})<br>`;
      html += `&nbsp;&nbsp;Team: ${asset.owner_team||'N/A'} | Escalation: ${asset.escalation_contact||'N/A'} (${asset.escalation_email||''})<br><br>`;
      if (asset.vendor && asset.vendor !== 'Unknown') {
        html += `<strong>üè≠ Vendor:</strong><br>`;
        html += `&nbsp;&nbsp;${asset.vendor} | Support: ${asset.vendor_support_email||'N/A'} | Rep: ${asset.vendor_account_rep||'N/A'}<br>`;
        html += `&nbsp;&nbsp;Contract: ${asset.vendor_contract_id||'N/A'} (${asset.vendor_support_tier||'N/A'})<br><br>`;
      }
      html += `<strong>Vulnerabilities (${vulns.length}):</strong><br>`;
      if (vulns.length === 0) { html += `&nbsp;&nbsp;üü¢ No vulnerabilities found on this asset.`; }
      else {
        vulns.sort((a,b) => b.vprs_score - a.vprs_score).forEach(v => {
          const sColor = v.severity==='CRITICAL'?'crit':v.severity==='HIGH'?'warn':'';
          html += `&nbsp;&nbsp;<span class="${sColor}">${v.severity}</span> ${v.cve_id} - VPRS ${v.vprs_score} ${v.in_kev?'<svg width="16" height="16" viewBox="140 135 40 35" xmlns="http://www.w3.org/2000/svg" style="vertical-align:middle"><path d="M157,160c0-0.266-0.046-0.519-0.11-0.764l4.715-2.144C162.31,158.233,163.562,159,165,159c0.466,0,0.905-0.095,1.32-0.241l1.913,3.827c-0.744,0.546-1.233,1.42-1.233,2.414c0,1.657,1.343,3,3,3s3-1.343,3-3s-1.343-3-3-3c-0.305,0-0.593,0.059-0.869,0.143l-1.909-3.818c0.822-0.55,1.419-1.4,1.657-2.391l3.149,0.35c0.14,0.969,0.965,1.716,1.972,1.716c1.104,0,2-0.896,2-2s-0.896-2-2-2c-0.854,0-1.577,0.537-1.864,1.29l-3.142-0.349c-0.02-1.31-0.67-2.461-1.659-3.176l2.693-4.939c0.307,0.105,0.63,0.175,0.972,0.175c1.657,0,3-1.343,3-3s-1.343-3-3-3s-3,1.343-3,3c0,0.955,0.455,1.796,1.151,2.346l-2.693,4.938C166.005,151.105,165.516,151,165,151c-0.924,0-1.764,0.326-2.44,0.852l-3.842-3.842c0.175-0.297,0.282-0.64,0.282-1.01c0-1.104-0.896-2-2-2s-2,0.896-2,2s0.896,2,2,2c0.37,0,0.713-0.107,1.011-0.283l3.842,3.842C161.326,153.236,161,154.076,161,155c0,0.414,0.081,0.804,0.197,1.179l-4.712,2.142C155.946,157.524,155.034,157,154,157c-1.657,0-3,1.343-3,3s1.343,3,3,3S157,161.657,157,160z M170,163c1.103,0,2,0.897,2,2s-0.897,2-2,2s-2-0.897-2-2S168.897,163,170,163z M169,144c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S169,145.103,169,144z M174,155c0.552,0,1,0.449,1,1s-0.448,1-1,1s-1-0.449-1-1S173.448,155,174,155z M157,148c-0.552,0-1-0.449-1-1s0.448-1,1-1s1,0.449,1,1S157.552,148,157,148z M162,155c0-1.657,1.343-3,3-3s3,1.343,3,3s-1.343,3-3,3S162,156.657,162,155z M152,160c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2S152,161.103,152,160z" fill="#ea580c"/></svg>KEV ':''}${v.assigned_analyst?'‚Üí '+v.assigned_analyst:''}<br>`;
        });
      }
      return html;
    }
  }

  // ‚ïê‚ïê‚ïê SMART CATCH-ALL: Free-form analysis with suggestions ‚ïê‚ïê‚ïê
  let html = `<strong>ü§ñ VulnPilot AI Analysis</strong><br><br>`;
  html += `I analyzed your <span class="metric">${R.length}</span> loaded CVEs for "${query}":<br><br>`;
  html += `<span class="crit">${crit.length} critical</span> | <span class="warn">${high.length} high</span> | ${med.length} medium | ${low.length} low/info<br>`;
  html += `${kev.length} in CISA KEV | ${dw.length} dark web signals | ${noise.length} noise eliminated (${S.noise_rate_display||S.noise_rate||0}%)<br>`;
  html += `${flips.length} CVSS‚ÜíVPRS flips | Avg VPRS: ${avgVPRS} | Avg CVSS: ${avgCVSS}<br><br>`;
  html += `<strong>Try more specific questions like:</strong><br>`;
  html += `‚Ä¢ "Tell me about CVE-2024-3400" - specific CVE deep dive<br>`;
  html += `‚Ä¢ "What affects Apache?" - filter by product/vendor<br>`;
  html += `‚Ä¢ "Show CVEs above 80" - score threshold filter<br>`;
  html += `‚Ä¢ "Compare CVE-X and CVE-Y" - side-by-side comparison<br>`;
  html += `‚Ä¢ "What if I add a WAF?" - hypothetical scenario<br>`;
  html += `‚Ä¢ "PCI compliance status" - framework-specific report<br>`;
  html += `‚Ä¢ Type <em>"help"</em> to see everything I can do`;
  return html;
}
// ‚ïê‚ïê‚ïê CHART ANALYSIS MODAL ‚ïê‚ïê‚ïê
async function showAgentStatus() {
  var agents = [
    {id:1, name:'Correlator', role:'VPRS Scoring Engine', icon:'üéØ', desc:'Aggregates EPSS, KEV, dark web, asset criticality, reachability, and compensating controls into a single VPRS score. Eliminates CVSS noise.', metrics:'85% noise eliminated | < 50ms scoring'},
    {id:2, name:'Context Mapper', role:'Asset & Environment Intelligence', icon:'üó∫Ô∏è', desc:'Maps CVEs to business context: asset tier, network zone, compensating controls, and ownership. Determines reachability and exposure.', metrics:'47 assets mapped | 4 business units'},
    {id:3, name:'Justifier (3A)', role:'Lock 2 - Builds the Case', icon:'‚öîÔ∏è', desc:'First AI model that independently scores each CVE and builds a justification for its risk rating.', metrics:'47 debates completed | 94% confidence'},
    {id:4, name:'Challenger (3B)', role:'Lock 2 - Attacks the Reasoning', icon:'üîê', desc:'Second AI model that challenges Agent 3A. Looks for missed context, over/under-scoring, and hallucination. If disagreement > 15pts, flags for human review.', metrics:'3 challenges raised | 1 human review'},
    {id:5, name:'Drift Detector', role:'Lock 3 - Continuous Re-scoring', icon:'üîÑ', desc:'Monitors threat landscape changes (new KEV, EPSS shifts, dark web spikes) and re-scores deprioritized CVEs. T1=1h, T2=3h, T3=6h.', metrics:'12 rescans today | 2 rescores triggered'}
  ];

  // Try to fetch live status from API
  try {
    var r = await fetch(API + '/agents/status');
    if (r.ok) {
      var data = await r.json();
      if (data.agents && data.agents.length) {
        agents = data.agents.map(function(a){ return {id:a.id, name:a.name, role:a.role, icon:a.icon, desc:a.description, metrics:Object.values(a.metrics||{}).join(' | ')}; });
      }
    }
  } catch(e) {}

  var h = '';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
  h += '<div><span style="font-size:20px;font-weight:700;color:var(--cyan)">5</span><span style="color:var(--muted);font-size:13px"> / 5 agents active</span></div>';
  h += '<div style="display:flex;gap:4px">';
  for(var i=0;i<5;i++) h += '<div style="width:10px;height:10px;border-radius:50%;background:var(--low);animation:pulse 2s ease-in-out infinite;animation-delay:'+(i*0.3)+'s"></div>';
  h += '</div></div>';

  agents.forEach(function(a) {
    h += '<div style="padding:14px;margin-bottom:10px;background:#f1f5f9;border:1px solid var(--border);border-radius:10px;border-left:3px solid var(--low)">';
    h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
    h += '<div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">'+a.icon+'</span><div><div style="font-weight:700;font-size:14px;color:#0f172a">Agent '+a.id+': '+a.name+'</div><div style="font-size:11px;color:var(--cyan)">'+a.role+'</div></div></div>';
    h += '<span style="font-size:9px;padding:3px 8px;background:#f0fdf4;color:var(--low);border-radius:4px;font-weight:600">‚óè ACTIVE</span>';
    h += '</div>';
    h += '<div style="font-size:12px;color:#334155;margin-bottom:6px;line-height:1.5">'+a.desc+'</div>';
    h += '<div style="font-size:10px;color:var(--muted);font-family:\'JetBrains Mono\',monospace;background:var(--bg-panel);padding:4px 8px;border-radius:4px">'+a.metrics+'</div>';
    h += '</div>';
  });

  h += '<div style="margin-top:12px;padding:10px;background:#f0fdfa;border:1px solid #99f6e4;border-radius:8px;font-size:12px;color:#64748b">';
  h += '<strong style="color:var(--cyan)">Pipeline Flow:</strong> Scanner ‚Üí <strong>Agent 1</strong> (Correlator) ‚Üí <strong>Agent 2</strong> (Context) ‚Üí VPRS Score ‚Üí <strong>Lock 1</strong> (Hard Rules) ‚Üí <strong>Agent 3A/3B</strong> (Adversarial Debate) ‚Üí <strong>Agent 5</strong> (Drift Monitor) ‚Üí Ticket';
  h += '</div>';

  document.getElementById('modalCveId').textContent = 'ü§ñ VulnPilot AI - 5 Agent Status';
  document.getElementById('modalBody').innerHTML = h;
  document.getElementById('cveModal').classList.add('show');
}

function showChartAnalysis(type) {
  if(!_aiData||!_aiData.results) return;
  var R = _aiData.results, S = _aiData.stats||{};
  var title='', h='';

  if(type==='severity') {
    title = 'üìä Severity Distribution Analysis';
    var crit=R.filter(v=>v.severity==='CRITICAL').length, high=R.filter(v=>v.severity==='HIGH').length, med=R.filter(v=>v.severity==='MEDIUM').length, low=R.filter(v=>v.severity==='LOW').length, info=R.filter(v=>v.severity==='INFO'||v.is_noise).length;
    h += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:16px">';
    h += '<div style="text-align:center;padding:12px;background:#fef2f2;border-radius:8px;cursor:pointer;transition:all .2s;border:1px solid transparent" onmouseover="this.style.borderColor=\'rgba(239,68,68,0.5)\'" onmouseout="this.style.borderColor=\'transparent\'" onclick="closeCveModal();setTimeout(function(){switchTab(\'dashboard\',document.querySelectorAll(\'.ntab\')[0]);if(_aiData)renderFilteredTable(_aiData.results,\'critical\')},200)"><div style="font-size:22px;font-weight:700;color:var(--crit)">'+crit+'</div><div style="font-size:10px;color:#64748b">CRITICAL</div></div>';
    h += '<div style="text-align:center;padding:12px;background:#fff7ed;border-radius:8px;cursor:pointer;transition:all .2s;border:1px solid transparent" onmouseover="this.style.borderColor=\'rgba(249,115,22,0.5)\'" onmouseout="this.style.borderColor=\'transparent\'" onclick="closeCveModal();setTimeout(function(){switchTab(\'dashboard\',document.querySelectorAll(\'.ntab\')[0]);if(_aiData)renderFilteredTable(_aiData.results,\'high\')},200)"><div style="font-size:22px;font-weight:700;color:var(--orange)">'+high+'</div><div style="font-size:10px;color:#64748b">HIGH</div></div>';
    h += '<div style="text-align:center;padding:12px;background:rgba(245,158,11,0.12);border-radius:8px;cursor:pointer;transition:all .2s;border:1px solid transparent" onmouseover="this.style.borderColor=\'rgba(245,158,11,0.5)\'" onmouseout="this.style.borderColor=\'transparent\'" onclick="closeCveModal();setTimeout(function(){switchTab(\'dashboard\',document.querySelectorAll(\'.ntab\')[0]);if(_aiData)renderFilteredTable(_aiData.results,\'medium\')},200)"><div style="font-size:22px;font-weight:700;color:var(--amber)">'+med+'</div><div style="font-size:10px;color:#64748b">MEDIUM</div></div>';
    h += '<div style="text-align:center;padding:12px;background:#f0fdf4;border-radius:8px;cursor:pointer;transition:all .2s;border:1px solid transparent" onmouseover="this.style.borderColor=\'rgba(34,197,94,0.5)\'" onmouseout="this.style.borderColor=\'transparent\'" onclick="closeCveModal();setTimeout(function(){switchTab(\'dashboard\',document.querySelectorAll(\'.ntab\')[0]);if(_aiData)renderFilteredTable(_aiData.results,\'low\')},200)"><div style="font-size:22px;font-weight:700;color:var(--low)">'+low+'</div><div style="font-size:10px;color:#64748b">LOW</div></div>';
    h += '<div style="text-align:center;padding:12px;background:rgba(148,163,184,0.12);border-radius:8px;cursor:pointer;transition:all .2s;border:1px solid transparent" onmouseover="this.style.borderColor=\'rgba(148,163,184,0.5)\'" onmouseout="this.style.borderColor=\'transparent\'" onclick="closeCveModal();setTimeout(function(){switchTab(\'dashboard\',document.querySelectorAll(\'.ntab\')[0]);if(_aiData)renderFilteredTable(_aiData.results,\'noise\')},200)"><div style="font-size:22px;font-weight:700;color:#64748b">'+info+'</div><div style="font-size:10px;color:#64748b">NOISE</div></div></div>';
    h += '<div style="font-size:13px;color:#334155;line-height:1.7">';
    h += '<strong style="color:var(--crit)">'+crit+' Critical CVEs</strong> require immediate patching within 24-48 hours. ';
    h += 'These include <strong>'+R.filter(v=>v.severity==="CRITICAL"&&v.in_kev).length+' CISA KEV</strong> entries and <strong>'+R.filter(v=>v.severity==="CRITICAL"&&v.dark_web_mentions>0).length+'</strong> with dark web activity.<br><br>';
    h += '<strong style="color:var(--low)">'+info+' items classified as noise</strong> were eliminated by VPRS scoring - a <strong>'+(S.noise_rate_display||S.noise_rate||85)+'% reduction</strong> vs traditional CVSS-only triage.<br><br>';
    h += '<strong>Recommendation:</strong> Focus patching on the '+crit+' criticals first. The '+high+' high-severity items should be scheduled within 7 days.</div>';
  } else if(type==='scatter') {
    title = 'üìà CVSS vs VPRS Scatter Analysis';
    var flips = R.filter(v=>v.cve_id&&v.cve_id.includes('FLIP'));
    var elevated = R.filter(v=>v.vprs_score > v.cvss_score*10);
    h += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px">';
    h += '<div style="text-align:center;padding:12px;background:#fef2f2;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:all .2s" onmouseover="this.style.borderColor=\'rgba(239,68,68,0.5)\'" onmouseout="this.style.borderColor=\'transparent\'" onclick="closeCveModal();setTimeout(function(){switchTab(\'dashboard\',document.querySelectorAll(\'.ntab\')[0]);document.getElementById(\'aiQuery\').value=\'Show me low CVSS vulns that VPRS upgraded\';askAI()},200)"><div style="font-size:22px;font-weight:700;color:var(--crit)">'+elevated.length+'</div><div style="font-size:10px;color:#64748b">VPRS ELEVATED</div></div>';
    h += '<div style="text-align:center;padding:12px;background:rgba(245,158,11,0.12);border-radius:8px;cursor:pointer;border:1px solid transparent;transition:all .2s" onmouseover="this.style.borderColor=\'rgba(245,158,11,0.5)\'" onmouseout="this.style.borderColor=\'transparent\'" onclick="closeCveModal();setTimeout(function(){switchTab(\'dashboard\',document.querySelectorAll(\'.ntab\')[0]);document.getElementById(\'aiQuery\').value=\'Show me all CVSS vs VPRS flips\';askAI()},200)"><div style="font-size:22px;font-weight:700;color:var(--amber)">'+flips.length+'</div><div style="font-size:10px;color:#64748b">SCORE FLIPS</div></div>';
    h += '<div style="text-align:center;padding:12px;background:#f0fdf4;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:all .2s" onmouseover="this.style.borderColor=\'rgba(34,197,94,0.5)\'" onmouseout="this.style.borderColor=\'transparent\'" onclick="closeCveModal();setTimeout(function(){switchTab(\'dashboard\',document.querySelectorAll(\'.ntab\')[0]);if(_aiData)renderFilteredTable(_aiData.results,\'noise\')},200)"><div style="font-size:22px;font-weight:700;color:var(--low)">'+(S.noise_eliminated||26)+'</div><div style="font-size:10px;color:#64748b">NOISE ELIMINATED</div></div></div>';
    h += '<div style="font-size:13px;color:#334155;line-height:1.7">';
    h += '<strong>What this chart shows:</strong> Each dot is a CVE plotted by CVSS (x-axis) vs VPRS (y-axis).<br><br>';
    h += '<strong style="color:var(--crit)">Above the diagonal</strong> = VPRS scores HIGHER than CVSS alone would suggest. These are CVEs where threat intelligence (KEV, dark web, EPSS) elevated the risk.<br><br>';
    h += '<strong style="color:var(--low)">Below the diagonal</strong> = VPRS reduced the score due to compensating controls or low reachability.<br><br>';
    h += '<strong style="color:var(--amber)">Yellow rings</strong> = CVSS/VPRS "flips" - where the two scoring methods fundamentally disagree. These highlight the value of contextual scoring over CVSS alone.</div>';
  } else if(type==='components') {
    title = 'üß© Top 10 VPRS Component Breakdown';
    var top10 = R.filter(v=>!v.is_noise).slice(0,10);
    h += '<div style="margin-bottom:16px">';
    top10.forEach(function(v,i){
      var c = v.components||{};
      var idx = R.indexOf(v);
      h += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #f1f5f9">';
      h += '<span style="font-family:JetBrains Mono,monospace;font-size:11px;color:var(--cyan);width:140px;cursor:pointer;text-decoration:underline;text-decoration-color:#99f6e4" onclick="closeCveModal();setTimeout(function(){showCveDetail('+idx+')},200)">'+v.cve_id+'</span>';
      h += '<span style="font-weight:700;color:'+severityColor(v.severity)+';width:45px;font-size:13px">'+v.vprs_score.toFixed(0)+'</span>';
      h += '<div style="flex:1;height:8px;background:#e2e8f0;border-radius:4px;display:flex;overflow:hidden">';
      h += '<div style="width:'+(c.epss||0)+'%;background:#3b82f6"></div>';
      h += '<div style="width:'+(c.kev||0)+'%;background:#ef4444"></div>';
      h += '<div style="width:'+(c.dark_web||0)+'%;background:#8b5cf6"></div>';
      h += '<div style="width:'+(c.asset||0)+'%;background:#06b6d4"></div>';
      h += '<div style="width:'+(c.reachability||0)+'%;background:#f97316"></div>';
      h += '<div style="width:'+(c.controls||0)+'%;background:#22c55e"></div>';
      h += '</div></div>';
    });
    h += '</div>';
    h += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">';
    h += '<span style="font-size:10px;color:#64748b">üîµ EPSS</span><span style="font-size:10px;color:#64748b">üî¥ KEV</span><span style="font-size:10px;color:#64748b">üü£ Dark Web</span><span style="font-size:10px;color:#64748b">üîµ Asset</span><span style="font-size:10px;color:#64748b">üü† Reach</span><span style="font-size:10px;color:#64748b">üü¢ Controls</span></div>';
    h += '<div style="font-size:13px;color:#334155;line-height:1.7"><strong>Insight:</strong> The top CVEs are dominated by <strong style="color:#ef4444">KEV</strong> and <strong style="color:#3b82f6">EPSS</strong> components, confirming that known-exploited vulnerabilities with high exploit probability are correctly prioritized by the VPRS engine.</div>';
  }

  h += '<div style="margin-top:14px"><span style="background:#fff7ed;color:var(--orange);font-size:12px;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600" onclick="closeCveModal()">Close</span></div>';
  document.getElementById('modalCveId').textContent = title;
  document.getElementById('modalBody').innerHTML = h;
  document.getElementById('cveModal').classList.add('show');
}

// ‚ïê‚ïê‚ïê VPRS LOCK & RESET ‚ïê‚ïê‚ïê
var _vprsLocked = false;
var _vprsDefaults = [25, 20, 15, 20, 12, 8];

function resetVprsDefaults() {
  if (_vprsLocked) return;
  var sliders = document.querySelectorAll('#vprsEditor input[type=range]');
  sliders.forEach(function(s, i) {
    s.value = _vprsDefaults[i];
    s.nextElementSibling.textContent = _vprsDefaults[i] + '%';
  });
  updateYaml();
}

function toggleVprsLock() {
  _vprsLocked = !_vprsLocked;
  var btn = document.getElementById('vprsLockBtn');
  var sliders = document.querySelectorAll('#vprsEditor input[type=range]');
  if (_vprsLocked) {
    btn.innerHTML = 'üîí LOCKED';
    btn.style.background = 'rgba(239,68,68,0.12)';
    btn.style.color = '#ef4444';
    btn.style.borderColor = 'rgba(239,68,68,0.3)';
    sliders.forEach(function(s) { s.disabled = true; s.style.opacity = '0.4'; });
  } else {
    btn.innerHTML = 'üîì UNLOCKED';
    btn.style.background = 'rgba(249,115,22,0.12)';
    btn.style.color = 'var(--orange)';
    btn.style.borderColor = 'rgba(249,115,22,0.3)';
    sliders.forEach(function(s) { s.disabled = false; s.style.opacity = '1'; });
  }
}

// ‚ïê‚ïê‚ïê YAML LIVE UPDATE ‚ïê‚ïê‚ïê
function updateYaml() {
  var sliders = document.querySelectorAll("#vprsEditor input[type=range]");
  var names = ["threat_intel","kev","dark_web","asset_criticality","reachability","compensating_controls"];
  var y = "weights:<br>";
  sliders.forEach(function(s,i){ y += "\&nbsp;\&nbsp;"+names[i]+": "+(parseInt(s.value)/100).toFixed(2)+"<br>"; });
  var el = document.getElementById("yamlContent"); if(el) el.innerHTML = y;
}

// ‚ïê‚ïê‚ïê SETUP DETAIL MODAL ‚ïê‚ïê‚ïê
function showSetup(name, desc, type, config) {
  var h = '<div style="max-width:600px;margin:0 auto">';
  h += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px"><div style="width:40px;height:40px;background:#fff7ed;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px">üîß</div><div><div style="font-size:18px;font-weight:700;color:#0f172a">'+name+'</div><div style="font-size:12px;color:#64748b">'+desc+'</div></div></div>';
  h += '<div style="background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:12px 16px;margin-bottom:14px;font-size:12px;color:var(--orange)">Type: <strong>'+type+'</strong></div>';
  h += '<div style="background:var(--bg);border-radius:8px;padding:16px;font-family:JetBrains Mono,monospace;font-size:11px;color:#334155;line-height:1.8;white-space:pre-wrap">'+config+'</div>';
  h += '<div style="margin-top:14px;display:flex;gap:8px"><a href="/setup" style="background:rgba(20,184,166,0.12);color:#5eead4;font-size:12px;padding:8px 16px;border-radius:6px;text-decoration:none;font-weight:600">Open Full Setup</a><span style="background:#fff7ed;color:var(--orange);font-size:12px;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600" onclick="closeCveModal()">Close</span></div></div>';
  document.getElementById('modalCveId').textContent = name + ' Setup';
  document.getElementById('modalBody').innerHTML = h;
  document.getElementById('cveModal').classList.add('show');
}

// ‚ïê‚ïê‚ïê REPORT GENERATION (CLIENT-SIDE) ‚ïê‚ïê‚ïê
function generateReport(type) {
  if(!_aiData||!_aiData.results) { alert('Load data first'); return; }
  var R = _aiData.results;
  var S = _aiData.stats||{};
  var now = new Date().toISOString().slice(0,10);
  var content = '';

  if(type==='executive') {
    content = '# VulnPilot Executive Summary - '+now+'\\n\\n';
    content += '## Risk Posture\\n- Total CVEs Scored: '+S.total+'\\n- Critical: '+S.critical+'\\n- Noise Eliminated: '+S.noise_eliminated+' ('+(S.noise_rate_display||S.noise_rate)+'%)\\n- Tickets Created: '+S.tickets_created+'\\n- KEV Matches: '+S.kev_matches+'\\n\\n';
    content += '## Top 5 Critical CVEs\\n';
    R.filter(v=>v.severity==='CRITICAL').slice(0,5).forEach(function(v){ content += '- **'+v.cve_id+'** VPRS:'+v.vprs_score.toFixed(1)+' Host:'+v.hostname+' '+v.title+'\\n'; });
    content += '\\n## Recommendations\\n1. Patch all CISA KEV items within 24 hours\\n2. Review internet-facing critical assets\\n3. Enable compensating controls for unpatched systems\\n';
  } else if(type==='technical') {
    content = JSON.stringify(_aiData, null, 2);
  } else if(type==='compliance') {
    content = '# Compliance Audit Report - '+now+'\\n\\n';
    content += '## NIST CSF Alignment\\n- Identify: '+S.total+' vulnerabilities cataloged\\n- Protect: '+S.noise_eliminated+' low-risk items filtered\\n- Detect: EPSS + KEV + Dark Web monitoring active\\n- Respond: '+S.tickets_created+' tickets auto-created\\n- Recover: Drift detector rescoring every 1-6h\\n\\n';
    content += '## PCI DSS\\n- Req 6.1: Vulnerability identification via VPRS scoring\\n- Req 6.2: '+S.critical+' critical vulnerabilities require patching within 30 days\\n- Req 11.2: Scan data from OpenVAS/Wazuh/Nessus\\n\\n';
    content += '## KEV Compliance\\n- '+S.kev_matches+' CISA KEV matches found\\n- All auto-escalated to CRITICAL via Lock 1\\n';
  } else if(type==='csv') {
    content = 'cve_id,cvss,vprs,severity,kev,dark_web,hostname,ip,hard_rule,ticket\\n';
    R.forEach(function(v){ content += v.cve_id+','+v.cvss_score+','+v.vprs_score.toFixed(1)+','+v.severity+','+(v.in_kev?'YES':'NO')+','+v.dark_web_mentions+','+v.hostname+','+v.ip_address+','+(v.hard_rule||'')+','+(v.ticket_created?'YES':'NO')+'\\n'; });
  } else if(type==='board') {
    content = '# Board Risk Briefing - '+now+'\\n\\n';
    content += '## Headline\\n'+S.critical+' critical vulnerabilities across '+S.total+' total findings.\\n'+S.noise_eliminated+' items eliminated as noise ('+(S.noise_rate_display||S.noise_rate)+'% reduction).\\n\\n';
    content += '## Action Required\\n- '+S.kev_matches+' CISA Known Exploited Vulnerabilities need immediate patching\\n- '+S.tickets_created+' remediation tickets auto-assigned with SLA\\n- All critical items are internet-facing assets\\n\\n';
    content += '## Risk Trend\\nVPRS scoring provides a more accurate risk picture than CVSS alone.\\n'+S.hard_rules_triggered+' hard rules triggered to prevent AI scoring errors.\\n';
  } else if(type==='excel') {
    content = 'CVE\\tCVSS\\tVPRS\\tSeverity\\tKEV\\tDark Web\\tHost\\tIP\\tHard Rule\\tTicket\\n';
    R.forEach(function(v){ content += v.cve_id+'\\t'+v.cvss_score+'\\t'+v.vprs_score.toFixed(1)+'\\t'+v.severity+'\\t'+(v.in_kev?'YES':'NO')+'\\t'+v.dark_web_mentions+'\\t'+v.hostname+'\\t'+v.ip_address+'\\t'+(v.hard_rule||'')+'\\t'+(v.ticket_created?'YES':'NO')+'\\n'; });
  }

  var ext = type==='technical'?'json':type==='csv'?'csv':type==='excel'?'tsv':'md';
  var mime = type==='technical'?'application/json':type==='csv'||type==='excel'?'text/csv':'text/markdown';
  var blob = new Blob([content], {type: mime});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'vulnpilot-'+type+'-'+now+'.'+ext;
  a.click();
}
</script>
</body>
</html>
